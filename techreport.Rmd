---
title: "Summary of the annual 2020 sablefish (*Anoplopoma fimbria*) trap survey, October 7 - November 21, 2020 "
year: 2021
report_number: nnn
author: |
  Lisa C. Lacko, 
  Schon M. Acheson and
  Brendan M. Connors
author_list: "Lacko, L.C. and Acheson, S.M. and Connors, B.M."
region: Pacific Region
isbn: ""
address: |
     Pacific Biological Station\
     Fisheries and Oceans Canada, 3190 Hammond Bay Road\
     Nanaimo, British Columbia, V9T 6N7, Canada\
phone: "(250) 756-7000"
author_footnote: "Email: Lisa.Lacko@dfo-mpo.gc.ca | telephone: (250) 756-7385"
abstract: |
  This document describes sampling activities and summarizes results from the 2020 British Columbia Sablefish research and assessment survey.  The survey was comprised of stratified random sets (StRS) at five depth-stratified areas.  A portion of the survey (traditional inlet sets) were removed to shorten the survey in response to the COVID-19 pandemic. Biological sampling for sablefish included collection of length, weight, sex, maturity and age structures. Sablefish were randomly sampled from every third trap on all sets, up to  a maximum sample size of 60 sablefish. The tag and release study conducted annually since 1991 was continued in 2020. Sablefish were selected randomly for tag and release from every third trap up to a maximum of 125 fish. 
  
  A total of 48,092 sablefish were caught in 2020, of which 3,691 were used for biological samples and 8,200 were tagged and released.  Catch per unit effort (CPUE) is an important product from this survey as it is used to infer population trends. In most recent years, survey data from stratified random sets showed increasing trends in CPUE in both mean weight and numbers of fish per trap. At the 2020 StRS sites, the stratified mean survey abundance was 35 kg/trap, down -17% from 2019 and -13% from the 2018-2019 average.

  
abstract_other: |
  Voici le résumé. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
output:
 csasdown::techreport_pdf:
   french: false
type:
  techreport
# ------------
# End of options to set
knit: bookdown::render_book
site: bookdown::bookdown_site
link-citations: true
bibliography: bib/refs.bib
csl: csl/csas.csl
lot: true
lof: true
# Any extra LaTeX code for the header:
# header-includes:
# - \usepackage{tikz}
header-includes: \usepackage{pdflscape}
                 
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
library(knitr)
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
}
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = knitr_figs_dir,
  cache.path = knitr_cache_dir,
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  #  autodep = TRUE,
  #  cache = TRUE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
options(xtable.comment = FALSE)
options(kableExtra.latex.load_packages = FALSE)
```

```{r load-libraries, cache=FALSE}
# add other packages here:  
library(csasdown)
message("year = ", rmarkdown::metadata$year)
#browser()

yr       <-  2020
basepath <- 'c:/github/surveyreport_2020/'
path     <- 'c:/github/surveyreport_2020/standaloneData/'

library(RODBC)
library(knitr)
library(magick)
library(excelR)
library(gapminder)
library(ggplot2)
library(dplyr)        # transform and summarize tabular data
library(xtable)       # produces tables
library(kableExtra)   # produces html tables with scrollbars, etc
library(pacman)       # produces numbered tables and figures in order to reference them
 #  if (!require("pacman")) install.packages("pacman")
 #  pacman::p_load(knitr, captioner, bundesligR, stringr)
#library(bookdown)
library(tableHTML)
library(Rmisc)
#library(cowplot)  # for multiple plots

#  ----   G L O B A L --- F U N C T I O N S ---------------------------------

  GetSQLData <- function(strSQL,strDbName) {    # connect to SQL Server
         cnn <- odbcDriverConnect(paste("Driver={SQL Server};Server=DFBCV9TWVASP001;", 
                                         "Database=",
                                          strDbName,";
                                          Trusted_Connection=Yes",
                                          sep=""))
            dat <- sqlQuery(cnn, strSQL)
            odbcClose(cnn)
            return(dat) 
                                            }
  
  panLab <- function( x, y, txt, ... ) { # Allows text to be placed at 0<x<1, 0<y<1)
            usr <- par( "usr" )
            par( usr=c(0,1,0,1) )
            text( x, y, txt, ... )
            par( usr=usr )
            #return( NULL )
            }
  
  cleanf <- function(x){                            # function to remove duplicates
            oldx <- c(FALSE, x[-1]==x[-length(x)])  # is the value equal to the previous
            res <- x
            res[oldx] <- NA
            return(res)
            } 
  
  simpleCap <- function(x) {  # add capital first letter to each word
            s <- strsplit(x, " ")[[1]]
            paste(toupper(substring(s, 1,1)), substring(s, 2),
            sep="", 
            collapse=" ")
            }
  
  firstup <- function(x) {   # add capital first letter to first word
            substr(x, 1, 1) <- toupper(substr(x, 1, 1))
            x
  }
  
  format_cells <- function(df, rows ,cols, value = c("italics", "bold", "strikethrough")){

            # select the correct markup
            map    <- setNames(c("*", "**", "~~"), c("italics", "bold", "strikethrough"))
            markup <- map[value]  
            
            for (r in rows){
                  for(c in cols){
                      df[[c]] <- as.character( df[[c]])  # -- make sure values are not factors
                      df[r, c] <- paste0(markup, df[r, c], markup)  # -- Update formatting
                                }
                           }
                     return(df)
            }
            
  fig_label <- function(text, region="figure", pos="topleft", cex=NULL, ...) {
           
            region <- match.arg(region, c("figure", "plot", "device"))
            pos <- match.arg(pos, c("topleft", "top", "topright", 
                                    "left", "center", "right", 
                                    "bottomleft", "bottom", "bottomright"))
           
            if(region %in% c("figure", "device")) {
              ds <- dev.size("in")
              # xy coordinates of device corners in user coordinates
              x <- grconvertX(c(0, ds[1]), from="in", to="user")
              y <- grconvertY(c(0, ds[2]), from="in", to="user")
           
              # fragment of the device we use to plot
              if(region == "figure") {
                # account for the fragment of the device that 
                # the figure is using
                fig <- par("fig")
                dx <- (x[2] - x[1])
                dy <- (y[2] - y[1])
                x <- x[1] + dx * fig[1:2]
                y <- y[1] + dy * fig[3:4]
              } 
            }
           
            # much simpler if in plotting region
            if(region == "plot") {
              u <- par("usr")
              x <- u[1:2]
              y <- u[3:4]
            }
           
            sw <- strwidth(text, cex=cex) * 60/100
            sh <- strheight(text, cex=cex) * 60/100
           
            x1 <- switch(pos,
              topleft     =x[1] + sw, 
              left        =x[1] + sw,
              bottomleft  =x[1] + sw,
              top         =(x[1] + x[2])/2,
              center      =(x[1] + x[2])/2,
              bottom      =(x[1] + x[2])/2,
              topright    =x[2] - sw,
              right       =x[2] - sw,
              bottomright =x[2] - sw)
           
            y1 <- switch(pos,
              topleft     =y[2] - sh,
              top         =y[2] - sh,
              topright    =y[2] - sh,
              left        =(y[1] + y[2])/2,
              center      =(y[1] + y[2])/2,
              right       =(y[1] + y[2])/2,
              bottomleft  =y[1] + sh,
              bottom      =y[1] + sh,
              bottomright =y[1] + sh)
           
            old.par <- par(xpd=NA)
            on.exit(par(old.par))
           
            text(x1, y1, text, cex=cex, ...)
            return(invisible(c(x,y)))
            }
  
    inline_hook <- function(x) {  # -- for inline text where numbers are larger 
      if (is.numeric(x)) {
            format(x, digits = 2)
                         } else x
      }
    knitr::knit_hooks$set(inline = inline_hook)
  
  

```


```{r SurveyDetails, echo=FALSE}  
   # -- INTRODUCTION DETAILS --

   report      <-  'exec Report_CreateTables'
   #rep.data    <-  GetSQLData(report,"Sablefish")
   details <- "select * from GFSH_"
   details     <- paste("select VESSEL_NAME as Vessel, CAPTAIN, ",
                        "left(CONVERT(varchar, START_DATE, 100), 7) + ' - ' ",
                        "+ left(CONVERT(varchar, END_DATE, 100), 7) AS [Trip Dates], ",
                        "COUNT([SET]) AS [Count of Sets], ",
                        "DATEDIFF(DAY, START_DATE, END_DATE) + 1 as days, ",
                        "DATEDIFF(DAY, '10/07/2020', '10/22/2020') + 1 as leg_one, ", 
                        "DATEDIFF(DAY, '10/23/2020', '11/21/2020')  as leg_two, ",
                        "START_DATE, END_DATE ",   #taken from survey notes
                        "from  dbo.GFBIO_RESEARCH_TRIPS ",
                        "where year IN( ", yr ,") ", 
                        "group by ",
                        "VESSEL_NAME, CAPTAIN,  ",
                        "left(CONVERT(varchar, START_DATE, 100),7) + ' - ' + ",
                        "left(CONVERT(varchar, END_DATE, 100),7), ",
                        "DATEDIFF(DAY, START_DATE, END_DATE), START_DATE, END_DATE",
                         sep="")
   #sd     <- GetSQLData(details,"Sablefish")  # -- survey details
   #write.table( sd, file = paste(path,"index01.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   sd     <- read.csv(paste(path,'index01.csv',sep=''), header=T)
   
   boat        <- simpleCap(tolower(sd[1,1]))      # -- vessel name 
   captain     <- "Albert (Deacon) Melnychuk"      # -- captain name -- override for 2020
   dates       <- sd[1,3]                          # -- survey start and end dates 
   setcnt      <- sd[1,4]                          # -- survey set count 
   days        <- sd[1,5]                          # -- days survey total to match paper docs
   legone      <- sd[1,6]    
   legtwo      <- sd[1,7]   

   avgC        <- paste("select round(AVG(TOTAL), 0) AS YrAvg ",
                        "from   dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",
                        "where  (year <= ", yr, ") and (year >= ",yr - 9,")", sep="")
   #avgTen      <- GetSQLData(avgC,"Sablefish")    # -- average catch last 10 years 
   #write.table(avgTen, file = paste(path,"index02.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   avgTen      <- read.csv(paste(path,'index02.csv', sep=''),header=T)
   
   tp          <- paste("select round(TRAP / TOTAL * 100, 0) AS TrapPer ",
                        "from dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2 ",  
                        "where  (year = ", yr, ")  group by round(TRAP / TOTAL * 100, 0), TOTAL", sep="")
   #trapP       <- GetSQLData(tp,"Sablefish")        # -- trap gear catch ratio
   #write.table(trapP, file = paste(path,"index03.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   trapP      <- read.csv(paste(path,'index03.csv', sep=''),header=T)
   
   lp          <- paste( "select  round(LONGLINE / TOTAL * 100, 0) AS LonglinePer from ",  
                         "dbo.TableA2_Annual_sablefish_Landing_in_Can_waters_2  ",
                         "where  (year = ", yr, ") group by round(LONGLINE / TOTAL * 100, 0), TOTAL", sep="")
   #LonglineP   <- GetSQLData(lp,"Sablefish")        # -- longline gear catch ratio
   #write.table(LonglineP, file = paste(path,"index04.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")    
   LonglineP   <- read.csv(paste(path,'index04.csv', sep=''), header=T)

   # -- F I G U R E   C A P T I O N S  function ------------------------------------------------
   figure_nums <-  captioner::captioner(prefix = "Figure")
   fg.ref      <-  function(x) {    # another method on how to number figures
                                     stringr::str_extract(figure_nums(x), "[^.]*")}

```


<!--chapter:end:index.Rmd-->

# Introduction

Sablefish (*Anoplopoma fimbria*) are a commercially valuable species that are harvested in British Columbia (BC) using trap, longline and trawl gear as part of the integrated management plan for the groundfish fishery. For the past ten years (`r yr-9` to `r yr`),  BC fishermen have landed an average of `r format(avgTen, big.mark=",")` metric tons of sablefish annually.  The majority of sablefish in `r yr`  were captured by longline trap gear (`r trapP`\%) and longline hook gear (`r LonglineP`\%). Commercial harvest of sablefish typically occurs at depths up to 985 fathoms, along the steep-walled slopes off the west coast of Haida Gwaii (formerly Queen Charlotte Islands), in the complex troughs  of Queen  Charlotte Sound, and in the steep canyons and ridges off the west coast of  Vancouver Island. 

Fishery-independent research and assessment surveys for sablefish have been conducted in BC coastal waters since 1988. Survey procedures have evolved over time, but each year they have consisted of fishing sets using trap gear at randomly selected and/or index sites. These surveys are used to obtain catch rate data, gather biological samples, capture oceanographic measurements and collect tag release and recapture data. This information is used as the key contemporary index of abundance for assessing the biological status of the sablefish stock, and to condition an operating model that serves as the biological basis of the coastal Management Strategy Evaluation [@DFO2020]. 

The design of the sablefish survey has remained consistent since 2011, and has been comprised of stratified random sampling (StRS) for sites along BC’s continental shelf and the continuation of sampling at standardized index sites at four mainland inlets. Due to the COVID-19 pandemic, the 2020 survey was shortened and the inlet sites were not surveyed. In addition, a single science crew were contracted from Archipelago Marine Research (AMR) for the duration of the trip. For details about past survey designs, see the historic overview provided by [@Wyeth2003] and [@Wyeth2004b]. For details on specific surveys conducted from 1988 through 1993 see [@Smith1996]; for surveys in 1994 and 1995 see [@Downes1997]; for surveys from 1996 to 2000 see [@Wyeth2003].  For the 2001 through 2006 surveys see [@Wyeth2003], [@Wyeth2004a], [@Wyeth2004b] and [@Wyeth2006], respectively.  Surveys in 2018 and 2019 are found in [@Lacko2020].

In this technical report we describe survey operations and summarize data collected on the `r yr` chartered survey aboard the F/V `r boat`. Tables and figures referred to in the main text are numbered sequentially. Tables and figures in the appendices are labelled with a letter code.
\clearpage

<!--chapter:end:01_introduction.Rmd-->

# Methods

## SURVEY DESIGN

Methodology for the `r yr` sablefish  research and assessment surveys employed a stratified random sampling (StRS) design.  The survey protocol required the StRS component to be completed from the southern end of Vancouver Island to the north coast of Haida Gwaii. The survey design was modified in 2020 in response to the COVID-19 pandemic.  The length of the trip was reduced by removing the traditional inlet component of the survey.

### STRATIFIED RANDOM SAMPLING SURVEY DESIGN COMPONENT

Since 2011, the StRS design has been conducted in all offshore survey areas. The StRS design began in 2003 with the purpose of distributing tag releases at random, collecting biological samples and developing a catch-rate based index of abundance [@Wyeth2003]. It also provided an alternative design to the historic traditional offshore component of the survey (1990 to 2010) which occured at fixed locations. 

Under the StRS design the offshore survey area is partitioned into five spatial strata (S~1~ to S~5~) and three depth strata (RD~1~ to RD~3~) for a total of 15 (Figure \@ref(fig:figure1)). The five spatial strata are S~1~ (South West Coast Vancouver Island or SWCVI), S~2~ (North West Coast Vancouver Island or NWCVI), S~3~ (Queen Charlotte Sound or QCS), S~4~ (South West Coast of Haida Gwaii or SWCHG), and S~5~ (North West Coast of Haida Gwaii or NWCHG).  The three targeted depth ranges are 100-250 fathoms (RD~1~), 250-450 fathoms (RD~2~), and 450-750 fathoms(RD~3~). The area within each of the 15 strata are sectioned into 2 km x  2 km grid cells or ‘fishing blocks’ from which set locations are randomly chosen. 

From 2003 through 2005, five grid cells were randomly selected in each spatial-depth stratum. From 2006 through 2010, the number was increased to six. An analysis was completed for the 2011 survey to optimize the allocation of the blocks to strata for the 2011 and 2012 survey. However, in order to lower survey costs, the number of blocks were further reduced for the 2013 survey, from a total of 110 to 91 offshore blocks while maintaining the same relative allocation of blocks to strata. This total number of blocks has been in place on all subsequent surveys (Table \@ref(tab:table1)), including `r yr` (Figure \@ref(fig:figure2)).

## VESSELS

The `r yr` survey of `r setcnt` sets was chartered aboard the 25.34 meter F/V `r boat` (Figure \@ref(fig:figure3)), skippered by `r captain`  between `r dates`, `r yr` . Information about the vessel can be found at [\underline{http://marinetraffic.com}](http://marinetraffic.com). 

## FISHING GEAR

The longline trap gear consisted of a groundline resting on the ocean floor with 25 baited traps attached to beckets at 150 foot intervals along its length and 90 pound anchors at each end (Figure \@ref(fig:figure4), b). A flagpole was required for at least one end of the set to improve visibility for retrieval. The traps  were steel frame with a bottom hoop diameter of 54 inches and covered with an North American #84 black braided nylon web of 2.75 inch mesh (Figure \@ref(fig:figure4), a). The tunnels were made of green braided, knotless, 1.25 inch mesh. The traps did not include escape rings; but instead a ‘rot panel’  of # 21 cotton located above the middle ring. 

Standard bait bags (6 by 12 inches) made of 1/8 inch web with a nylon drawstring and #7 stainless trolling snaps were included with the traps. 

## FISHING OPERATIONS

During normal survey fishing operations gear was deployed on alternate days. Prior to deployment, the Fishing Master inspected the block to determine fishability and if it was within the targeted depth range.  The goal was to have as much gear as possible within the block boundaries.  If unfishable, the survey protocol requires that an alternate block is to be chosen to the east, west, north, and south, respectively. If none of those blocks meet the criteria, an alternate block of the same area and depth strata was randomly chosen.  In 2020, the choice of alternate blocks were limited to a pre-selected list prepared by DFO in advance of the survey.  Additionally, the crew size was reduced to three and all data collected during fishing operations were recorded on paper forms, rather than electronically.

Two science staff recorded information associated with the deployment of the gear. One science member was positioned in the wheelhouse and recorded set details on the bridge log data form. The start and end geo-referenced positions of each set were entered at the time when the first and last traps were set over the stern. Depths were recorded at one-minute intervals between the first and last anchors being set. Later, the duration of the set was calculated as the time elapsed between the first anchor being set over the stern and the first anchor hauled aboard (Appendix \@ref(app:second-appendix), Figure B.1).

A set log was filled out on the deck by the science recorder who had maximum visibility of the crew setting the traps over the stern rail. The set log included the time and identity of the first and last buoys, anchor time, a tally of beckets and traps, as well as the unique identifying numbers of sensors deployed (Appendix \@ref(app:second-appendix), Figure B. 2)

### Stratified Random Component (StRS)

Sets in StRS blocks had a targeted soak time of 24 hours.  Fishing sets were designated useable if hauled between 22 and 26 hours. Traps were baited with 10 pounds of loose offshore Pacific Hake (*Merluccius productus*) and 2 pounds of bagged squid.

## CATCH PROCESSING

Haulback speed allowed the science crew to accurately record catch. One science and one crew member were positioned on deck at the haul card station; the science staff recorded the catch and the crew member managed the movement of baskets. As the groundline was hauled, each becket and trap were entered in the charter catch log form (Appendix \@ref(app:second-appendix), Figure B.3). Crew members alerted the recorder about any damage to a trap (i.e. holes) which was then recorded.

Catch by species from each trap was sorted into baskets by the crew. Baskets were then weighed to the nearest 0.2 kg on a motion compensating scale and given a basket use code of D, A, T, L, SD or F.  Code D designated fish species as discards or commercial catch; code A allocated sablefish for age samples; code T allocated sablefish to be tagged and released; code L allocated fish for length samples; code SD identified sublegal sablefish discards; code F represented fish frames with amphipod or hagfish damage (Appendix \@ref(app:second-appendix), Figure B.3).   The next day, the entries on charter catch log form were transposed to tabular format on the charter catch log entry form (Appendix \@ref(app:second-appendix), Figure B.4).

### Sablefish Allocation Details
 
Prior to 2018, sablefish were tagged from 1/3 of the traps on StRS sets and 1/2 of the traps on the inlet sets. Due to high catch numbers, the survey protocol was revised in 2018 to designate ~125 sablefish to be tagged (T) from 1/3 of the traps on all sets.  When catches were high, traps targeted for tagging were spread throughout the string to avoid tagging the first 125 fish.  A biological sample was collected from the coded "A" traps with the goal of selecting 50 to 60 fish.  If CPUE was high, the new survey protocol of 2018 designated a minimal of two traps to be used for samples.  If both traps contained more than 60 sablefish, a random process was used to select ~60 specimens.

The remaining traps were allocated to the discard category and sorted by size into either legal (D) or sublegal (SD) discards. The SD (sublegal discards) code was added during the 2017 survey to account for the large numbers of juvenile sablefish and facilitate their quick return to the ocean. Legal discards (D) of sablefish were kept by the vessel and processed as commercial catch. 

## BIOLOGICAL SAMPLING (LWSMO)

Biological samples were collected from sablefish and rougheye/blackspotted rockfish (*Sebastes aleutianus/Sebastes melanostictus*) specimens. Measurements were recorded for fork length (L), body weight (W), sex (S) and maturity level (M) (Appendix \@ref(app:second-appendix), Figure B.5). Sagittal otoliths (O) were collected and stored for potential ageing by the sclerochronology laboratory.  In addition, tissue for DNA was collected from the rougheye/blackspotted rockfish complex for later species determination.  Since this complex of two distinct species [@Orr2008] have similar appearances with slight variations in colour markings and dorsal fin lengths, the sampler visually identifed each specimen as either a rougheye, a blackspotted or a hybrid species.  All rockfish and legal-sized sablefish (fork length > 55 cm) that were sacrificed for biological samples were dressed, frozen, and landed as commercial catch.

## SABLEFISH TAGGING

Fish destined to be tagged were transferred from the sorting area to a tagging tank.  A vessel crew member was positioned to retrieve sablefish from the tank and provide assistance with fish handling.  A scientist stood at the sample station and tagged fish with a Mark II Long Tagging gun loaded with Floy FD-94 T-bar anchor tags.  The tag was inserted on the left side of the fish, 1 cm below and 2-3 cm behind the anterior insertion of the first dorsal fin.  Fork length (mm) measurements were taken. Before release, any sampling errors, injuries or damage to the fish were recorded on the tagging form by a second scientist. Tag checks were performed systematically to ensure tag numbers on the data form matched those on the fish specimen (Appendix \@ref(app:third-appendix), Figure B.6).

## SABLEFISH TAG RECOVERY

Any previously tagged fish brought aboard may have been treated in one of two ways.  First, sablefish with Canadian tags were re-released with a new tag and the previous tag was removed. In addition, any wounds from the old tag were recorded.  Second, sablefish with a foreign agency tag or sablefish that had sustained numerous injuries were retained for biological sampling.  For these specimens, the tag and otoliths were stored in a bar-coded vial that was later scanned into the GFBioField Tag Recovery Entry form by DFO staff [@Olsen2010]. Foreign tags were returned to their country of origin.

During survey years 1992 through 1997 and 2004, previously tagged sablefish were re-released with the same tag. New tagging protocols of replacing the tag began in 2005.



```{r SensorText, echo=FALSE}
   # -- determine the sets that deployed SBE and HOBO and CTD
   sense  <-  paste("select Year, SUM(SBE39) AS SBE39, SUM(HOBO) AS HOBO, ",
                    "SUM(CTD) AS CTD, SUM(CAM) AS CAM ",
                    "from dbo.Report_SBE_HOBO_IND ",
                    "group by Year having (Year =", yr,")", sep="")
   #sensor  <-  GetSQLData(sense,"Sablefish")
   #write.table(sensor, file = paste(path,"methods01.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
   sensor <-  read.csv(paste(path,'methods01.csv',sep=''), header=T)
   
```

## OCEANOGRAPHIC SENSOR DATA COLLECTION

A Sea-bird Bird SBE 39 temperature and pressure logger was placed in a protective plastic pipe and attached to the middle trap on the string of gear. Data was successfully collected from `r sensor[1,2]` sets in `r yr` (Appendix \@ref(app:third-appendix)).  A SBE 39 was also placed in the tagging tank on hauling days to record water temperature.   Data from the SBE temperature and pressure loggers were processed at sea after the set was complete. 

## ELECTRONIC MONITORING VIDEO DATA COLLECTION  

During haulback, the electronic monitoring (EM) system cameras were activated by the hydraulic sensor.  Three standard analog cameras were positioned at optimal viewing angles to record survey activities.  Two cameras were stationed along the mast to record the catch as it was processed at the hopper. A third camera was stationed on the side of the wheelhouse to record the traps as they were brought over the rail. The video data from each set was reviewed by science staff the following day to provide quality control on catch data.

\clearpage

<!--chapter:end:02_methods.Rmd-->

# Results and Discussion

## FISHING

```{r HistoricText, echo=FALSE}

# not able to query in detail the fishing days and block rejections/replacements, taken from notes

```
The `r yr` survey was `r days` days long and divided into two legs of `r legone` and `r legtwo` days, with a single day between in Port Hardy. Several weeks of inclement weather contributed to a longer second leg.  In total, 27 fishing days were recorded.

Of the 91 original blocks for the StRS portion of the survey, ten were replaced at-sea and four blocks were rejected, for a total of 87 blocks successfully fished (Table \@ref(tab:table1)). Of the ten replacements, one was revoked after on-ground inspection, three were located within unfishable habitat, four had failed to meet depth strata requirements, one was located in a conservation area and one was for an unknown reason (the track-line was in the neighboring block).

```{r CatchRateText, echo=FALSE}
  # -- generate the lowest uncertainity and corresponding year for catch rate paragraph

  dtStRS   <-   " select  * from dbo.GENERIC_GFBIO_TRAPS order by year"  # -- must update view GENERIC_GFBIO_TRAPS
  #datStRS  <-   GetSQLData(dtStRS,"Sablefish")                          # read from SQL Server
  #write.table(datStRS, file = paste(path,"results01.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
  datStRS  <-  read.csv(paste(path,'results01.csv',sep=''), header=T)  # read from csv
  odbcCloseAll()

  datRD    <-   datStRS[ datStRS$SABLE.SET.TYPE=="StRS", ] # --  pick out the random sets
  dat      <-   datRD[ ! is.na(datRD$SABLE.SET.TYPE), ]
  yrs      <-   unique(datRD$year)   # -- get unique years
  nyrs     <-   length(yrs)
  
  data.cv  <- data.frame( year   <- numeric(),
                          value1 <- numeric(),
                          value2 <- numeric(),
                          value3 <- numeric() )
  
  data.mn <- data.frame(  year   <- numeric(),
                          value1 <- numeric(),
                          value2 <- numeric(),
                          value3 <- numeric() )

  # -- iterate through the years building depth boxplots to get cv's and mean counts
  for (i in 1:nyrs)
     {    yrdat          <- datRD[datRD$year==yrs[i],]      # -- get the year dataset
          bxdat          <- split(yrdat$CPUE.SABLE.COUNT / yrdat$CPUE.TRAPS, as.character(yrdat$SABLE.DEPTH.GROUP))  # split by depth
          dpth.mean      <- sapply(bxdat, mean, na.rm=T)    # -- add the mean by depth  points
          std.dev        <- sapply(bxdat, sd, na.rm=T)
          names(data.cv) <- c("year", "RD1", "RD2", "RD3")  # -- store cv's
          names(data.mn) <- c("year", "RD1", "RD2", "RD3")  # -- store mean counts by depth
          data.cv        <- rbind(data.cv,c(yrs[i],round(std.dev/dpth.mean,2)))
          data.mn        <- rbind(data.mn,c(yrs[i],round(dpth.mean,0)))
      }
  
          RD1.cvlow      <- min(data.cv$RD1)
          RD1.cvlowyr    <- data.cv$year[data.cv$RD1==RD1.cvlow]
          RD2.cvlow      <- min(data.cv$RD2)
          RD2.cvlowyr    <- data.cv$year[data.cv$RD2==RD2.cvlow]
          RD3.cvlow      <- min(data.cv$RD3)
          RD3.cvlowyr    <- data.cv$year[data.cv$RD3==RD3.cvlow]
          
    # -- type data.mn in the Console to view the shallow, middle and deep depth stratums CPUE for 
    # -- descriptive paragraph below
  
```
## CATCH PER UNIT EFFORT (CPUE) 

The sablefish survey of `r yr` have documented recent changes in the sablefish population structure.

### Stratified Random Set CPUE

Catch per unit effort (CPUE), as indexed by kilograms of sablefish per trap, decreased in 2020 across the mid depth strata (RD~2~); and remained steady in the shallow (RD~1~) and deep (RD~3~)  depth strata (Figure \@ref(fig:figure5)). Comparison across spatial and depth strata indicate declining CPUE (kg/trap) in areas S~2~ to S~5~, but increasing in the most southern area S~1~ (Figure \@ref(fig:figure6)).  The CPUE (#fish/trap) across all strata declined remarkably with the exception of the northern strata S~5~ (Figure \@ref(fig:figure7)). The mean weight is similar or slightly decreasing compared to 2019 (Figure \@ref(fig:figure8)).  The stratified mean survey abundance in `r yr` was 35 kg/trap, down -17% from 2019 and -13% from the 2018-2019 average (Figure \@ref(fig:figure9)).


```{r SpeciesCompositionText, echo=FALSE}
  # -- taxonomic top 5 group count StRS
   topStRS      <- paste("select top (5) SPECIES_COMMON_NAME, SPECIES_SCIENCE_NAME, ",
                         "sum(CATCH_WEIGHT) AS catchkg ",
                         "from dbo.GFBIO_RESEARCH_CATCH ",
                         "group by SABLE_SET_TYPE, Year, SPECIES_CODE, ",
                         "SPECIES_COMMON_NAME, SPECIES_SCIENCE_NAME ",
                         "having (SABLE_SET_TYPE = N'StRS') and ",
                         "(SPECIES_CODE <> N'455') and (Year = ",yr,") ",
                         "order by catchkg DESC", sep="") 
   #topStRSsp    <- GetSQLData(topStRS,"Sablefish") 
   #write.table(topStRSsp, file = paste(path,"results02.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   topStRSsp  <-  read.csv(paste(path, 'results02.csv',sep=''), header=T) 
   
   topStRSsp1   <- as.character(topStRSsp[1,1])                     # -- StRS top 5 species names
   topStRSsc1   <- firstup(tolower(as.character(topStRSsp[1,2])))   # -- StRS top 5 species science names
   
   topStRSsp2   <- tolower(as.character(topStRSsp[2,1]))                       
   topStRSsc2   <- firstup(tolower(as.character(topStRSsp[2,2])))   
   
   topStRSsp3   <- tolower(as.character(topStRSsp[3,1]))                      
   topStRSsc3   <- firstup(tolower(as.character(topStRSsp[3,2])))
   
   topStRSsp4   <- tolower(as.character(topStRSsp[4,1]) )                    
   topStRSsc4   <- firstup(tolower(as.character(topStRSsp[4,2])))  
   
   topStRSsp5   <- tolower(as.character(topStRSsp[5,1]))                      
   topStRSsc5   <- firstup(tolower(as.character(topStRSsp[5,2]))) 

 
 # -- species composition counts for StRS sets 
   spc          <- paste("select dbo.fnIntegerToWords(sum(CAST(Roundfish as int))) as tRound,  ",
                                "dbo.fnIntegerToWords(sum(Rockfish))     as tRock,   ",
                                "dbo.fnIntegerToWords(sum(Flatfish))     as tFlat,   ",
                                "dbo.fnIntegerToWords(sum(Invertebrate)) as tInvert, ",
                                "dbo.fnIntegerToWords(sum(Mammal))       as tMammal, ",
                                "dbo.fnIntegerToWords(sum(Bird))         as tBird,   ",
                                "dbo.fnIntegerToWords(sum(counter))      as total    ",
                                "from (select case when Fish = Rockfish or Fish = Flatfish ", 
                                "then 0 ELSE Fish end AS Roundfish, ",
                                "Fish, Rockfish, Flatfish, Invertebrate, Mammal, Bird, ",
                                "SABLE_SET_TYPE, TRIP_ID, 1 AS counter, Year, ",
                                "SPECIES_CODE from dbo.GFBIO_RESEARCH_CATCH ",
                                "group by ",
                                "Fish, Rockfish, Flatfish, Invertebrate, Mammal, Bird, ",
                                "SABLE_SET_TYPE, Year, TRIP_ID,  ",
                                "case when Fish = Rockfish or Fish = Flatfish then 0 ELSE Fish end, SPECIES_CODE  ",
                                "having (SABLE_SET_TYPE = N'StRS') and (Year = ",yr,")) AS RC", sep="")
   #strsSpCom    <- GetSQLData(spc,"Sablefish")
   #write.table(strsSpCom, file = paste(path,"results03.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   strsSpCom   <-  read.csv(paste(path,'results03.csv',sep=''),header=T) 
   
   roundfishS   <- strsSpCom[1,1]
   rockfishS    <- strsSpCom[1,2]
   flatfishS    <- strsSpCom[1,3]
   invertS      <- strsSpCom[1,4]
   mammalS      <- strsSpCom[1,5]
   birdS        <- strsSpCom[1,6]
   #totalS       <- firstup(as.character(strsSpCom[1,7])) # taxonomic unit count for StRS with capital
   totalS       <- as.character(strsSpCom[1,7]) # taxonomic unit count for StRS


```

## CATCH COMPOSITION

A total of `r totalS[1]` taxonomic groups were represented in the catches in StRS sets in `r yr` (Table \@ref(tab:table2)).  These included `r roundfishS[1]` roundfish species, `r rockfishS[1]` rockfish species, `r flatfishS[1]`  flatfish species and `r invertS[1]` invertebrate species. Other than sablefish, the most common species, by weight,  were  `r topStRSsp1[1]` (*`r topStRSsc1`*), `r topStRSsp2` (*`r topStRSsc2`*), `r topStRSsp3` (*`r topStRSsc3`*),   `r topStRSsp4` (*`r topStRSsc4`*) and  `r topStRSsp5` (*`r topStRSsc5`*).   

```{r SamplingWords, echo=FALSE}
    # inline text query Sablefish.dbo.GFBIO_RESEARCH_SAMPLE_DETAILS for the counts of Sablefish from StRS sets
    catchStRS   <- paste("select rt.SABLE_SET_TYPE, ",
                         "sum(sd.[Total Count])                           AS count, ",
                         "sum(sd.[Recovered Number])                      AS tagagainlive, ",
                         "sum(sd.[Recovered Dead Number])                 AS tagdead, ",
                         "sum(sd.[Tagged Number] + sd.[Recovered Number]) AS tagrelease, " ,
                         "sum(sd.[Fork Len Tag Sample Count])             AS taglengthsample,  " ,
                         "sum(sd.Sample_count)                            AS samplecount " ,
                         "from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS AS sd INNER JOIN " ,         
                         "dbo.GFBIO_SABLEBIO_TRIP_SET2 AS rt ON " ,
                         "sd.TRIP_ID = rt.TRIP_ID AND  sd.[SET] = rt.SET_NUMBER " ,
                         "where (sd.Year =", yr,") group by rt.SABLE_SET_TYPE",sep="")

    #countStRS   <- GetSQLData(catchStRS,"Sablefish")
    #write.table(countStRS, file = paste(path,"results04.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
    countStRS   <-  read.csv(paste(path,'results04.csv',sep=''),header=T) 
    
    # -- Sablefish.dbo.procReport_Survey_LenMF pulls length data from table GFBIO_SABLEBIO_VW 
    # -- from procedure Build_BIO_Sablefish_Tables for the histogram of lengths
    
    lendat     <-   "exec procReport_Survey_LenMF"
    #lendata    <-   GetSQLData(lendat,"Sablefish")
    #write.table(lendata, file = paste(path,"results05.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
    lendata   <-    read.csv(paste(path,'results05.csv',sep=''),header=T) 

    # late addition for the average lengths per year in text
    lenstats  <- "exec procRReport_Survey_LenAvg"
    #dat       <- GetSQLData(lenstats,"Sablefish")
    #write.table(dat, file = paste(path,'results05b.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
    dat       <- read.csv(paste(path,'results05b.csv',sep=''), header=T)
    
    mavgyr1   <- dat[dat$sex==1 & dat$YEAR==yr,]   # round(mavgyr1$AvL,1)
    favgyr1   <- dat[dat$sex==2 & dat$YEAR==yr,]   # round(favgyr1$AvL,1)
  
    fdat      <- dat[dat$sex==2,]
    mdat      <- dat[dat$sex==1,]
    
    firstyrfem <-   lendata[lendata$year == yr & lendata$sex == 2,] 
    firstyrmal <-   lendata[lendata$year == yr & lendata$sex == 1,] 
    
    lenMF      <-   lendata[lendata$year <= yr,] 
    brk        <-   seq(min(lenMF$length)-1,max(lenMF$length)+1)
    osex       <-   length(lenMF$length[lenMF$sex==3])
    	
    # -- set up the female data
    females  <-   lenMF$length[lenMF$sex==2]
    females  <-   females[!is.na(females)]
    tf       <-   length(females)                                 # -- count female lengths
    mLf      <-   format(round(mean(females,na.rm=T),1),nsmall=1) # -- mean female length
    stdf     <-   round(sd(females),1)                            # -- standard deviation
    	
    #--  set up the male data
    males    <-   lenMF$length[lenMF$sex==1]
    tm       <-   length(males)                                   # -- count male lengths
    mLm      <-   format(round(mean(males,na.rm=T),1),nsmall=1)   # -- mean male length
    stdm     <-   round(sd(males),1)                              # -- standard deviation
 
    # --  StRS year one by spatial and depth strata:  count/mean of samples for fork length and tagged fish fork lengths
     bio      <-   paste("select locality, depth, PropMales, PropFemales, ",
                         "MalesMnFkLen, FemalesMnFkLen, TaggedMnFkLen ",
                         "from gfbio_sable_bio_summary ",
                         "where depth is not null and year = ",yr,
                         "order by Locality,Depth", sep="")
     #biosumm  <-   GetSQLData(bio,"Sablefish")
     #write.table(biosumm, file = paste(path,"results06.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
     biosumm   <-    read.csv(paste(path,'results06.csv',sep=''),header=T) 

     colnames(biosumm) <-  c("Spatial","Depth","Males","Females","Males","Females","Tagged")
     biosumm$Spatial   <-  cleanf(biosumm$Spatial)  # use the remove duplicates function

     #  -- sum the count of length values for the table columns
     biosumm[16,3]     <-  round((biosumm[1,3] + biosumm[2,3] + biosumm[3,3])/ 3, 2)  # --  males S1 average proportions
     biosumm[16,4]     <-  round((biosumm[1,4] + biosumm[2,4] + biosumm[3,4])/ 3, 2)  # --  females S1 average proportions
     biosumm[16,5]     <-  round((biosumm[1,5] + biosumm[2,5] + biosumm[3,5])/ 3, 0)  # --  males S1 average fork len
     biosumm[16,6]     <-  round((biosumm[1,6] + biosumm[2,6] + biosumm[3,6])/ 3, 0)  # --  females S1 average fork len 
     biosumm[16,7]     <-  round((biosumm[1,7] + biosumm[2,7] + biosumm[3,7])/ 3, 0)  # --  tagged S1 average fork len
      
     biosumm[17,3]     <-  round((biosumm[4,3] + biosumm[5,3] + biosumm[6,3])/ 3, 2)   # -- S2
     biosumm[17,4]     <-  round((biosumm[4,4] + biosumm[5,4] + biosumm[6,4])/ 3, 2)
     biosumm[17,5]     <-  round((biosumm[4,5] + biosumm[5,5] + biosumm[6,5])/ 3, 0)
     biosumm[17,6]     <-  round((biosumm[4,6] + biosumm[5,6] + biosumm[6,6])/ 3, 0)
     biosumm[17,7]     <-  round((biosumm[4,7] + biosumm[5,7] + biosumm[6,7])/ 3, 0)
      
     biosumm[18,3]     <-  round((biosumm[7,3] + biosumm[8,3] + biosumm[9,3])/ 3, 2)   # -- S3
     biosumm[18,4]     <-  round((biosumm[7,4] + biosumm[8,4] + biosumm[9,4])/ 3, 2)
     biosumm[18,5]     <-  round((biosumm[7,5] + biosumm[8,5] + biosumm[9,5])/ 3, 0)
     biosumm[18,6]     <-  round((biosumm[7,6] + biosumm[8,6] + biosumm[9,6])/ 3, 0)
     biosumm[18,7]     <-  round((biosumm[7,7] + biosumm[8,7] + biosumm[9,7])/ 3, 0)
      
     biosumm[19,3]     <-  round((biosumm[10,3] + biosumm[11,3] + biosumm[12,3])/ 3, 2)  # -- S4
     biosumm[19,4]     <-  round((biosumm[10,4] + biosumm[11,4] + biosumm[12,4])/ 3, 2)
     biosumm[19,5]     <-  round((biosumm[10,5] + biosumm[11,5] + biosumm[12,5])/ 3, 0)
     biosumm[19,6]     <-  round((biosumm[10,6] + biosumm[11,6] + biosumm[12,6])/ 3, 0) 
     biosumm[19,7]     <-  round((biosumm[10,7] + biosumm[11,7] + biosumm[12,7])/ 3, 0) 
      
     biosumm[20,3]     <-  round((biosumm[13,3] + biosumm[14,3] + biosumm[15,3])/ 3, 2)  # --S5
     biosumm[20,4]     <-  round((biosumm[13,4] + biosumm[14,4] + biosumm[15,4])/ 3, 2)
     biosumm[20,5]     <-  round((biosumm[13,5] + biosumm[14,5] + biosumm[15,5])/ 3, 0)
     biosumm[20,6]     <-  round((biosumm[13,6] + biosumm[14,6] + biosumm[15,6])/ 3, 0)  
     biosumm[20,7]     <-  round((biosumm[13,7] + biosumm[14,7] + biosumm[15,7])/ 3, 0)
      
     newdata           <-  rbind(biosumm[1:3,],   biosumm[16,], biosumm[4:6,],  biosumm[17,],
                                 biosumm[7:9,],   biosumm[18,], biosumm[10:12,],biosumm[19,], 
                                 biosumm[13:15,], biosumm[20,])   # r bind the average column results
     newdata$Spatial   <-  cleanf(newdata$Spatial)
     colnames(newdata) <-  c("Spatial","Depth","Males","Females","Males","Females","Tagged")
     a <-"the spatial strata S~1~, S~2~, S~3~, S~4~ and S~5~"
     
     pdiffS1 <- biosumm[16,3] - biosumm[16,4]  # --  S1 check male - female prop
     pS1     <- sum(pdiffS1 < 0.00)
     if (pS1 == 1)  {wS1="S~1~, "} else {wS1=""} # --  if value negative, more females
      
     pdiffS2 <- biosumm[17,3] - biosumm[17,4]  #  -- S2 check male - female prop
     pS2 <- sum(pdiffS2 < 0.00)
     if (pS2 == 1)  {wS2="S~2~, "} else {wS2=""} 
      
     pdiffS3 <- biosumm[18,3] - biosumm[18,4]   # --  S3 check male - female prop
     pS3 <- sum(pdiffS3 < 0.00)
     if (pS3 == 1)  {wS3="S~3~, "} else {wS3=""}
      
     pdiffS4 <- biosumm[19,3] - biosumm[19,4]  # -- S4 check male - female prop
     pS4 <- sum(pdiffS4 < 0.00)
     if (pS4 == 1)  {wS4="S~4~, "} else {wS4=""}
      
     pdiffS5 <- biosumm[20,3] - biosumm[20,4]  # -- S4 check male - female prop
     pS5 <- sum(pdiffS5 < 0.00)
     if (pS5 == 1)  {wS5="S~5~, "} else {wS5=""}
      
     stratafem    <- paste(wS1,wS2,wS3,wS4,wS5,sep="")         # -- list of S areas where more females
     stratafema   <- substr(stratafem, 1, nchar(stratafem)-2)  # -- trim trailing comma
     stratafemale <- sub(",([^,]*)$", " and\\1", stratafema)   # -- replace last comma with and
     stratafemale <- paste('the spatial strata ',stratafemale, sep="")
     if(stratafemale==a){stratafemale="all spatial strata"}

     #  More females than males were seen in the shallow depth stratum as per yearly trend...
     shallS1 <- sum((biosumm[1,3] - biosumm[1,4])<0.00)
     
     if (shallS1 == 1)  {shallwS1="S~1~, "} else {shallwS1=""}
           shallS2 <- sum((biosumm[4,3] - biosumm[4,4])<0.00)
           
     if (shallS2 == 1)  {shallwS2="S~2~, "} else {shallwS2=""}
           shallS3 <- sum((biosumm[7,3] - biosumm[7,4])<0.00)
            
     if (shallS3 == 1)  {shallwS3="S~3~, "} else {shallwS3=""}      
           shallS4 <- sum((biosumm[10,3] - biosumm[10,4])<0.00)
            
     if (shallS4 == 1)  {shallwS4="S~4~, "} else {shallwS4=""}  
           shallS5 <- sum((biosumm[13,3] - biosumm[13,4])<0.00)
            
     if (shallS5 == 1)  {shallwS5="S~5~, "} else {shallwS5=""}
            
     shallsfem    <- paste(shallwS1,shallwS2,shallwS3,shallwS4,shallwS5,sep="")
     shallsfema   <- substr(shallsfem, 1, nchar(shallsfem)-2)  # -- trim trailing comma
     shallsfemale <- sub(",([^,]*)$", " and\\1", shallsfema)   # replace last comma with and
     shallsfemale <- paste('the spatial strata ',shallsfemale, sep="") 
     if(shallsfemale==a){shallsfemale="all spatial strata"}
     
     # -- Assumption that more males than females were seen in the mid depth stratum
     midS1 <- sum((biosumm[2,3] - biosumm[2,4])>0.00)
      
      if (midS1 == 1)  {midwS1="S~1~, "} else {midwS1=""}
          midS2 <- sum((biosumm[5,3] - biosumm[5,4])>0.00)
      
      if (midS2 == 1)  {midwS2="S~2~, "} else {midwS2=""}
            midS3 <- sum((biosumm[8,3] - biosumm[8,4])>0.00)
      
      if (midS3 == 1)  {midwS3="S~3~, "} else {midwS3=""}      
          midS4 <- sum((biosumm[11,3] - biosumm[11,4])>0.00)
      
      if (midS4 == 1)  {midwS4="S~4~, "} else {midwS4=""}  
            midS5 <- sum((biosumm[14,3] - biosumm[14,4])>0.00)
      
      if (midS5 == 1)  {midwS5="S~5~, "} else {midwS5=""}
            
      midsm    <- paste(midwS1,midwS2,midwS3,midwS4,midwS5,sep="")
      midsma   <- substr(midsm, 1, nchar(midsm)-2)      # -- trim trailing comma
      midsmale <- sub(",([^,]*)$", " and\\1", midsma)   # -- replace last comma with and
      
      # -- Assumption that more females than males were seen in the deep depth stratum
      deepS1 <- sum((biosumm[3,3] - biosumm[3,4])<0.00)
      if (deepS1 == 1)  {deepwS1="S~1~, "} else {deepwS1=""}
      deepS2 <- sum((biosumm[6,3] - biosumm[6,4])<0.00)
      if (deepS2 == 1)  {deepwS2="S~2~, "} else {deepwS2=""}
      deepS3 <- sum((biosumm[9,3] - biosumm[9,4])<0.00)
      if (deepS3 == 1)  {deepwS3="S~3~, "} else {deepwS3=""}      
      deepS4 <- sum((biosumm[12,3] - biosumm[12,4])<0.00)
      if (deepS4 == 1)  {deepwS4="S~4~, "} else {deepwS4=""}  
      deepS5 <- sum((biosumm[15,3] - biosumm[15,4])<0.00)
      if (deepS5 == 1)  {deepwS5="S~5~, "} else {deepwS5=""}
      deepsfem    <- paste(deepwS1,deepwS2,deepwS3,deepwS4,deepwS5,sep="")
      deepsfema   <- substr(deepsfem, 1, nchar(deepsfem)-2)   # trim trailing comma
      deepsfemale <- sub(",([^,]*)$", " and\\1", deepsfema)   # replace last comma with and
 
   # -- other fish counts
     othfish      <-   paste(" select species_name, sum(Sample_count) as count   ",
                             " from dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ",
                             " where (Year = ", yr, ") group by species_name, species ",
                             " order by species", sep="")
     #otherfish    <-   GetSQLData(othfish,"Sablefish")
     #write.table(otherfish, file = paste(path,"results07.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")      
     otherfish    <-   read.csv(paste(path,'results07.csv',sep=''),header=T)
    

```
## SABLEFISH SAMPLING

A detailed breakdown of the fate of the catch in each trap for the `r yr` survey is listed in Appendix \@ref(app:fourth-appendix). 

During the `r yr` StRS, a total of `r format(countStRS[1,2], big.mark=",")` sablefish were caught.   Of that total, `r format(countStRS[1,5], big.mark=",")` were tagged and released and `r format(countStRS[1,7], big.mark=",")` were retained for biological sampling. Of the tagged fish, `r countStRS[1,3]` were previously tagged fish that were re-released with a new tag.  One previously tagged fish was retained for sampling (Appendix \@ref(app:fifth-appendix)).

Overall, the StRS sets had a higher proportion of females than males over `r stratafemale` (Table \@ref(tab:table3)).  More females than males were caught in the shallow depth stratum within `r shallsfemale`.  In the mid depth stratum, there were more males than females in `r midsmale`.  The deepest depth stratum saw more females in spatial strata `r deepsfemale`.  

Significant differences in length distributions between female and male sablefish are exhibited in the data collected from the StRS portion of the 2003 - `r yr` surveys. The mean fork length ($\bar{x}$) for females was `r mLf` cm and the mean fork length ($\bar{x}$) for males was `r mLm` cm (Figure \@ref(fig:figure10)).

In `r yr`, the average mean fork length for the `r format(length(firstyrfem$sex), big.mark=",")` females was `r as.character(round(mean(firstyrfem$length),1))` cm  and the average mean fork length for the `r format(length(firstyrmal$sex), big.mark=",")` males was `r as.character(round(mean(firstyrmal$length),1))` cm.  The mean length of both females and males reached their lowest mean size since 2003 (Figure \@ref(fig:figure11)). 

On average, female sablefish grow faster and reach a far greater size (Figure \@ref(fig:figure12)a) compared to males (Figure \@ref(fig:figure12)b).


## SABLEFISH SUB-LEGAL ENCOUNTERS

```{r SablefishAgesText, echo=FALSE}
   # -- provides values for inline text, important to know the last year of ages completed
   # -- sql server procedure:  procRReport_Survey_proportions_at_age which pulls age data from 
   # -- GFBIOSQL.dbo.b21_samples and b22_specimens
   age         <-  paste("select Female_Yr_Total,Age from Report_Survey_GFBIO_Age_MF_Prop where ", 
                         "SetType='StRS' and f=1 and Year=",yr,sep="")
   #agedat      <-  GetSQLData(age,"Sablefish")    # --  female age total and count of most aged text captions
   #write.table(agedat, file = paste(path,"results08.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   agedat      <-    read.csv(paste(path,'results08.csv',sep=''),header=T)
   
   oldageF     <-  "exec procRReport_Survey_oldAgeFish 2"  # -- oldest female text caption
   #oldageFem   <-  GetSQLData(oldageF,"Sablefish")
   #write.table(oldageFem, file = paste(path,"results09.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")    
   oldageFem   <-    read.csv(paste(path,'results09.csv',sep=''),header=T)
   
   oldageM     <-  "exec procRReport_Survey_oldAgeFish 1"  # -- oldest male text caption
   #oldageMale  <-  GetSQLData(oldageM,"sablefish") 
   #write.table(oldageMale, file = paste(path,"results10.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   oldageMale  <-    read.csv(paste(path,'results10.csv',sep=''),header=T) 
   
   oldFem      <-  oldageFem[1,2]                # -- oldest female age
   oldFemYr    <-  oldageFem[1,3]                # -- year captured
   oldMale     <-  oldageMale[1,2]               # -- oldest male age
   oldMaleYr   <-  oldageMale[1,3]               # -- year captured
```

Distinct distribution patterns became apparent across strata of increasing sub-legal sablefish (<55 cm fork length), following highly anomalous warm ocean conditions known as the “Blob”
and the “Blob 2.0”.  The first marine heat wave (Blob) began in the NE Pacific in late 2013 [@Bond2015] and persisted until 2016 [@DORANTESGILARD2020].   A similar marine heat wave (Blob 2.0) with warm sea surface temperatures appeared again in the summer of 2019 [@Amaya2020].   

More than half of the sub-legal specimens were captured in the southern strata (S~1~) mid-depth waters (RD~2~) in 2014 and shallow waters (RD~1~) in 2015. The sub-legal specimen count was above 50% in both 2017 and 2018 in the northern strata of S~4~ and S~5~  mid-depth waters (RD~2~). In 2019, the sub-legal specimens dominated in all StRS survey strata (S~1~ to S~5~) mid-depth waters (RD~2~). In `r yr`, the sub-legal specimen count was over 50% in S~1~, S~4~ and S~5~ in the mid-depth waters (RD~2~) (Figure \@ref(fig:figure13)). 
 
## RECOVERED TAGGED SABLEFISH

Of the `r countStRS[1,3]` Canadian tagged fish that were recovered on the survey, the majority (79%) had travelled no more than 50 kilometers of the release site.  Most recoveries (70%) were recaptured within 5 years at liberty (Table \@ref(tab:table4)).  Three fish were recovered a second time and released a third time (Table \@ref(tab:table5)).

```{r OtherFishText, echo=FALSE}
   # data from APPENDIX F
   otherspec2  <-  read.csv(paste(path,'appendixF.csv',sep=''),header=T) # read from csv
   rebs.count    <-  sum(otherspec2$Sample_count)
   re.count    <-  sum(otherspec2$'Rougheye')
   bs.count    <-  sum(otherspec2$'Blackspotted')
   hy.count    <-  sum(otherspec2$'Hybrid')
   
   if (hy.count==0) {hy.count ='none'}

```
## OTHER FISH SAMPLING

Length, sex, maturity, otoliths and DNA samples were collected for `r rebs.count` rougheye/blackspotted rockfish samples.  The science samplers visually
identified `r re.count` as rougheye, `r bs.count` as blackspotted and `r hy.count` as hybrid species (Appendix \@ref(app:sixth-appendix)).

## SABLEFISH AGES

At the time of this report, sablefish ages were only available prior to 2019.  The highest proportion of male ages in StRS sets for 2003 through to 2011 were 3, 5, 5, 6, 8, 8, 8, 10 and 12 years of age, respectively.  Another cohort appeared in 2012 through to 2016 as 4, 5, 7, 7 and 8 year olds.  A cohort also appeared to arrive in 2017 which was dominated by 3 year olds and in 2018 by 5 year olds (Figure \@ref(fig:figure14)a).  

The highest proportion of female ages in the StRS sets for 2003 through to 2010 were 3, 4, 5, 6, 7, 8, 9 and 10 years of age, respectively. Then, another cohort appeared in 2011 through to 2015, showing up as 3, 4, 5, 6 and 7 year olds.  In 2016, 2017, and 2018 the highest proportion of female sablefish were ages 3, 4, and 5 (Figure \@ref(fig:figure14)b).

Historic data from all samples lists the oldest female sablefish at `r oldFem` years of age, collected in `r oldFemYr` where as the oldest male sablefish with the age of `r oldMale` years old was documented for the year `r oldMaleYr`.

```{r SablefishOceanText, echo=FALSE}

     #  average depth and average temperature by set for year, data from figure 18
     ctddat    <- read.csv(paste(path,'figure15.csv',sep=''),header=T)  # read from csv
     coldest   <- min(ctddat$temperature)
     deepcold  <- ctddat[ which(ctddat$temperature==coldest ), ]
     
     
     # data from figure 19   
     celcius  <-  read.csv(paste(path,'figure16.csv',sep=''),header=T) 

     celcius$depth_stratum  <-     trimws(celcius$depth_stratum)   # trim whitespace

     shallow.temp <- celcius[celcius$depth_stratum=="RD1",]
     mid.temp     <- celcius[celcius$depth_stratum=="RD2",]        
     deep.temp    <- celcius[celcius$depth_stratum=="RD3",]        
       
     celcius.max <-  max(shallow.temp$Avgtemp)
     celcius.max.shallow <- shallow.temp[shallow.temp$Avgtemp==celcius.max,]
     
     celcius.max <-  max(mid.temp$Avgtemp)
     celcius.max.mid <-mid.temp[mid.temp$Avgtemp==celcius.max,]
     
     celcius.max <-  max(deep.temp$Avgtemp)
     celcius.max.deep <-deep.temp[deep.temp$Avgtemp==celcius.max,]  
     
     celcius.min <-  min(shallow.temp$Avgtemp)
     celcius.min.shallow <-shallow.temp[shallow.temp$Avgtemp==celcius.min,]
     
     celcius.min <-  min(mid.temp$Avgtemp)
     celcius.min.mid <-mid.temp[mid.temp$Avgtemp==celcius.min,]
     
     celcius.min <-  min(deep.temp$Avgtemp)
     celcius.min.deep <-deep.temp[deep.temp$Avgtemp==celcius.min,]
     
```


## OCEANOGRAPHIC TEMPERATURES AND DEPTHS
Co-plots of average temperatures and average depths by 1-degree latitude intervals from south-west Vancouver Island to northwest Haida Gwaii indicate that `r yr` survey data exhibited a general trend of decreasing temperature with depth over latitude.  The coldest average temperature per set recorded was `r coldest` $^\circ$C with an average depth of `r deepcold$depth` m in the latitude zone of  `r deepcold$lat`$^\circ$ - `r deepcold$lat +1`$^\circ$ (Figure \@ref(fig:figure15)).

SBE 39 recorders have been placed on survey fishing sets since 2006. In the shallow waters, the lowest average temperature of `r round(celcius.min.shallow[1,5],2)` $^\circ$C  was recorded in `r celcius.min.shallow[1,1]` (latitude zone `r celcius.min.shallow$lat`$^\circ$ - `r celcius.min.shallow$lat+1`$^\circ$); the highest average temperature was `r round(celcius.max.shallow[1,5],2)` $^\circ$C in `r celcius.min.shallow[1,1]` (`r celcius.max.shallow$lat`$^\circ$ - `r celcius.max.shallow$lat+1`$^\circ$) . In the mid-depth waters, the lowest average temperature was `r round(celcius.min.mid[1,5],2)` $^\circ$C in `r celcius.min.mid[1,1]` (`r celcius.min.mid$lat`$^\circ$ - `r celcius.min.mid$lat+1`$^\circ$); the highest average temperature was `r round(celcius.max.mid[1,5],2)` $^\circ$C in `r celcius.max.mid[1,1]` (`r celcius.max.mid$lat`$^\circ$ - `r celcius.max.mid$lat+1`$^\circ$). In the deepest waters, the lowest average temperature was `r round(celcius.min.deep[1,5],2)` $^\circ$C in `r celcius.min.deep[1,1]` (`r celcius.min.deep$lat`$^\circ$ - `r celcius.min.deep$lat+1`$^\circ$) and the highest average temperature was `r round(celcius.max.deep[1,5],2)`$^\circ$C  in `r celcius.min.deep[1,1]` (`r celcius.max.deep$lat`$^\circ$ - `r celcius.max.deep$lat+1`$^\circ$) (Figure \@ref(fig:figure16)).


```{r acknowledge, echo=FALSE}

    names      <-  paste(" select keyid, Association, year, Names from dbo.ReportSurvey_Acknowlegdements where year=", yr, sep="")
    #credits    <-  GetSQLData(names,"Sablefish")
    #write.table(credits, file = paste(path,"results13.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
    credits    <-  read.csv(paste(path,'results13.csv',sep=''),header=T) 
    
```    
                                                                                                        
## ACKNOWLEDGEMENTS

The stock assessment survey and data report is the result of the collaborative efforts of many individuals.  Wild Canadian Sablefish has provided coordination and support of the annual Sablefish survey since 1994.  The scientific staff that conducted the `r yr` sablefish research charter included `r credits[1,4]` of Archipelago Marine Research Ltd (AMR).  A special thanks to the skipper and crew of the F/V `r boat`, whose efforts made the survey successful and safe during the COVID-19 pandemic.  In `r yr`, the crew consisted of `r credits[2,4]`.


\clearpage



<!--chapter:end:03_results.Rmd-->

# Tables
(ref:Table1Caption) Spatial strata allocation and completed strata counts (blue) for the `r yr` sablefish research and assessment survey.
\ \
\ \

```{r table1, echo=FALSE}

       Strata      <- c("S1 (South West Coast Vancouver Island or SWCVI)",
                        "S2 (North West Coast Vancouver Island or NWCVI)",
                        "S3 (Queen Charlotte Sound or QCS)",
                        "S4 (South West Coast Haida Gwaii or SWCHG)",
                        "S5 (North West Coast Haida Gwaii or NWCHG)",
                        "Total ")
       act.strata  <- paste("select Year, DEPTH_STRATUM, SPATIAL_STRATUM, COUNT([SET]) AS sets ",
                           "from dbo.GFBIO_RESEARCH_TRIPS ",
                           "group by Year, DEPTH_STRATUM, SPATIAL_STRATUM ",
                           "having (Year = ", yr, " )", sep="")
       #surv.strata <- GetSQLData(act.strata,"Sablefish")
       #write.table(surv.strata, file = paste(path,"table1.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
       surv.strata <-  read.csv(paste(path,'table1.csv',sep=''), header=T)

       RD1      <- c(6,6,8,6,6,32)
       RD1fish  <- surv.strata$sets[surv.strata$DEPTH_STRATUM =="RD1"]
       RD1fish[6]  <- sum(surv.strata$sets[surv.strata$DEPTH_STRATUM =="RD1"])
       RD2fish  <- surv.strata$sets[surv.strata$DEPTH_STRATUM =="RD2"]
       RD2fish[6]  <- sum(surv.strata$sets[surv.strata$DEPTH_STRATUM =="RD2"])
       RD3fish  <- surv.strata$sets[surv.strata$DEPTH_STRATUM =="RD3"]
       RD3fish[6]  <- sum(surv.strata$sets[surv.strata$DEPTH_STRATUM =="RD3"])     
       RD2      <- c(8,7,6,6,7,34)
       RD3      <- c(5,5,5,5,5,25)
       Total    <- c(19,18,19,17,18,91)
       Totfish  <- c(RD1fish[1]+RD2fish[1]+RD3fish[1], RD1fish[2]+RD2fish[2]+RD3fish[2],
                     RD1fish[3]+RD2fish[3]+RD3fish[3], RD1fish[4]+RD2fish[4]+RD3fish[4],
                     RD1fish[5]+RD2fish[5]+RD3fish[5], RD1fish[6]+RD2fish[6]+RD3fish[6]) # addition
       dataf    <- data.frame(Strata, RD1, RD1fish, RD2, RD2fish,RD3, RD3fish, Total, Totfish) 
       yrRD1    <- paste("RD1 ",yr,sep="")
       yrRD2    <- paste("RD2 ",yr,sep="")
       yrRD3    <- paste("RD3 ",yr,sep="")
       yrTot    <- paste("Total ",yr,sep="")
       
       colnames(dataf) <- c("Spatia Strata", "RD1",yrRD1, "RD2",yrRD2,"RD3",yrRD3,"Total",yrTot)
   
       kableExtra::kable(dataf, booktabs = TRUE,linesep = "",
                   format = "latex",
                   caption = "(ref:Table1Caption)") %>%
              row_spec(0,    bold = T) %>%
              row_spec(5, hline_after = T) %>%
              column_spec(2, width  = "0.5cm") %>%
              column_spec(3, width  = "0.5cm", color="blue" ) %>%
              column_spec(4, width  = "0.5cm") %>%
              column_spec(5, width  = "0.5cm", color="blue") %>% 
              column_spec(6, width  = "0.5cm") %>% 
              column_spec(7, width  = "0.5cm", color="blue") %>%          
              column_spec(8, width  = "0.7cm") %>%
              column_spec(9, width  = "0.5cm", color="blue") %>% 
              row_spec(0, color="black") %>%
              row_spec(6, bold=T) %>%
              add_header_above(c(" "= 1, "Depth Strata" = 6, " " = 2), bold=T) %>%
       kableExtra::kable_styling(font_size = 10, position = "left",latex_options = "hold_position")
  
  
```
\clearpage

(ref:Table2Caption) Summary of species captured during the `r yr` survey StRS sets conducted by the `r boat`. No value in the weight column indicates that the catch was not weighed. No value in weight and count of 1 indicates trace weights of less than 1 kg recorded.
\ \
\ \


```{r table2,  echo=FALSE}

    options(knitr.kable.NA = '')
    dtSP   <- paste("exec procRReport_SpeciesSummary ",yr," ,'StRS'",sep="")
    #datSP  <- GetSQLData(dtSP,"Sablefish")
    #write.table(datSP, file = paste(path,"Table2.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
    datSP  <-  read.csv(paste(path,'table2.csv',sep=''), header=T)
       
    dat1SP <- datSP[,c(-1)] 
    dat1SP <- dat1SP[,c(-3)]
    dat1SP <- dat1SP[,c(-2)]
    dat1SP <- dat1SP[,c(-6)]  # trim columns
    cleandataSP<-dat1SP
    cleandataSP$Summary_sp <- cleanf(cleandataSP$Summary_sp)  #  remove duplicates function
    colnames(cleandataSP)  <- c( "Category", "Common Name", "Scientific Name" , "Count", "Weight(kg)")
    
    kableExtra::kable(cleandataSP,
                      booktabs = TRUE,linesep = "",
                      format = "latex",  caption = "(ref:Table2Caption)") %>%
                      row_spec(0,    bold = T) %>%
                      row_spec(10,  hline_after = T) %>%
                      row_spec(17,  hline_after = T) %>%
                      row_spec(21,  hline_after = T) %>%
                      kableExtra::kable_styling(font_size = 8, position = "left",
                                                latex_options = "hold_position")
```
\clearpage

(ref:Table3Caption) Summary of sablefish sex ratios and fork length measurements collected during the `r yr` stratified random sets by spatial and depth stratum.
\ \
\ \
```{r table3, echo=FALSE}

    #newdata2   <-   rbind(newdata,biosumm)
    newdata2    <-   newdata  # created in results section

    kableExtra::kable(newdata2, row.names = FALSE,
                booktabs = TRUE,   linesep = "",
                format = "latex",  caption = "(ref:Table3Caption)") %>% 
    add_header_above(c("Depth Strata/Locality"= 2,
                        "Proportion" = 2, 
                        "Mean Fork Length (mm)" = 3),bold=T) %>%
      
    kableExtra::kable_styling(font_size = 9, position = "left", latex_options = "hold_position") %>%
                row_spec(0,    bold = T) %>%
                row_spec(3,    hline_after = T) %>%
                row_spec(4,    bold = T, hline_after = T) %>%
                row_spec(7,    hline_after = T) %>% 
                row_spec(8,    bold = T, hline_after = T) %>%      
                row_spec(11,   hline_after = T) %>%
                row_spec(12,   bold = T, hline_after = T) %>%      
                row_spec(15,   hline_after = T)   %>% 
                row_spec(16,   bold = T, hline_after = T) %>%   
                row_spec(19,   hline_after = T)   %>% 
                row_spec(20,   bold = T)
      
```
\ \
\ \
(ref:Table4Caption) Sablefish tag recovery counts in 2020, by distance from release site and years at liberty. Distances were determined using the great circle distance between the release location and recovery location.
\ \
\ \

```{r table4, echo=FALSE}

       # in('A00545713','A00984002','A00254854') 3 tags re-released twice
       # in('A00733036','A00315966','A00550705')
      # in('A00545713','A00984002','A00254854','A00733036','A00315966','A00550705') 

      tag  <- paste("select * from Report_Survey_Tag_Recoveries",sep="") # have to go in database and change the year value
      #tag.rec <- GetSQLData(tag,"FishTag")
      #write.table(tag.rec, file = paste(path,"table4.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
      tag.rec <-  read.csv(paste(path,'table4.csv',sep=''), header=T)
      
      tag.rec[is.na(tag.rec)] <- 0   # convert NA to zero in whole table
      tag.rec$YearGroups      <- as.character(tag.rec$YearGroups)  # change column to character
      tag.rec$YearGroups      <- gsub("Grp1.", "", tag.rec$YearGroups)
      tag.rec$YearGroups      <- gsub("Grp2.", "", tag.rec$YearGroups)
      tag.rec$YearGroups      <- gsub("Grp3.", "", tag.rec$YearGroups)  
      tag.rec$YearGroups      <- gsub("Grp4.", "", tag.rec$YearGroups)      
      tag.rec$Recoveries      <- as.numeric(rowSums(tag.rec[,2:8], na.rm=TRUE))
      
      ad.row <- c('Total Counts',sum(tag.rec$X.10.km),sum(tag.rec$X11.50.km),sum(tag.rec$X51.100.km),
                          sum(tag.rec$X101.250.km),sum(tag.rec$X251.500.km),sum(tag.rec$X501.1000.km),
                          sum(tag.rec$X.1000.km), sum(tag.rec$Recoveries) )
      tag.rec2 <- rbind(tag.rec,ad.row) 

      names(tag.rec2) <- c("Years at Liberty","<10","11-50","51-100","101-250","251-500","501-1000","1000+","Recovery count")
   
      kableExtra::kable(tag.rec2, row.names = FALSE,
                booktabs = TRUE,   linesep = "",
                format = "latex",  caption = "(ref:Table4Caption)") %>% 
      add_header_above(c(" "= 1,
                        "Distance (km) from Release Location" = 7, 
                        " " = 1),bold=T) %>% 
      
       kableExtra::kable_styling(font_size = 9, position = "left", latex_options = "hold_position") %>%
                row_spec(0, bold = T) %>%
                row_spec(4, hline_after = T) %>%
                column_spec(2, width  = "1.1cm") 

```
\clearpage
(ref:Table5Caption) Tag history of the events of three previously tagged sablefish recovered on the 2020 survey. Measurement errors (instrumental, environmental or observational) may have caused the shortened lengths.
\ \
\ \


```{r table5, echo=FALSE}

      GIS1 <- paste("SELECT  get_tags3.TAG_ID, CONVERT(varchar, FISH_TAG_EVENTS_4.EVENT_DATE, 101) AS date1, FISH_TAG_EVENTS_4.EVENT_YEAR, dbo.EVENT_TYPE.EVENT_DESCRIPTION, FISH_TAG_EVENTS_4.EVENT_NUMBER, FISH_TAG_EVENTS_4.EVENT_TRIP,  dbo.FISH_STATE.RECOVERY_STATE_DESC, dbo.q_Fish_Tag_Lengths.Length, FISH_TAG_EVENTS_4.TAG_NUMBER,  FISH_TAG_EVENTS_4.PREVIOUS_TAG_NUMBER, FISH_TAG_EVENTS_4.FISH_EVENT_NUMBER,FISH_TAG_EVENTS_4.EVENT_SET,FISH_TAG_EVENTS_4.RECAPTURE_FISH_ID FROM  dbo.EVENT_TYPE RIGHT OUTER JOIN  (SELECT  TAG_ID, rfi   FROM   (SELECT   FISH_TAG_EVENTS_1.TAG_ID, QRY3.rfi  FROM   (SELECT  TAG_ID, CASE WHEN RECAPTURE_FISH_ID = 0 THEN - 99 ELSE ISNULL(RECAPTURE_FISH_ID, - 99) END AS rfi FROM   (SELECT   TAG_ID, RECAPTURE_FISH_ID  FROM   dbo.FISH_TAG_EVENTS WHERE  (TAG_NUMBER = N'A00315966')) AS QRY1 UNION  SELECT   TAG_ID, RECAPTURE_FISH_ID FROM    (SELECT   TAG_ID, RECAPTURE_FISH_ID  FROM dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_2 WHERE  (PREVIOUS_TAG_NUMBER = N'A00315966')) AS QRY2) AS QRY3 INNER JOIN dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_1 ON QRY3.rfi = FISH_TAG_EVENTS_1.RECAPTURE_FISH_ID GROUP BY FISH_TAG_EVENTS_1.TAG_ID, QRY3.rfi HAVING  (QRY3.rfi IS NOT NULL)) AS get_tags1  UNION SELECT  TAG_ID, RECAPTURE_FISH_ID FROM    (SELECT  FISH_TAG_EVENTS_1.TAG_ID, QRY3_1.RECAPTURE_FISH_ID FROM (SELECT TAG_ID, RECAPTURE_FISH_ID FROM   (SELECT   TAG_ID, RECAPTURE_FISH_ID FROM   dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_3 WHERE    (TAG_NUMBER = N'A00315966')) AS QRY1_1 UNION SELECT   TAG_ID, RECAPTURE_FISH_ID   FROM   (SELECT     TAG_ID, RECAPTURE_FISH_ID FROM   dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_2 WHERE  (PREVIOUS_TAG_NUMBER = N'A00315966')) AS QRY2_1) AS QRY3_1 INNER JOIN dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_1 ON QRY3_1.TAG_ID = FISH_TAG_EVENTS_1.TAG_ID GROUP BY FISH_TAG_EVENTS_1.TAG_ID, QRY3_1.RECAPTURE_FISH_ID  HAVING (QRY3_1.RECAPTURE_FISH_ID IS NULL)) AS get_tags2) AS get_tags3 INNER JOIN  dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_4 ON get_tags3.TAG_ID = FISH_TAG_EVENTS_4.TAG_ID ON dbo.EVENT_TYPE.EVENT_TYPE = FISH_TAG_EVENTS_4.EVENT_TYPE LEFT OUTER JOIN dbo.FISH_STATE RIGHT OUTER JOIN dbo.FISH_TAG_REC_SPECS ON dbo.FISH_STATE.RECOVERY_STATE_CODE = dbo.FISH_TAG_REC_SPECS.RECOVERY_STATE ON FISH_TAG_EVENTS_4.TAG_ID = dbo.FISH_TAG_REC_SPECS.TAG_ID LEFT OUTER JOIN dbo.q_Fish_Tag_Lengths ON FISH_TAG_EVENTS_4.TAG_ID = dbo.q_Fish_Tag_Lengths.TAG_ID ORDER BY FISH_TAG_EVENTS_4.EVENT_YEAR, FISH_TAG_EVENTS_4.FISH_EVENT_NUMBER,date1 ", sep="")   # for 2020 only
 GIS2 <- paste("SELECT  get_tags3.TAG_ID, CONVERT(varchar, FISH_TAG_EVENTS_4.EVENT_DATE, 101) AS date1, FISH_TAG_EVENTS_4.EVENT_YEAR, dbo.EVENT_TYPE.EVENT_DESCRIPTION, FISH_TAG_EVENTS_4.EVENT_NUMBER, FISH_TAG_EVENTS_4.EVENT_TRIP,  dbo.FISH_STATE.RECOVERY_STATE_DESC, dbo.q_Fish_Tag_Lengths.Length, FISH_TAG_EVENTS_4.TAG_NUMBER,  FISH_TAG_EVENTS_4.PREVIOUS_TAG_NUMBER, FISH_TAG_EVENTS_4.FISH_EVENT_NUMBER,FISH_TAG_EVENTS_4.EVENT_SET,FISH_TAG_EVENTS_4.RECAPTURE_FISH_ID FROM  dbo.EVENT_TYPE RIGHT OUTER JOIN  (SELECT  TAG_ID, rfi   FROM   (SELECT   FISH_TAG_EVENTS_1.TAG_ID, QRY3.rfi  FROM   (SELECT  TAG_ID, CASE WHEN RECAPTURE_FISH_ID = 0 THEN - 99 ELSE ISNULL(RECAPTURE_FISH_ID, - 99) END AS rfi FROM   (SELECT   TAG_ID, RECAPTURE_FISH_ID  FROM   dbo.FISH_TAG_EVENTS WHERE  (TAG_NUMBER = N'A00550705')) AS QRY1 UNION  SELECT   TAG_ID, RECAPTURE_FISH_ID FROM    (SELECT   TAG_ID, RECAPTURE_FISH_ID  FROM dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_2 WHERE  (PREVIOUS_TAG_NUMBER = N'A00550705')) AS QRY2) AS QRY3 INNER JOIN dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_1 ON QRY3.rfi = FISH_TAG_EVENTS_1.RECAPTURE_FISH_ID GROUP BY FISH_TAG_EVENTS_1.TAG_ID, QRY3.rfi HAVING  (QRY3.rfi IS NOT NULL)) AS get_tags1  UNION SELECT  TAG_ID, RECAPTURE_FISH_ID FROM    (SELECT  FISH_TAG_EVENTS_1.TAG_ID, QRY3_1.RECAPTURE_FISH_ID FROM (SELECT TAG_ID, RECAPTURE_FISH_ID FROM   (SELECT   TAG_ID, RECAPTURE_FISH_ID FROM   dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_3 WHERE    (TAG_NUMBER = N'A00550705')) AS QRY1_1 UNION SELECT   TAG_ID, RECAPTURE_FISH_ID   FROM   (SELECT     TAG_ID, RECAPTURE_FISH_ID FROM   dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_2 WHERE  (PREVIOUS_TAG_NUMBER = N'A00550705')) AS QRY2_1) AS QRY3_1 INNER JOIN dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_1 ON QRY3_1.TAG_ID = FISH_TAG_EVENTS_1.TAG_ID GROUP BY FISH_TAG_EVENTS_1.TAG_ID, QRY3_1.RECAPTURE_FISH_ID  HAVING (QRY3_1.RECAPTURE_FISH_ID IS NULL)) AS get_tags2) AS get_tags3 INNER JOIN  dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_4 ON get_tags3.TAG_ID = FISH_TAG_EVENTS_4.TAG_ID ON dbo.EVENT_TYPE.EVENT_TYPE = FISH_TAG_EVENTS_4.EVENT_TYPE LEFT OUTER JOIN dbo.FISH_STATE RIGHT OUTER JOIN dbo.FISH_TAG_REC_SPECS ON dbo.FISH_STATE.RECOVERY_STATE_CODE = dbo.FISH_TAG_REC_SPECS.RECOVERY_STATE ON FISH_TAG_EVENTS_4.TAG_ID = dbo.FISH_TAG_REC_SPECS.TAG_ID LEFT OUTER JOIN dbo.q_Fish_Tag_Lengths ON FISH_TAG_EVENTS_4.TAG_ID = dbo.q_Fish_Tag_Lengths.TAG_ID ORDER BY FISH_TAG_EVENTS_4.EVENT_YEAR, FISH_TAG_EVENTS_4.FISH_EVENT_NUMBER,date1 ", sep="")   # for 2020 only
GIS3 <- paste("SELECT  get_tags3.TAG_ID, CONVERT(varchar, FISH_TAG_EVENTS_4.EVENT_DATE, 101) AS date1, FISH_TAG_EVENTS_4.EVENT_YEAR, dbo.EVENT_TYPE.EVENT_DESCRIPTION, FISH_TAG_EVENTS_4.EVENT_NUMBER, FISH_TAG_EVENTS_4.EVENT_TRIP,  dbo.FISH_STATE.RECOVERY_STATE_DESC, dbo.q_Fish_Tag_Lengths.Length, FISH_TAG_EVENTS_4.TAG_NUMBER,  FISH_TAG_EVENTS_4.PREVIOUS_TAG_NUMBER, FISH_TAG_EVENTS_4.FISH_EVENT_NUMBER,FISH_TAG_EVENTS_4.EVENT_SET,FISH_TAG_EVENTS_4.RECAPTURE_FISH_ID FROM  dbo.EVENT_TYPE RIGHT OUTER JOIN  (SELECT  TAG_ID, rfi   FROM   (SELECT   FISH_TAG_EVENTS_1.TAG_ID, QRY3.rfi  FROM   (SELECT  TAG_ID, CASE WHEN RECAPTURE_FISH_ID = 0 THEN - 99 ELSE ISNULL(RECAPTURE_FISH_ID, - 99) END AS rfi FROM   (SELECT   TAG_ID, RECAPTURE_FISH_ID  FROM   dbo.FISH_TAG_EVENTS WHERE  (TAG_NUMBER = N'A00733036')) AS QRY1 UNION  SELECT   TAG_ID, RECAPTURE_FISH_ID FROM    (SELECT   TAG_ID, RECAPTURE_FISH_ID  FROM dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_2 WHERE  (PREVIOUS_TAG_NUMBER = N'A00733036')) AS QRY2) AS QRY3 INNER JOIN dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_1 ON QRY3.rfi = FISH_TAG_EVENTS_1.RECAPTURE_FISH_ID GROUP BY FISH_TAG_EVENTS_1.TAG_ID, QRY3.rfi HAVING  (QRY3.rfi IS NOT NULL)) AS get_tags1  UNION SELECT  TAG_ID, RECAPTURE_FISH_ID FROM    (SELECT  FISH_TAG_EVENTS_1.TAG_ID, QRY3_1.RECAPTURE_FISH_ID FROM (SELECT TAG_ID, RECAPTURE_FISH_ID FROM   (SELECT   TAG_ID, RECAPTURE_FISH_ID FROM   dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_3 WHERE    (TAG_NUMBER = N'A00733036')) AS QRY1_1 UNION SELECT   TAG_ID, RECAPTURE_FISH_ID   FROM   (SELECT     TAG_ID, RECAPTURE_FISH_ID FROM   dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_2 WHERE  (PREVIOUS_TAG_NUMBER = N'A00733036')) AS QRY2_1) AS QRY3_1 INNER JOIN dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_1 ON QRY3_1.TAG_ID = FISH_TAG_EVENTS_1.TAG_ID GROUP BY FISH_TAG_EVENTS_1.TAG_ID, QRY3_1.RECAPTURE_FISH_ID  HAVING (QRY3_1.RECAPTURE_FISH_ID IS NULL)) AS get_tags2) AS get_tags3 INNER JOIN  dbo.FISH_TAG_EVENTS AS FISH_TAG_EVENTS_4 ON get_tags3.TAG_ID = FISH_TAG_EVENTS_4.TAG_ID ON dbo.EVENT_TYPE.EVENT_TYPE = FISH_TAG_EVENTS_4.EVENT_TYPE LEFT OUTER JOIN dbo.FISH_STATE RIGHT OUTER JOIN dbo.FISH_TAG_REC_SPECS ON dbo.FISH_STATE.RECOVERY_STATE_CODE = dbo.FISH_TAG_REC_SPECS.RECOVERY_STATE ON FISH_TAG_EVENTS_4.TAG_ID = dbo.FISH_TAG_REC_SPECS.TAG_ID LEFT OUTER JOIN dbo.q_Fish_Tag_Lengths ON FISH_TAG_EVENTS_4.TAG_ID = dbo.q_Fish_Tag_Lengths.TAG_ID ORDER BY FISH_TAG_EVENTS_4.EVENT_YEAR, FISH_TAG_EVENTS_4.FISH_EVENT_NUMBER,date1 ", sep="")   # for 2020 only
      
      
      #GIS1.tag.rec <- GetSQLData(GIS1,"FishTag")
      #GIS2.tag.rec <- GetSQLData(GIS2,"FishTag")
      #GIS3.tag.rec <- GetSQLData(GIS3,"FishTag")
      #GIS.tag.rec  <- rbind(GIS2.tag.rec, GIS1.tag.rec, GIS3.tag.rec)
      #write.table(GIS.tag.rec, file = paste(path,"table4b.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
      GIS.tag.rec <-  read.csv(paste(path,'table4b.csv',sep=''), header=T)
      GIS.tag.rec <-  GIS.tag.rec[,c(-1,-11,-13)]
      GIS.tag.rec$RECOVERY_STATE_DESC <- " LIVE, RE-RELEASED"
      GIS.tag.rec2 <-  GIS.tag.rec[ , c("TAG_NUMBER", "PREVIOUS_TAG_NUMBER", "EVENT_DESCRIPTION","EVENT_NUMBER", "EVENT_TRIP","EVENT_SET","EVENT_YEAR",
                                        "date1","RECOVERY_STATE_DESC", "Length")]
      
      names(GIS.tag.rec2) <-   c("Release Tag number", "Previous Tag number", "Event","Event no.","Event Trip","Event Set","Event year",
                                 "Date","Fish State", "Length (mm)")
      GIS.tag.rec2 <- GIS.tag.rec2[GIS.tag.rec2$Event=='RELEASE',]
      
 
      kableExtra::kable(GIS.tag.rec2, row.names = FALSE,
                booktabs = TRUE,   linesep = "",
                format = "latex",  caption = "(ref:Table5Caption)") %>% 
 
       kableExtra::kable_styling(font_size = 9, position = "left", latex_options = "hold_position") %>%
                row_spec(0,    bold = T) %>%
                row_spec(3, hline_after = T) %>%
                row_spec(6, hline_after = T) %>%
                column_spec(1, width  = "1.7cm")  %>%
                column_spec(2, width  = "1.7cm")  %>%
                column_spec(3, width  = "1.1cm")  %>%
                column_spec(4, width  = "0.7cm")  %>%
                column_spec(5, width  = "0.7cm")  %>%
                column_spec(6, width  = "0.7cm")  %>%  
                column_spec(7, width  = "0.7cm")  %>% 
                column_spec(8, width  = "0.7cm")  %>%   
                column_spec(8, width  = "1.3cm")  %>%  
                column_spec(9, width  = "3.2cm")  %>%  
                column_spec(10, width  = "0.7cm")          
```


\clearpage


<!--chapter:end:04_tables.Rmd-->

# Figures

(ref:figure1) Location of the boundaries of the five spatial areas (S~1~-S~5~) of the 2020 stratified random survey design. The three depths strata (RD~1~-RD~3~) are colour-coded and nested within each of the five spatial strata. 

```{r figure1, fig.cap='(ref:figure1)', out.width = "410px", fig.align="center", warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
      img <- paste(basepath,'figures/figure1.png',sep='') 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure2) Start locations of survey sets (red markers) conducted in `r yr` for the stratified random survey areas S~1~ through S~5~.

```{r figure2, fig.cap='(ref:figure2)', out.width = "480px", out.height = "381px", fig.align="center", warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
      img <- paste(basepath,'figures/figure2.png',sep='') 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure3)  Image of the F/V `r boat`  used for the 2020 sablefish research and assessment survey.  Photo by Cody Melnychuk. 

```{r figure3, fig.cap='(ref:figure3)', out.width = "480px", out.height = "480px",echo=FALSE, fig.align="center", warning=FALSE}
      img  <- paste(basepath,'figures/figure3.jpg',sep="") 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure4) Trap elements (A).  Trap gear elements consisting of 25 baited traps snapped to beckets along a groundline (B).

```{r figure4, fig.cap='(ref:figure4)', out.width = "380px", out.height = "626px",echo=FALSE, fig.align="center", warning=FALSE}
      img  <- paste(basepath,'figures/figure4.png',sep="") 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure5) Sablefish catch per unit effort (CPUE) by depth and year for StRS sets. Dashed lines delineate depth strata (shallow(RD~1~) = 100-450m, mid(RD~2~) = 450-850m, deep(RD~3~) = 850-1400m).

```{r figure5, fig.cap='(ref:figure5)',echo=FALSE, out.width = "400px",  fig.align = "center", warning=FALSE}

    #   results='asis',echo=FALSE,include=FALSE,warning=FALSE,message = FALSE,error= FALSE
    png(paste(basepath,'figures/figure5.png',sep=''), width = 475, height = 684)  # write png to folder 

    #   query----------raw survey datafile for Landmark fisheries----------------
    landmrk <- paste("select fecCPUE.TRIP_ID, fecCPUE.VESSEL_ID, fecCPUE.SUFFIX, ",                                  
                     "fecCPUE.CAPTAIN_ID, fecCPUE.FISHING_EVENT_ID, fecCPUE.FE_MAJOR_LEVEL_ID,",
                     "fecCPUE.SET_YEAR,   fecCPUE.SET_MONTH, fecCPUE.SET_DAY, ",                               
                     "fecCPUE.SET_TIME,   fecCPUE.DURATION_MINUTES, fecCPUE.SABLE_DEPTH_GROUP, ",                     
                     "fecCPUE.SABLE_AREA_GROUP, fecCPUE.SABLE_SET_TYPE, ", 
                     "fecCPUE.GROUPING_CODE, fecCPUE.REASON_CODE, fecCPUE.FE_REASON_COMMENT, ",                    
                     "fecCPUE.GEAR_CODE,  fecCPUE.NS_AREA, ",
                     "fecCPUE.INSHORE_IND,      fecCPUE.SEAMOUNT_IND, fecCPUE.MAJOR_STAT_AREA_CODE, ",                
                     "fecCPUE.MINOR_STAT_AREA_CODE, fecCPUE.LOCALITY_CODE, ",                                   
                     "fecCPUE.FE_FISHING_Ground_COMMENT, ",
                     "fecCPUE.START_LATITUDE, fecCPUE.START_LONGITUDE, ",
                     "fecCPUE.END_LATITUDE, fecCPUE.END_LONGITUDE, ",
                     "fecCPUE.FE_BEGINNING_BOTTOM_DEPTH, fecCPUE.FE_END_BOTTOM_DEPTH, ",
                     "fecCPUE.FE_MODAL_BOTTOM_DEPTH, fecCPUE.TRAP_MODIFICATIONS_CODE, ",       
                     "fecCPUE.FE_USABILITY, fecCPUE.CPUE_SABLE_WEIGHT, ",
                     "fecCPUE.CPUE_SABLE_COUNT, fecCPUE.CPUE_TRAPS, fecCPUE.TOTAL_TRAPS, ",   
                     "ISNULL(fecCPUE.TOTAL_SABLE_COUNT, 0) AS TOTAL_SABLE_COUNT, ",
                     "ISNULL(fecCPUE.TOTAL_SABLE_WEIGHT, 0) AS TOTAL_SABLE_WEIGHT, ",
                     "fecCPUE.VERIFICATION_METHOD, fecCPUE.FE_START_LATTITUDE_DEGREE, ",
                     "fecCPUE.FE_START_LATTITUDE_MINUTE, fecCPUE.FE_START_LONGITUDE_DEGREE,",     
                     "fecCPUE.fe_start_longitude_minute, fecCPUE.FE_END_LATTITUDE_DEGREE, ", 
                     "fecCPUE.fe_end_lattitude_minute, fecCPUE.fe_end_longitude_degree,   ",
                     "fecCPUE.fe_end_longitude_minute, fecCPUE.START_FATHOMS, ",
                     "fecCPUE.END_FATHOMS, fecCPUE.MODAL_DEPTH_FM, ",
                     "fecCPUE.DepthStrataID, dbo.SurveyBlock_countWeight.nBlocks AS Nh, ",
                     "dbo.SurveyBlock_countWeight.Wh,", 
                     "ISNULL(fecCPUE.CPUE_SABLE_WEIGHT / NULLIF (fecCPUE.CPUE_TRAPS, 0), 0) AS cpue,",   
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Proportion Males], ",
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Male Mean Fork Len(mm)], ",
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Female Mean Fork Len(mm)], ",                                        
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Tagged Mean Fork Len(mm)]  ",
                     "from (select trp.TRIP_ID, trp.VESSEL_ID, trp.SUFFIX, trp.CAPTAIN_ID, fe_1.FISHING_EVENT_ID, ",
                     "fe_1.FE_MAJOR_LEVEL_ID, YEAR(dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, ",
                     "fe_1.fe_end_retrieval_time)) AS SET_YEAR,  ",     
                     "MONTH(dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, ",
                     "fe_1.fe_end_retrieval_time)) AS SET_MONTH,  ", 
                     "DAY(dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, ",
                     "fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time)) AS SET_DAY, ",
                     "CAST(DATEPART(hh, dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, ",
                     "fe_1.fe_end_retrieval_time)) AS varchar) + ",
                     "CAST(DATEPART(mi, dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time)) AS varchar) AS SET_TIME, ",
                     "DATEDIFF(mi, ISNULL(fe_1.fe_end_deployment_time, fe_1.fe_begin_deployment_time), ISNULL(fe_1.fe_begin_retrieval_time, ",  
                     "fe_1.fe_end_retrieval_time)) AS DURATION_MINUTES,  ",
                     "dbo.SableDepthGroup(fe_1.GROUPING_CODE) AS SABLE_DEPTH_GROUP, ",   
                     "dbo.SableAreaGroup(fe_1.GROUPING_CODE, fe_1.REASON_CODE, fe_1.FE_FISHING_Ground_COMMENT) AS SABLE_AREA_GROUP, ",
                     "dbo.SableSetType(fe_1.REASON_CODE,fe_1.FE_REASON_COMMENT, ISNULL(GFBioSQL.dbo.Dater(fe_1.fe_begin_deployment_time, ",  
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time),  ",
                     "trp.TRIP_START_DATE)) AS SABLE_SET_TYPE, fe_1.GROUPING_CODE, fe_1.REASON_CODE, fe_1.FE_REASON_COMMENT, ",
                     "fe_1.GEAR_CODE, sloc.NS_AREA, sloc.INSHORE_IND, sloc.SEAMOUNT_IND, ",
                     "fe_1.MAJOR_STAT_AREA_CODE, fe_1.MINOR_STAT_AREA_CODE, fe_1.LOCALITY_CODE, fe_1.FE_FISHING_Ground_COMMENT, ",
                     "fe_1.FE_START_LATTITUDE_DEGREE + fe_1.FE_START_LATTITUDE_MINUTE / 60 AS START_LATITUDE, ",
                     "(fe_1.FE_START_LONGITUDE_DEGREE + fe_1.fe_start_longitude_minute / 60)  * - 1 AS START_LONGITUDE, ",
                     "fe_1.FE_END_LATTITUDE_DEGREE + fe_1.fe_end_lattitude_minute / 60 AS END_LATITUDE, ",
                     "(fe_1.fe_end_longitude_degree + fe_1.fe_end_longitude_minute / 60) * - 1 AS END_LONGITUDE, ",
                     "fe_1.FE_BEGINNING_BOTTOM_DEPTH, fe_1.FE_END_BOTTOM_DEPTH, fe_1.FE_MODAL_BOTTOM_DEPTH, ",
                     "fe_1.FE_MISC_COMMENT, fets.TRAP_MODIFICATIONS_CODE, fets.USABILITY_CODE AS FE_USABILITY, ",
                     "CAST(CASE WHEN fe_1.REASON_CODE <> 14 AND fets.USABILITY_CODE <> 13 THEN isnull(traps.CPUE_WEIGHT, ",
                     "CASE WHEN fets.USABILITY_CODE IN (1, 12) THEN CASE WHEN fec_1.catch_weight IS NULL AND ",
                     "isnull(fec_1.VERIFICATION_METHOD,0) <> 9 THEN 0 ELSE fec_1.catch_weight END ELSE NULL END)  ",
                     "else NULL end AS numeric(7,1)) ",
                     "AS CPUE_SABLE_WEIGHT, CAST(CASE WHEN fe_1.REASON_CODE <> 14 AND fets.USABILITY_CODE <> 13 THEN isnull(traps.CPUE_COUNT, ",
                     "CASE WHEN fets.USABILITY_CODE IN (1, 12) THEN CASE WHEN fec_1.catch_count IS NULL AND ",
                     "isnull(fec_1.VERIFICATION_METHOD, 0) <> 3 THEN 0 ELSE fec_1.catch_count END ELSE NULL END) ELSE NULL END ",
                     "AS smallint) AS CPUE_SABLE_COUNT, ",
                     "CAST(CASE WHEN fe_1.reason_code <> 14 AND fets.USABILITY_CODE <> 13 THEN ",
                     "isnull(CPUE_TRAPS, CASE WHEN fets.USABILITY_CODE IN (1, 12) THEN fets.TRAPS_FISHED_COUNT ELSE NULL END) ",
                     "ELSE NULL END AS smallint) AS CPUE_TRAPS, ISNULL(traps.TOTAL_TRAPS, fets.TRAPS_FISHED_COUNT) AS TOTAL_TRAPS, ",              
                     "CAST(ISNULL(traps.total_count, fec_1.CATCH_COUNT) AS smallint) as TOTAL_SABLE_COUNT, ",
                     "CAST(ISNULL(traps.total_weight, fec_1.CATCH_WEIGHT) AS numeric(7, 1)) AS TOTAL_SABLE_WEIGHT, ",
                     "fec_1.VERIFICATION_METHOD, fe_1.FE_START_LATTITUDE_DEGREE, fe_1.FE_START_LATTITUDE_MINUTE, ",
                     "fe_1.FE_START_LONGITUDE_DEGREE, fe_1.fe_start_longitude_minute, fe_1.FE_END_LATTITUDE_DEGREE, ",
                     "fe_1.fe_end_lattitude_minute, fe_1.fe_end_longitude_degree, fe_1.fe_end_longitude_minute, ",      
                     "round(PacHarvest.dbo.m2fa(fe_1.FE_BEGINNING_BOTTOM_DEPTH), 0) AS START_FATHOMS, ",
                     "round(PacHarvest.dbo.m2fa(fe_1.FE_END_BOTTOM_DEPTH), 0) AS END_FATHOMS, ",
                     "round(PacHarvest.dbo.m2fa(fe_1.FE_MODAL_BOTTOM_DEPTH), 0) AS MODAL_DEPTH_FM, ",
                     "dbo.DepthStrataID(round(fe_1.FE_MODAL_BOTTOM_DEPTH, 0), ",
                     "dbo.SableDepthGroup(fe_1.GROUPING_CODE)) AS DepthStrataID ",
                     "from GFBioSQL.dbo.TRIP AS trp INNER JOIN ",
                     "(select  TRIP_ID         ",
                     "from GFBioSQL.dbo.TRIP_ACTIVITY    ",
                     "where (ACTIVITY_CODE = 19)) AS act ON trp.TRIP_ID = act.TRIP_ID INNER JOIN  ",
                     "(select TRIP_ID,FISHING_EVENT_ID,FE_PARENT_EVENT_ID, ",
                     "FE_MAJOR_LEVEL_ID,FE_SUB_LEVEL_ID,FE_MINOR_LEVEL_ID,EMPLOYEE_ID, ",                                         
                     "fe_begin_deployment_time, fe_end_deployment_time, fe_begin_retrieval_time, fe_end_retrieval_time,  ",
                     "GROUPING_CODE, REASON_CODE, FE_REASON_COMMENT, MAJOR_STAT_AREA_CODE, ",
                     "MINOR_STAT_AREA_CODE, LOCALITY_CODE, DFO_STAT_AREA_CODE, DFO_STAT_SUBAREA_CODE, ",
                     "LOC_VRFN_METHOD_CODE, FE_FISHING_Ground_COMMENT, ",
                     "FE_START_LATTITUDE_DEGREE, FE_START_LATTITUDE_MINUTE,  ",
                     "FE_END_LATTITUDE_DEGREE,   fe_end_lattitude_minute,      ",             
                     "FE_START_LONGITUDE_DEGREE, fe_start_longitude_minute,     ",
                     "fe_end_longitude_degree, fe_end_longitude_minute, ",
                     "FE_START_LORAN_X, FE_START_LORAN_Y, FE_END_LORAN_X, FE_END_LORAN_Y, ",
                     "FE_DISTANCE_TRAVELLED, FE_DIRECTION_OF_SET, FE_PLOTTER_RECORD_INFOR, ",
                     "DEPTH_VRFN_METHOD_CODE, FE_BEGINNING_BOTTOM_DEPTH, FE_END_BOTTOM_DEPTH,  ",
                     "FE_MODAL_BOTTOM_DEPTH, FE_MIN_BOTTOM_DEPTH, FE_MAX_BOTTOM_DEPTH,  ",
                     "FE_BEGIN_TARGET_DEPTH, FE_END_TARGET_DEPTH, FE_MIN_TARGET_DEPTH, FE_MAX_TARGET_DEPTH,  ",
                     "FE_MODAL_TARGET_DEPTH, FE_BEGIN_CAPTURE_DEPTH, FE_END_CAPTURE_DEPTH,  ",
                     "FE_MIN_CAPTURE_DEPTH, FE_MAX_CAPTURE_DEPTH, FE_MODAL_CAPTURE_DEPTH,  ",
                     "FE_BEGINNING_GEAR_DEPTH, FE_END_GEAR_DEPTH, FE_MIN_GEAR_DEPTH, FE_MAX_GEAR_DEPTH, FE_MODAL_GEAR_DEPTH,  ",  
                     "FE_SURFACE_WATER_TEMPERATURE,  ",
                     "FE_SURFACE_WATER_TEMP_DEPTH, FE_SURFC_WATR_TEMP_TECH_CODE, FE_BOTTOM_WATER_TEMPERATURE,  ",
                     "FE_BOTTOM_WATER_TEMP_DEPTH, FE_BOTTM_WATR_TEMP_TECH_CODE,  ",
                     "FE_MODAL_DEPTH_TEMPERATURE, FE_GEAR_TEMP_TECH_CODE, FE_CTD_REF_NUMBER,  ",
                     "FE_WIND_DIRECTION, FE_WIND_SPEED, BEAUFORT_SCALE_CODE, FE_SWELL, TIDE_CODE,  ",
                     "FE_CLOUD_COVER, FE_LUMINESCENCE, FE_WEATHER_COMMENT, FE_SUN_SHINING_IND, GEAR_CODE,  ",   
                     "EST_CATCH_METHOD_CODE, FE_TOTAL_CATCH_WEIGHT, FE_TOTAL_CATCH_PIECES,  ",
                     "FE_CATCH_WEIGHT_PER_PIECE, FE_SOUNDER_COMMENT, FE_EK500_TAPE_NUMBER,  ",
                     "FE_MISC_COMMENT, ROW_VERSION, BLOCK_DESIGNATION, FE_BEGIN_BOTTOM_CONTACT_TIME,  ",
                     "FE_END_BOTTOM_CONTACT_TIME, BOTTOM_CONTACT_METHOD_CODE, MODIFIED_DATE, MODIFIED_BY,  ",
                     "HAUL_RECORDER, FE_CATCH_COMMENT, PARTIAL_SORT_IND,  ",
                     "FE_CATCH_VERIFICATION_COMMENT, SCALE_ID, CAPTAIN_ID ",
                     "from GFBioSQL.dbo.FISHING_EVENT ",
                     "where (FE_PARENT_EVENT_ID IS NULL)) AS fe_1 ON trp.TRIP_ID = fe_1.TRIP_ID LEFT OUTER JOIN dbo.traps AS traps ",
                     "ON fe_1.TRIP_ID = traps.TRIP_ID AND fe_1.FE_MAJOR_LEVEL_ID = traps.FE_MAJOR_LEVEL_ID LEFT OUTER JOIN ",
                     "dbo.sablefish_locality AS sloc ON fe_1.MAJOR_STAT_AREA_CODE = sloc.MAJOR_STAT_AREA_CODE  ",
                     "and fe_1.MINOR_STAT_AREA_CODE = sloc.MINOR_STAT_AREA_CODE AND  ",
                     "fe_1.LOCALITY_CODE = sloc.LOCALITY_CODE LEFT OUTER JOIN ",
                     "GFBioSQL.dbo.TRAP_SPECS AS fets ON fe_1.FISHING_EVENT_ID = fets.FISHING_EVENT_ID LEFT OUTER JOIN ",
                     "(select  fec.FISHING_EVENT_ID, CATCH_1.SPECIES_CODE, SUM(CATCH_1.CATCH_WEIGHT) AS CATCH_WEIGHT,  ",
                     "sum(CATCH_1.CATCH_COUNT) AS CATCH_COUNT, AVG(ISNULL(CATCH_1.CATCH_VERIFICATION_CODE, 0)) AS VERIFICATION_METHOD ",
                     "from GFBioSQL.dbo.FISHING_EVENT_CATCH AS fec INNER JOIN ",                                                                  
                     "GFBioSQL.dbo.CATCH AS CATCH_1 ON fec.CATCH_ID = CATCH_1.CATCH_ID ",
                     "where (CATCH_1.SPECIES_CODE = '455') ",
                     "group by fec.FISHING_EVENT_ID, CATCH_1.SPECIES_CODE) AS fec_1 ON fe_1.FISHING_EVENT_ID = fec_1.FISHING_EVENT_ID ", 
                     "where (YEAR(dbo.SableSetDate(fe_1.fe_begin_deployment_time, fe_1.fe_end_deployment_time,  ",
                     "fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time)) > 2002))  AS fecCPUE LEFT OUTER JOIN ",
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS ON fecCPUE.FE_MAJOR_LEVEL_ID = dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[SET] AND  ",
                     "fecCPUE.TRIP_ID = dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.TRIP_ID LEFT OUTER JOIN ",
                     "dbo.SurveyBlock_countWeight ON fecCPUE.SABLE_AREA_GROUP = dbo.SurveyBlock_countWeight.areaStrName AND   ",      
                     "fecCPUE.DepthStrataID = dbo.SurveyBlock_countWeight.depthStrName", sep="")

    #raw_survey_data<- GetSQLData(landmrk,"Sablefish")
    #write.table(raw_survey_data, file = paste(path,"figure456.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
    raw_survey_data <- read.csv(paste(path,'/figure5.csv',sep=''),header=T)
    
    # load survey data 
    library(Rmisc)
    strs01            <- subset(raw_survey_data,SABLE_SET_TYPE=="StRS") 
    strs01$sable_cpue <- strs01$CPUE_SABLE_WEIGHT/strs01$CPUE_TRAPS           # changed from TOTAL_TRAPS to CPUE_TRAPS
    strs01$sable_cnts <- strs01$CPUE_SABLE_COUNT/strs01$CPUE_TRAPS 
    strs01$sable_wt   <- strs01$CPUE_SABLE_WEIGHT/strs01$CPUE_SABLE_COUNT
    strs01$strata     <- paste(strs01$SABLE_AREA_GROUP,strs01$SABLE_DEPTH_GROUP)
    strs02            <- arrange(transform(strs01,strata=factor(strata,levels=rev(unique(strs01$strata)))),strata)
    tgc01             <- summarySE(strs02, measurevar="sable_cpue", groupvars=c("SET_YEAR","strata"),na.rm = T)
    tgc.02            <- arrange(transform(tgc01,strata=factor(strata,levels = c("S5 RD3", "S5 RD2", "S5 RD1", 
                                                                                 "S4 RD3", "S4 RD2", "S4 RD1", 
                                                                                 "S3 RD3", "S3 RD2", "S3 RD1", 
                                                                                 "S2 RD3", "S2 RD2", "S2 RD1",
                                                                                 "S1 RD3", "S1 RD2", "S1 RD1" ))),strata)
  
     # drop 2003 and 2004 and set panel ordering for aesthetics
     strs.02<-arrange(transform(strs01[strs01$SET_YEAR>2004,],
                                SET_YEAR=factor(SET_YEAR,levels=c(2005,2009,2013,2017,
                                                                  2006,2010,2014,2018,
                                                                  2007,2011,2015,2019,
                                                                  2008,2012,2016,2020))),SET_YEAR)
    

    
    ggplot( strs.02,aes(x=FE_MODAL_BOTTOM_DEPTH,y=CPUE_SABLE_WEIGHT/CPUE_TRAPS))+
            geom_point(alpha = 3/5,color="steelblue")+
            facet_wrap(~SET_YEAR,ncol=4)+
            scale_x_continuous(breaks = c(100,450,850,1400),limits=c(0,1500))+ 
            geom_vline(xintercept=c(450),linetype="dashed",color="steelblue")+
            geom_vline(xintercept=c(850),linetype="dashed",color="steelblue")+
            xlab("Depth (m)")+
            ylab("CPUE (kg/trap)")+
            theme_bw()

    while (!is.null(dev.list()))  dev.off()
    img    <-  paste(basepath,'figures/figure5.png',sep="")   # retrieve png 
               knitr::include_graphics(img)
```
\clearpage

(ref:figure6) Average Sablefish catch per unit effort (CPUE; mean +/- 95% CIs) by survey strata since 2003. Panels run deep to shallow (left to right) and north to south (top to bottom).

```{r figure6, fig.cap='(ref:figure6)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

     png(paste(basepath,'figures/figure6.png',sep=''), width=500, height=641) # write png to file
     par(mfcol=c(1,1))
     tgc.02$col <- ifelse(tgc.02$SET_YEAR == 2020, "red", "steelblue")

     ggplot(tgc.02,aes(x=SET_YEAR,y=sable_cpue)) +
     geom_errorbar(aes(ymin=sable_cpue-ci, ymax=sable_cpue+ci), width=0, col=tgc.02$col) +
     geom_line(col=tgc.02$col) +
     geom_point(col=tgc.02$col) +
     facet_wrap(~strata,nrow=5)+
     xlab("Year")+
     ylab("Mean CPUE (kg/trap)")+
           #theme_bw()
     theme(     panel.background =  element_rect(fill = "white",
                                    colour = "grey50",
                                    size = 0.5, linetype = "solid"),
                panel.grid.major =  element_line(size = 0.5, linetype = 'solid',
                                    colour = "grey90"), 
                panel.grid.minor =  element_line(size = 0.25, linetype = 'solid',
                                    colour = "grey90"),
                strip.background =  element_rect(fill = "grey80", colour = "grey30"), 
                plot.margin=unit(c(0.2,0.2,0.2,1),"cm")) 
     
  
     while (!is.null(dev.list()))  dev.off()
     img <-   paste(basepath,'figures/figure6.png',sep='')   # -- retrieve png 
              knitr::include_graphics(img)
```

\clearpage
(ref:figure7) Average number of sablefish per trap (mean +/- 95% CIs) by StRS survey strata over time. Panels run shallow to deep (left to right) and south to north (top to bottom).

```{r figure7, fig.cap='(ref:figure7)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

    png(paste(basepath,'figures/figure7.png', sep=''), width=500, height=641) # write png to file
    par(mfcol=c(1,1))
    
    
    strs                   <- subset(raw_survey_data,SABLE_SET_TYPE=="StRS") 
    strs$sable_cpue        <- strs$CPUE_SABLE_WEIGHT/strs$CPUE_TRAPS 
    strs$sable_cnt         <- (strs$CPUE_SABLE_COUNT/strs$CPUE_TRAPS)
    strs$sable_wg          <- (strs$CPUE_SABLE_WEIGHT/strs$CPUE_SABLE_COUNT) 
    strs$sable_avwt_trap   <- (strs$sable_cpue/strs$sable_cnt)
    strs$strata            <-  paste(strs$SABLE_AREA_GROUP,strs$SABLE_DEPTH_GROUP)
 
    strs2 <- arrange(transform(strs,strata=factor(strata,levels=rev(unique(strs$strata)))),strata)
    
    tgc   <- summarySE(strs2, measurevar=("sable_cpue"),         groupvars=c("SET_YEAR","strata"),na.rm = T)
    tgcwg <- summarySE(strs2, measurevar=("sable_wg"),           groupvars=c("SET_YEAR","strata"),na.rm = T)
    tgcnt <- summarySE(strs2, measurevar=("sable_cnt"),          groupvars=c("SET_YEAR","strata"),na.rm = T)

    tgc   <- arrange(transform(tgc,
                     strata=factor(strata,
                                   levels=c("S5 RD3", "S5 RD2", "S5 RD1", 
                                            "S4 RD3", "S4 RD2", "S4 RD1", 
                                            "S3 RD3", "S3 RD2", "S3 RD1", 
                                            "S2 RD3", "S2 RD2", "S2 RD1",
                                            "S1 RD3", "S1 RD2", "S1 RD1"))),strata)
    
    tgcwg<-arrange(transform(tgcwg,
                             strata=factor(strata,
                                           levels=c("S5 RD3", "S5 RD2", "S5 RD1", 
                                                    "S4 RD3", "S4 RD2", "S4 RD1", 
                                                    "S3 RD3", "S3 RD2", "S3 RD1", 
                                                    "S2 RD3", "S2 RD2", "S2 RD1",
                                                    "S1 RD3", "S1 RD2", "S1 RD1"))),strata)
    
    tgcnt<-arrange(transform(tgcnt,
                             strata=factor(strata,
                                           levels=c("S5 RD3", "S5 RD2", "S5 RD1", 
                                                    "S4 RD3", "S4 RD2", "S4 RD1", 
                                                    "S3 RD3", "S3 RD2", "S3 RD1", 
                                                    "S2 RD3", "S2 RD2", "S2 RD1",
                                                    "S1 RD3", "S1 RD2", "S1 RD1"))),strata)

    tgcnt$col <- ifelse(tgcnt$SET_YEAR == 2020, "red", "steelblue")
    ggplot(tgcnt,aes(x=SET_YEAR,y=sable_cnt))+
           geom_errorbar(aes(ymin=sable_cnt-ci, ymax=sable_cnt+ci), width=0, col=tgcnt$col) +
           geom_line(col=tgcnt$col ) +
           geom_point(col=tgcnt$col ) +
           facet_wrap(~rev(strata),nrow=5,labeller = )+
           coord_cartesian(ylim=c(0,60))+ 
           xlab("Year")+
           ylab("Mean CPUE (#fish/trap)")+
        
     theme(panel.background = element_rect(fill = "white",
                              colour = "grey50",
                              size = 0.5, linetype = "solid"),
           panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                              colour = "grey90"), 
           panel.grid.minor = element_line(size = 0.25, linetype = 'solid',
                              colour = "grey90"),
           strip.background = element_rect(fill = "grey80", colour = "grey30"), 
           plot.margin=unit(c(0.2,0.2,0.2,1),"cm")) 
    
    while (!is.null(dev.list()))  dev.off()
    img <- paste(basepath,'figures/figure7.png',sep='')   # -- retrieve png 
           knitr::include_graphics(img)
    
```
\clearpage
(ref:figure8) Average weight of sablefish (mean +/- 95% CIs) by survey strata over time. Panels run shallow to deep (left to right) and south to north (top to bottom).

```{r figure8, fig.cap='(ref:figure8)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

    png(paste(basepath,'figures/figure8.png',sep=''),width=500, height=641) # write png to file
    par(mfcol=c(1,1))
    tgcwg$col <- ifelse(tgcwg$SET_YEAR == 2020, "red", "steelblue")    
    

    ggplot(tgcwg,aes(x= SET_YEAR,y=sable_wg))+
    geom_errorbar(aes(ymin=sable_wg-ci, ymax=sable_wg+ci), width=0, col= tgcwg$col) +
    geom_line(col= tgcwg$col) +
    geom_point(col= tgcwg$col) +
    facet_wrap(~strata,nrow=5)+
    coord_cartesian(ylim=c(1,6)) + 
    xlab("Year")+
    ylab("Sablefish weight (kg)") +
      #theme_bw()
     theme(     panel.background = element_rect(fill = "white",
                                colour = "grey50",
                                size = 0.5, linetype = "solid"),
                panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "grey90"), 
                panel.grid.minor = element_line(size = 0.25, linetype = 'solid',
                                colour = "grey90"),
                strip.background =  element_rect(fill = "grey80", colour = "grey30"), 
                plot.margin=unit(c(0.2,0.2,0.2,1),"cm")) 
    
    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure8.png',sep='')   # -- retrieve png 
              knitr::include_graphics(img)
```   
\clearpage

(ref:figure9) Annual mean weight of sablefish per trap (kg/trap) (A);  annual mean number of sablefish per trap (#fish/trap) (B); annual mean weight of sablefish (kg) (C) by StRS survey strata over time. Horizontal line is median and blue dots are arithmetic mean.

```{r figure9, fig.cap='(ref:figure9)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

  png(paste(basepath,'figures/figure9.png', sep=''), width=600, height=800) # write png to file
  library(cowplot)
 
       p <- ggplot(tgc,aes(x=as.factor(SET_YEAR),y=sable_cpue)) + 
          geom_boxplot(fill="grey90", width=0.5) +
          stat_summary(fun.y=mean, geom="point", shape=16, size=2,col="steelblue")+
          xlab("Year")+
          ylab("StRS CPUE (kg/trap)")+
          #scale_y_continuous(limits=c(0,175))+
          theme(axis.text = element_text(size = 6)) + 
          theme_bw()
  
       p1 <- ggplot(tgcnt, aes(x=as.factor(SET_YEAR), y=sable_cnt)) + 
          geom_boxplot(fill="grey90", width=0.5) +
          stat_summary(fun.y=mean, geom="point", shape=16, size=2,col="steelblue")+
          xlab("Year") +
          ylab("CPUE (#fish/trap)") +
          #scale_y_continuous(limits=c(0,75))+
          theme(axis.text = element_text(size = 6)) + 
          theme_bw()
     
     p2 <- ggplot(tgcwg, aes(x=as.factor(SET_YEAR), y=sable_wg )) + 
          geom_boxplot(fill="grey90", width=0.5) +
          stat_summary(fun.y=mean, geom="point", shape=16, size=2,col="steelblue")+
          xlab("Year") +
          ylab("Mean weight (kg)") +
          theme(axis.text = element_text(size = 6)) + 
          theme_bw()

    plot_grid(p, p1, p2, labels = "AUTO", nrow = 3)    
  
    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure9.png',sep="")   # -- retrieve png 
              knitr::include_graphics(img)

```
\clearpage

(ref:figure10) Length frequencies for female (grey) and male sablefish (steel blue) up to `r yr` for all StRS sets.  The number of specimens is denoted by the letter n, the mean indicated by the xbar $\overline{x}$ and the standard deviation is represented by the symbol sigma $\Sigma$. 

```{r figure10, fig.cap='(ref:figure10)',results='asis',out.width = "450px",out.height = "354px", fig.align="center"}


      knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")
      #  L E N G T H    H I S T O G R A M  
      #  Sablefish.dbo.procReport_Survey_LenMF pulls length data from table GFBIO_SABLEBIO_VW 
      #  procedure:  Build_BIO_Sablefish_Tables 
   
      png(paste(basepath,'figures/figure10.png', sep=''), width = 700, height = 530)
      
      #par(mfcol=c(2,1), mar=c(4,4,1,1), oma=c(3,2,1,1), cex=1.2)  # -- mar(bottom, left, top, and right)
      par(xpd=NA)  # for placement of A,B
     	a2    <-   hist(females, breaks = brk, plot=F)
    	b2    <-   hist(males,   breaks = brk, plot=F)  # draw the histogram with the specified number of bins
    	
    	plot(b2, col=rgb(0.1,0.1,0.1,0.5), border="white", main="", xlab="Length (cm)", xlim=c(30,100))
    	plot(a2, col=rgb(0.27,.51,.71,0.5), border="white", add = TRUE)
    	box()
    	
      panLab(0.79,0.4,paste("StRS 2003-2020",  sep=""), cex=1.4)  # -- Labels
    	panLab(0.79,0.97,"Sablefish males")
    	panLab(0.19,0.97,"Sablefish females")
    	
    	panLab(0.79,0.9,bquote(bold(n)==.(tm)))
    	panLab(0.19,0.9,bquote(bold(n)==.(tf)))
    	
    	panLab(0.79,0.8,bquote(bolditalic(bar(x))==.(mLm)))
    	panLab(0.19,0.8,bquote(bolditalic(bar(x))==.(mLf)))
    	
    	panLab(0.79,0.7,bquote(bold(sigma)==.(stdm)) )
    	panLab(0.19,0.7,bquote(bold(sigma)==.(stdf)) )
    	
    	 di <- dev.size("in")
       x  <- grconvertX(c(0, di[1]), from="in", to="user")
       y  <- grconvertY(c(0, di[2]), from="in", to="user")
       fig <- par("fig")
       x <- x[1] + (x[2] - x[1]) * fig[1:2]
       y <- y[1] + (y[2] - y[1]) * fig[3:4]
       # txt <- "A"
       # x <- x[1] + strwidth(txt, cex=3) / 2
       # y <- y[2] - strheight(txt, cex=3)/ 2
       # text(x, y, txt, cex=1.5)
       
       while (!is.null(dev.list()))  dev.off()
       img <-    paste(basepath,'figures/figure10.png',sep="")   # -- retrieve png 
              knitr::include_graphics(img)
```

(ref:figure11) Average length and ratios of male and female sablefish by year. Counts by sex are labelled on top of the plotted lines.

```{r figure11, fig.cap='(ref:figure11)',results='asis', out.width = "450px",out.height = "276px", fig.align="center"}

     png(paste(basepath,'figures/figure11.png',sep=''), width = 900, height = 530) # -- starts writing a png to figure folder

     #  Sablefish.dbo.rocRReport_Survey_LenAvg pulls length data from table GFBIO_SABLEBIO_VW from 
     #  procedure:  Build_BIO_Sablefish_Tables
     lenstats  <- "exec procRReport_Survey_LenAvg"
     #dat       <- GetSQLData(lenstats,"Sablefish")                                                  # read from SQL Server
     #write.table(dat, file = paste(path,"figure11.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
     dat       <- read.csv(paste(path,'figure11.csv', sep=''),header=T) # read from csv
     
     fdat      <- dat[dat$sex==2,]    
     mdat      <- dat[dat$sex==1,]   
     MxSeam    <- max(dat$AvL)
    
     plot(fdat$YEAR, fdat$AvL,pch=2, ylim=c(50,MxSeam+5),xlim=c(2003,yr+1), cex=1.3, 
          ylab="Average length (cm)", xlab="Year", cex.lab=1.3, cex.axis = 1.3,
          col="gray30",xaxt="n")
     axis(1, seq(2003,2020,1), cex.axis=1.3)
     lines(fdat$YEAR,fdat$AvL,lwd=1, lty=2, col="gray30") # plot points and lines
     
     points(mdat$YEAR,mdat$AvL,pch=16,col="steelblue") 
     lines(mdat$YEAR, mdat$AvL,lwd=1,lty=1,col="steelblue")

     text(fdat$YEAR, fdat$AvL+1.5, fdat$count,cex=1.3)
     text(mdat$YEAR, mdat$AvL+1.5, mdat$count,cex=1.3)
     text(fdat$YEAR,53,format(mdat$count/fdat$count,digits=1),cex=1.3)
     text(2003.4,51,"M:F ratio",cex=1.3)
     par(usr=c(0,1,0,1))  # set up the plot margins
        
     legend(0.035,1, c("  Sablefish females","  Sablefish males"), 
            lty=c(2,1), lwd=1, bty="n", col=c("gray50","steelblue"), cex=1.3)
     legend(0.025,1, c("",""), pch=c(2,16), bty="n", col=c("gray50","steelblue"))
     panLab(0.79,0.95,paste("StRS 2003-", yr, sep=""), cex=1.3)

     while (!is.null(dev.list()))  dev.off()  
     img <- paste(basepath,'figures/figure11.png',sep='')
            knitr::include_graphics(img)
``` 

(ref:figure12) Sablefish fork length (L in cm) vs weight (W in kg) for females (A) and males (B) for the `r yr` survey.

```{r figure12, fig.cap='(ref:figure12)',results='asis', out.width = "480px", out.height = "282px", fig.align="center"}

    # Sablefish.dbo.procR_Survey_Sablefish_LenWt_shiny queries table GFBIO_SABLEBIO_VW for survey length data	
    png(paste(basepath,'figures/figure12.png',sep=''), width = 700, height = 412) # -- starts writing a png to figure folder
    par(mfcol=c(1,2), mar=c(4,4,1,1), oma=c(2,2,3,1), cex=1.0)  # -- mar(bottom, left, top, and right)
    par(xpd=NA)  # for placement of A,B,C,D

    lenWT     <- "exec procR_Survey_Sablefish_LenWt_shiny"
    #lenWTdat1 <-  GetSQLData(lenWT,"Sablefish")                                                       # read from SQL Server
    #write.table(lenWTdat1, file = paste(path,"figure12.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")    
    lenWTdat1 <- read.csv(paste(path,'figure12.csv',sep=''),header=T) # read from csv
    lenWTdat  <- lenWTdat1[lenWTdat1$YEAR==yr,]

    for (i in c(2,1)) {
         ylim <- c(min(lenWTdat$weight),max(lenWTdat$weight))
         xlim <- c(min(lenWTdat$length),max(lenWTdat$length))    
         lbls <- c(paste(yr,":  Males","",sep=""),paste(yr,":  Females","",sep=""))
   
         t    <- length(lenWTdat$length[lenWTdat$sex==i])                    
         fit1 <- lm(log(weight)~log(length), data=lenWTdat[lenWTdat$sex==i ,])
         a    <- round(exp(fit1$coef[1]),7)
         b    <- round(fit1$coef[2],3)
         Wt   <- (a * (0:xlim[2])^b)  

      plot(jitter(lenWTdat$length[lenWTdat$sex==i],2), 
           jitter(lenWTdat$weight[lenWTdat$sex==i],2), 
           pch=16, col="black", cex=0.5,
           xlab="     Fork length (cm)", ylab="   round weight (kg)", 
           main=paste(lbls[i]), xlim=c(20,100), ylim=c(0,12))      
           lines(0:xlim[2], Wt, col="steelblue", lwd=2) 
           
      mw     <- format(round(mean(lenWTdat$weight[lenWTdat$sex==i],na.rm=T),1),nsmall=1)
      par(usr=c(0,1,0,1))
      text(0.3,0.9, bquote(bold(n)==.(t)))   # -- number
      text(0.3,0.8, bquote(bolditalic(bar(W))==.(mw))) # -- mean weight
      text(0.33,0.7,bquote(bold(a)==.(a)))  # -- a
      text(0.32,0.6,bquote(bold(b)==.(b)))  # -- b
      
      letter <- c("B","A")
      di <- dev.size("in")
      x  <- grconvertX(c(0, di[1]), from="in", to="user")
      y  <- grconvertY(c(0, di[2]), from="in", to="user")
      fig <- par("fig")
      x <- x[1] + (x[2] - x[1]) * fig[1:2]
      y <- y[1] + (y[2] - y[1]) * fig[3:4]
      txt <- letter[i]
      x <- x[1] + strwidth(txt, cex=3) / 2
      y <- y[2] - strheight(txt, cex=3) *2
      text(x, y, txt, cex=1.5)
    }
    

   while (!is.null(dev.list()))  dev.off() 
   
   img <- paste(basepath,'figures/figure12.png',sep='')
          knitr::include_graphics(img)
          
```
(ref:figure13) The percentage of sub-legal sablefish (<55 cm fork length) sampled by area (S~1~-S~5~) and depth strata (S=shallow, RD~1~; M=mid, RD~2~; D=deep, RD~3~) over time. Sub-legal specimen count above 50% sampled shown in blue.

```{r figure13, fig.cap='(ref:figure13)',results='asis', out.width = "450px",out.height = "500px", fig.align="center"}

  png(paste(basepath,'figures/figure13.png',sep=''), width = 600, height = 650) 
  sqlpolar  <-  paste( " select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, ",
                       " round(countSub / total * 100, 1) as subL, ",
                       " round(countLeg / total * 100, 1) AS Leg, combo, ",
                       " combo + cast(YEAR as varchar) as combo2, ",
                       " (cast(right(sable_area_group,1) as int) + ", 
                       " cast(right(sable_area_group,1) as int) + cast(right(sable_depth_group,1) as int) + ", 
                       " cast(right(sable_area_group,1)  as int)-4 )  as polarorder ",
                       " from   ", 
                       " (select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, ",
                       " sum(NULLIF (subl, 0.0)) as countSub, ",
                       " sum(NULLIF (leg, 0.0)) AS countLeg, sum(subl) + sum(leg) as total, ",
                       " SABLE_AREA_GROUP + SABLE_DEPTH_GROUP as combo ",
                       " from (select YEAR, SABLEFISH_SURVEY_IND, SABLE_AREA_GROUP, ",
                       " SABLE_DEPTH_GROUP, SPECIMEN_ID, SPECIMEN_SEX_CODE,  ",  
                       " case when Fork_Length <= 550 then 1.0 ELSE 0.0 END as subl, ",
                       " CASE when Fork_Length > 550 THEN 1.0 ELSE 0.0 END as leg  ",
                       " from dbo.GFBIO_SABLEBIO_VW where (SABLEFISH_SURVEY_IND = 1) and  ",
                       " (SABLE_AREA_GROUP IN (N's1', N's2', N's3', N's4', N's5')) ) as LS ",
                       " group by SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, YEAR ) as LS1 ",
                       " order by YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP")

  polarsumm <-   paste( " select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP from ",
                        " (select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP,  ",
                        " sum(NULLIF (subl, 0.0)) as countSub, sum(NULLIF (leg, 0.0)) as countLeg, ",
                        " sum(subl) + sum(leg) as total,  ",
                        " SABLE_AREA_GROUP + SABLE_DEPTH_GROUP as combo ",
                        " from (select YEAR, SABLEFISH_SURVEY_IND, SABLE_AREA_GROUP, ",
                        " SABLE_DEPTH_GROUP, SPECIMEN_ID, SPECIMEN_SEX_CODE, ",
                        " case WHEN Fork_Length <= 550 THEN 1.0 ELSE 0.0 END as subl, ",
                        " case WHEN Fork_Length > 550 THEN 1.0 ELSE 0.0 END as leg ",
                        " from dbo.GFBIO_SABLEBIO_VW ",
                        " where (SABLEFISH_SURVEY_IND = 1) AND ",
                        " (SABLE_AREA_GROUP IN (N's1', N's2', N's3', N's4', N's5'))) as LS ",
                        " group by SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, YEAR) as LS1 ",
                        " where (round(countSub / total * 100, 1) > 50)  ",
                        " group by YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP ",
                        " order by YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP")

   #polar        <- GetSQLData(sqlpolar ,"Sablefish")     # read from SQL Server
   #polarsummary <- GetSQLData(polarsumm ,"Sablefish")   # view the results to be able to type into the summary
   #write.table(polar,        file = paste(path,"figure16a.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   #write.table(polarsummary, file = paste(path,"figure16b.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   
   polar        <-  read.csv(paste(path,'figure13a.csv', sep=''),header=T)        # read from csv
   polarsummary <-  read.csv(paste(path,'figure13b.csv', sep=''),header=T)
   polar$cat    <-  ifelse(polar$subL>=50,">50%","<50%")  # identify sublegal counts below and above 50 %
   
   linea<-25.0
   lineb<-50.0
   linec<-75.0
  
   sublabel    <- (c("S1S","S1M","S1D",
                     "S2S","S2M","S3D",
                     "S3S","S3M","S3D",
                     "S4S","S4M","S4D",
                     "S5S","S5M","S5D"))
 
    polar.dat  <-  polar[polar$YEAR>=2014,]
    ggplot(polar.dat, aes(polarorder, subL, fill = cat)) + 
           geom_bar(stat = "identity") + 
           theme_minimal() +
           scale_fill_manual(values=c("gray50","steelblue")) +  
           xlab('') +
           ylab('') + 
           theme(axis.text.y=element_blank()) +
           theme(legend.title = element_blank())        + 
           theme(axis.text.x = element_text(size = 10))  +
           coord_polar(start=-48/360) +   # where to start the polar bars
           scale_x_continuous(limits=c(-0.5,14.5), breaks=0:14,  labels= sublabel) +
           geom_hline(aes(yintercept=linea), colour="red", linetype="dashed",size = 0.5) +  
           geom_hline(aes(yintercept=lineb), colour="red", linetype="dashed",size = 0.5) +
           geom_hline(aes(yintercept=linec), colour="red", linetype="dashed",size = 0.5) +
           geom_text(data=polar.dat, aes( x=0, y=25, label='25'), color="black",   size=4  ) +
           geom_text(data=polar.dat, aes( x=0, y=50, label='50'), color="black",   size=4  ) +
           geom_text(data=polar.dat, aes( x=0, y=75, label='75'), color="black",   size=4  ) +
           facet_wrap(~YEAR, nrow=3, ncol=3) +
                      theme(strip.text.x = element_text(size=12))

  while (!is.null(dev.list()))  dev.off()  
    img <-   paste(basepath,'figures/figure13.png',sep='')   # retrieve png from figures folder
             knitr::include_graphics(img)
```
\clearpage


(ref:figure14) Bubble plot for female (A) and male (B) sablefish ages by survey year from StRS sets that have been aged.  The sizes of the circles are proportional to the number of fish with given ages. Fish age 35 and older are included in one bubble. The total number(n) of fish aged are listed across the top of each panel. The ages with the highest ratios are posted to the right of each bubble.

```{r figure14, fig.cap='(ref:figure14)',results='asis', out.width = "500px",out.height = "577px", fig.align="center"}

   # dt  <-  ("exec procRReport_Survey_proportions_at_age")  run this procedure to create table first.
   # sql server procedure:  procRReport_Survey_proportions_at_age which pulls age data from 
   # GFBIOSQL.dbo.b21_samples and b22_specimens

   png(paste(basepath,'figures/figure14.png',sep=''), width = 800, height = 924)  # -- starts writing a png to figure folder

   dt   <-  paste("select * from Report_Survey_GFBIO_Age_MF_Prop where SetType='StRS' and Year<=", yr, sep="")
   #dat  <-  GetSQLData(dt,"Sablefish")                                                            # read from SQL Server
   #write.table(dat, file = paste(path,'figure14.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   dat  <-  read.csv(paste(path,'figure14.csv',sep=''),header=T) # read from csv

   par(mfrow=c(2,1),cex=1.1)     # -- two vertical plots
   par(xpd=NA)
   
   involve  <-  c()
   involve  <-  unique(dat$Year)
   maxyr    <-  max(involve)
   minyr    <-  min(involve)

   #  plot bubbles for female ages
   plot(dat$Year, dat$Age, type="n",
        xlab=" Year", ylab="", main="Females", 
        ylim=c(0,42), xlim=c(minyr,maxyr),xaxt="n")
        axis(1, seq(2003,2018,1))            
        symbols(dat$Year, dat$Age, 
                circles=pi*(dat$Female_Proportion),
                inches=0.3, add=T,col="light grey")

   for (femaleyr in involve)  # display totals across top
    {
    h <- unique(dat$Female_Yr_Total[dat$Year==femaleyr])
    text(femaleyr + 0.15, 40, bquote(.(h)))   
    text(femaleyr + 0.15, dat$Age[dat$f==1 & dat$Year==femaleyr],
         dat$Age[dat$f==1 & dat$Year==femaleyr],
         col="red",cex=1.1, font=2)
    }

    mtext(paste("Age","",sep=""), SOUTH<-2,  
          line=-1, adj=0.5, cex=1.2,  outer=TRUE)  # outside label
    
    di <- dev.size("in")
    x  <- grconvertX(c(0, di[1]), from="in", to="user")
    y  <- grconvertY(c(0, di[2]), from="in", to="user")
    fig <- par("fig")
    x <- x[1] + (x[2] - x[1]) * fig[1:2]
    y <- y[1] + (y[2] - y[1]) * fig[3:4]
    txt <- "A"   # label A
    x <- x[1] + strwidth(txt, cex=3) / 2
    y <- y[2] - strheight(txt, cex=3) / 2
    text(x, y, txt, cex=1.5)
    
       # plot bubbles for male ages
   plot(dat$Year, dat$Age, type="n", 
        xlab=" Year", ylab="", main="Males", 
        ylim=c(0,42), xlim=c(minyr,maxyr),
        xaxt="n")
        axis(1, seq(2003,2018,1))      
        symbols(dat$Year, dat$Age, 
                circles=pi*(dat$Male_Proportion),
                inches=0.3, add=T, col="light grey")

   for (maleyr in involve){
        h  <-  unique(dat$Male_Yr_Total[dat$Year==maleyr])
        text(maleyr + 0.15, 40, bquote(.(h)))    
        text(maleyr + 0.35, dat$Age[dat$m==1 & dat$Year==maleyr],
             dat$Age[dat$m==1 & dat$Year==maleyr],
             col="red",cex=1.1, font=2)}
   
        di <- dev.size("in")
        x  <- grconvertX(c(0, di[1]), from="in", to="user")
        y  <- grconvertY(c(0, di[2]), from="in", to="user")
        fig <- par("fig")
        x <- x[1] + (x[2] - x[1]) * fig[1:2]
        y <- y[1] + (y[2] - y[1]) * fig[3:4]
        txt <- "B"  # label B
        x <- x[1] + strwidth(txt, cex=3) / 2
        y <- y[2] - strheight(txt, cex=3) * 2
        text(x, y, txt, cex=1.5)
   
    while (!is.null(dev.list()))  dev.off()  
    img <-   paste(basepath,'figures/figure14.png',sep='')   # retrieve png 
             knitr::include_graphics(img)
```
\clearpage
(ref:figure15) Coplot of average depth (m) vs average temperature ($^\circ$C) for a given 1-degree latitude range (blue bands) for `r yr`.  The number of fishing sets deployed with a SBE 39 recorder are represented by n.

```{r figure15, fig.cap='(ref:figure15)',results='asis', out.width = "500px",out.height = "335px", fig.align="center"}

      png(paste(basepath,'figures/figure15.png',sep=''), width=920, height=424) # write png to file
      # table SEABIRD_ReportCoplot created in the Sablefish.dbo.Build_Seabird_tables procedure
      sbecp     <- paste("select * from SEABIRD_ReportCoplot where Year in(",yr,")",sep="")
      #ctddat    <- GetSQLData(sbecp,"Sablefish")   # read from SQL Server
      #write.table(ctddat, file = paste(path,"figure15.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")      
      ctddat    <- read.csv(paste(path,'figure15.csv',sep=''),header=T)  # read from csv

      par(mar=c(1,1,1,1.4),cex=1.5,cex.lab=1.5, cex.axis=1.5, cex.main=1.5, cex.sub=1.5)   # par(mar=c(bottom,left,top,right) 
      yrdat     <-  ctddat[ctddat$Year==yr,]
      given.lat <-  matrix(c(48,48,49,49,50,50,51,51,52,52,53,53,54,54), 
                           nrow = 7, ncol=2, byrow=TRUE)
      
      coplot(temperature  ~ depth| lat, data = yrdat, 
             pch = 21, bg = "lightblue", col = "#0073C2FF",
             xlim=c(200,1400), 
             ylim=c(2,10),
             given.v = given.lat,
             show.given=FALSE, rows=1, cex=3.0, 
             xlab=c("Average Depth (m)",""),  
             ylab= expression(Average~Temperature~degree~C))

             n48 <- length(unique(yrdat$Sets[yrdat$lat == 48]))  # count number of sets in lat band
             n49 <- length(unique(yrdat$Sets[yrdat$lat == 49]))
             n50 <- length(unique(yrdat$Sets[yrdat$lat == 50]))
             n51 <- length(unique(yrdat$Sets[yrdat$lat == 51]))
             n52 <- length(unique(yrdat$Sets[yrdat$lat == 52]))
             n53 <- length(unique(yrdat$Sets[yrdat$lat == 53]))
             n54 <- length(unique(yrdat$Sets[yrdat$lat == 54]))

      labels   <-   c(n48,n49,n50,n51,n52,n53,n54)
      for(j in 1:7) 
         { text((280*j)-(100*(j-1)),8,paste("n=",labels[j],sep=""))  } 
      
      text(1350, 9, yr, font=2)  # make year bold = 2
      while (!is.null(dev.list()))  dev.off()

      require('magick')   # in order to stack images
      uno <- image_read(paste(basepath,'figures/CoPlotTopMain.png', sep='')) # Read external images
      one <- image_read(paste(basepath,'figures/figure15.png', sep=''))
      imgs = c(uno, one)
     
      # concatenate pngs left-to-right (use 'stack=T' to do it top-to-bottom)
      side_by_side = image_append(imgs, stack=T)
      image_write(side_by_side, path = paste(basepath,'figures/figure15.png',sep=''), format = "png")  # save png

      img <-   paste(basepath,'figures/figure15.png',sep='')   # retrieve png 
               knitr::include_graphics(img)

```
\clearpage

(ref:figure16) Vertical density ridgeplots of mean temperatures per year as reported by set from the Sea-bird SBE 39 loggers on traps at three depth intervals, RD~1~ = shallow (100-450 m), RD~2~ = mid (450-850 m), RD~3~ = deep (850-1400 m). Lines indicate the 2.5% and 97.5% tails.

```{r figure16, fig.cap='(ref:figure16)', results='asis', out.width = "480px",out.height = "616px", fig.align = "center"}

      # table SEABIRD_ReportLinePlot created  by Sablefish.dbo.Build_Seabird_tables procedure
    
      png(paste(basepath,'figures/figure16.png',sep=''), width=600, height=770) # write png to file
      sea.bird     <-  "select * from SEABIRD_AverageTempPerSet where depth_stratum in('RD1','RD2','RD3')"
      #sea.bird.ridge    <-  GetSQLData(sea.bird,"Sablefish")   # read from SQL Server
      #write.table(sea.bird.ridge, file = paste(path,"figure16.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
      sea.bird.ridge    <-  read.csv(paste(path,'figure16.csv',sep=''),header=T)  # read from csv
      weather.raw2 <-    sea.bird.ridge[order(- sea.bird.ridge$Year,  sea.bird.ridge$Sets),]
      weather.raw2$years<-factor(weather.raw2$Year,levels=rev(unique(weather.raw2$Year)))
      names(weather.raw2) <- c("Year", "trip", "Sets", "Avgtemp", "Mintemp","Maxtemp", "Depth Stratum",  "lat", "years") 
      
      library(ggridges)
      
      #Median temperatures by year
      ggplot(weather.raw2, aes(x = Avgtemp, y = years, fill=`Depth Stratum`, alpha = 0.4)) +
             scale_x_continuous(limits = c(1.5,8.5)) +

             geom_density_ridges(
                aes(point_shape = `Depth Stratum`, alpha = 0.7), 
                alpha = .5, point_alpha = .8, jittered_points = TRUE
               ) +
             stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.6) +
             xlab("Mean Temperature °C") +
             ylab("Year") +
             theme_bw()
       
       while (!is.null(dev.list()))  dev.off()
       img <-   paste(basepath,'figures/figure16.png',sep='')   # retrieve png 
                knitr::include_graphics(img)

```
\clearpage



<!--chapter:end:04_figures.Rmd-->

<!-- The following code should appear at the beginning of the first appendix.
(if you have one)
After that, all subsequent sections will be turned into appendices. -->

`r if(knitr:::is_latex_output()) '% begin csasdown appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

\clearpage

# LIST OF SABLEFISH RESEARCH AND ASSESSMENT SURVEYS. {#app:first-appendix}

```{r appendixA, results="asis"}

   dtBW   <- paste('exec dbo.procRKnitr_SurveyTrips ', yr ,sep='')
   #trip   <- GetSQLData(dtBW,"Sablefish")
   #write.table(trip, file = paste(path,'appendixA.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   trip   <-  read.csv(paste(path,'appendixA.csv',sep=''),header=T)
   
   colnames(trip) <- c("Year", "Dates",  "Vessel", "Captain", "Set Count", "GFBIO Id")
   kableExtra::kable(trip,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     format = "latex")  %>%
   kableExtra::kable_styling(font_size = 8) %>% 
                     row_spec(0, bold = T)

```

\clearpage

# DATA FORMS OF THE 2020 SABLEFISH SURVEY. {#app:second-appendix}

```{r appendixB,out.width = "480px", out.height = "406px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper bridge log
         img <-  paste(basepath,'figures/AppendixB_BridgeLogIns3.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.1. Example of a completed bridge log data form with directions from the 2020 survey instruction manual.

\clearpage

```{r AppendixB2,out.width = "500px", out.height = "420px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper set log
         img <-  paste(basepath,'figures/AppendixB_SetLogIns3.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.2.  Example of a completed set log data form with directions from the 2020 survey instruction manual.

\clearpage

```{r AppendixB3,out.width = "500px", out.height = "476px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper catch log
         img <-  paste(basepath,'figures/AppendixB_CatchLogIns3.png',sep='')
      knitr::include_graphics(img) 
      
```
Figure B.3.  Example of a completed catch log data form with directions from the 2020 survey instruction manual.
\clearpage

```{r AppendixB4,out.width = "500px", out.height = "426px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper tabular catch log
         img <-  paste(basepath,'figures/AppendixB_CatchLogTabIns3.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.4.  Example of a tabular catch log data entry form transposed from the catch log in Figure B.3. Directions from the 2020 survey instruction manual. 

\clearpage

```{r AppendixB5,out.width = "480px", out.height = "588px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper LSWMO log
         img <-  paste(basepath,'figures/AppendixB_LSWMOIns3.png',sep="")
      knitr::include_graphics(img) 
      
```
Figure B.5.  Example of a completed Sablefish biological sampling form and directions from the 2020 survey instruction manual. 

\clearpage

```{r AppendixB6,out.width = "500px", out.height = "501px", fig.align="left"}

      if(knitr:::is_latex_output())
         # paper tagging sheet
         img <-  paste(basepath,'figures/AppendixB_TaggingSheetIns3.png',sep="")
      knitr::include_graphics(img) 
      
```


Figure B.6.  Example of a completed tagging form with directions from the 2020 survey instruction manual.

\clearpage

# SURVEY SET DETAILS `r yr`. {#app:third-appendix}
Details of sets completed during the `r yr` survey program (F/V `r boat`).  Sets are listed by stratum/inlet name, set type, depth stratum, start date, end of gear deployment time and duration in minutes. The depth strata for type 3 tagging sets include RD~1~ (100-250 fathoms), RD~2~ (250-450 fathoms) and RD~3~ (450-750 fathoms). The position data includes the major area and start and end latitude and longitude in degrees decimal minutes. The bottom depths (in meters) of the fishing set are shown with the mean bottom depth calculated from recordings at one minute intervals between the start and end of the set. The number of traps fished for each set excludes open traps, while holed or fouled traps have been included.  Sets that successfully deployed a Seabird SBE temperature and pressure recorder are indicated with an 'x'. 


```{r appendixC, results="asis"}
   library(kableExtra)
   yr <- 2020
   options(knitr.kable.NA = '')  # get rid of NAs
   srvyset  <-  paste('dbo.procRReport_Survey_SetDetails ',yr,',1,',setcnt, sep='')
   #srvy.set   <-  GetSQLData(srvyset,"Sablefish")
   #write.table(srvy.set, file = paste(path,'AppendixC.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   srvy.set <-  read.csv(paste(path,'AppendixC.csv',sep=''),header=T)
   
   latcnt  <-  length(srvy.set[, 9])  # add degree symbol in lat and long values
               for (i in 1:latcnt)
                      { srvy.set[i,9]= paste(srvy.set[i,9],'° ', srvy.set[i,10],"'N",sep="")  }
   latcnt  <-  length(srvy.set[,11])
               for (i in 1:latcnt)
                      { srvy.set[i,11]=paste(srvy.set[i,11],'° ', srvy.set[i,12],"'W",sep="") }
   latcnt  <-  length(srvy.set[,13])
               for (i in 1:latcnt)
                      { srvy.set[i,13]=paste(srvy.set[i,13],'° ', srvy.set[i,14],"'N",sep="") }
   latcnt<-length(srvy.set[,15])
               for (i in 1:latcnt)
                      { srvy.set[i,15]=paste(srvy.set[i,15],'° ', srvy.set[i,16],"'W",sep="") }
   
   srvy.set  <-  srvy.set[,c(-22,-23,-24)]  # no hobo, ctd or camera columns needed 2020
   srvy.set  <-  srvy.set[,c(-10,-12,-14,-16)]  
   
   colnames(srvy.set) <- c("Spatial Stratum", "Set", "Type",      
                           "Depth Stratum",   "Date", "Time", 
                           "Duration (minutes)",  "Area", 
                           "Start Latitude",  "Start Longitude", 
                           "End Latitude",    "End Longitude", 
                           "Start Depth (m)", "End Depth (m)", "Mean Depth (m)", 
                           "Traps Fished",    "SBE 39")
 
   kableExtra::kable(srvy.set,
                    booktabs  = TRUE, 
                    longtable = T,
                    linesep   = "",
                    escape = F,
                    format    = "latex") %>%
   kableExtra::kable_styling(font_size = 8, latex_options = "repeat_header",
               repeat_header_text = "continued.", 
               repeat_header_method = "replace") %>%
   kableExtra::landscape() %>%
    
   row_spec(0, bold = T)  %>%     
   column_spec(1,width    = "0.7cm") %>%  # stratum
   column_spec(2,width    = "0.5cm") %>%  # set
   column_spec(3,width    = "0.4cm") %>%  # type 
   column_spec(4,width    = "0.7cm") %>%  # depth stratum
   column_spec(5,width    = "0.9cm") %>%  # date
   column_spec(6,width    = "0.6cm") %>%  # time      
   column_spec(7,width    = "0.9cm") %>%  # dur
   column_spec(8,width    = "0.5cm") %>%  # area   
   column_spec(9,width    = "1.2cm") %>%  # start lat
   column_spec(10,width   = "1.7cm") %>%  # start long
   column_spec(11,width   = "1.2cm") %>%  # end lat
   column_spec(12,width   = "1.7cm") %>%  # end long
   column_spec(13,width   = "0.7cm") %>%  # start dep
   column_spec(14,width   = "0.7cm") %>%  # end dep    
   column_spec(15,width   = "0.5cm") %>%  # mean dep
   column_spec(16,width   = "0.6cm") %>%  # tf
   column_spec(17,width   = "0.4cm") %>%  # sbe
   sub("\\caption\\[\\]\\{\\}", "\\caption*{}", .)
``` 

\clearpage


# SUMMARY OF BASKET USE BY TRAP `r yr`.{#app:fourth-appendix} 

Summary of the basket use by trap number for StRS sets during the `r yr` sablefish survey. The fate of the sablefish catch for each set and trap is indicated using the following abbreviations: D = Discarded after weighing (processed as commercial catch), A = Sampled for LSMWO, T = Tagged and released, SD = Sublegal discarded, F= Frames, NULL = No sablefish catch/Trap missing. 

```{r appendixD, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}

   # Sablefish.dbo.procRReport_Survey_TrapUse procedure pulls 
   # data from table dbo.GFBIO_TRAPS_USE  
   # created by procedure Sablefish.dbo.Build_BIO_Sablefish_Tables
   options(knitr.kable.NA = '')
   trap       <- paste("dbo.procRReport_Survey_TrapUse ",yr,",1,",setcnt, sep="")
   #trapdat    <- GetSQLData(trap,"Sablefish")
   #write.table(trapdat, file = paste(path,'appendixD.csv',sep=''),row.names=FALSE,na="",col.names=TRUE,sep=",")    
   trapdat    <- read.csv(paste(path,'appendixD.csv',sep=''),header=T)
   trapuse    <- trapdat[,c(-1)] 
   trapuse2   <- trapuse[,c(-27,-28)]
   
   kableExtra::kable(trapuse2,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     format = "latex")   %>%
      
   kableExtra::kable_styling(font_size = 6, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%  
      
   kableExtra::landscape()  %>%
       #row_spec(38:52, color="blue"  ) %>%  no visits to inlets in 2020 
       row_spec(0, bold=T) %>%
       column_spec(1,width      = "0.3cm") %>%
       column_spec(2,width      = "0.3cm") %>%
       column_spec(3,width      = "0.3cm") %>%
       column_spec(4,width      = "0.3cm") %>%
       column_spec(5,width      = "0.3cm") %>%
       column_spec(6,width      = "0.3cm") %>%
       column_spec(7,width      = "0.3cm") %>%
       column_spec(8,width      = "0.3cm") %>%   
       column_spec(9,width      = "0.3cm") %>%   
       column_spec(10,width     = "0.3cm") %>%
       column_spec(11,width     = "0.4cm") %>%
       column_spec(12,width     = "0.4cm") %>%
       column_spec(13,width     = "0.4cm") %>%
       column_spec(14,width     = "0.4cm") %>%
       column_spec(15,width     = "0.4cm") %>%
       column_spec(16,width     = "0.4cm") %>%
       column_spec(17,width     = "0.4cm") %>%
       column_spec(18,width     = "0.4cm") %>%
       column_spec(19,width     = "0.4cm") %>%
       column_spec(20,width     = "0.4cm") %>%
       column_spec(21,width     = "0.4cm") %>%  
       column_spec(22,width     = "0.4cm") %>% 
       column_spec(23,width     = "0.4cm") %>%       
       column_spec(24,width     = "0.4cm") %>% 
       column_spec(25,width     = "0.4cm") %>%
       column_spec(26,width     = "0.4cm") %>%      
       column_spec(27,width     = "0.4cm") %>%  
       column_spec(28,width     = "0.4cm") 
```

\clearpage

```{r appendixESetUp, warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
library(knitr)
library(dplyr)
library(pander)
library(ggplot2)


    trap.count <-paste("select tp.YEAR, fe.TRIP_ID, fe.FE_MAJOR_LEVEL_ID AS SET_ID, fe.FE_SUB_LEVEL_ID AS BECKET, ", 
                       "fe.FE_MINOR_LEVEL_ID AS TRAP, SUM(c.CATCH_COUNT) AS total_count ",
                       "from dbo.GFBIO_TRAP_VW_VW AS fe INNER JOIN ",
                       "(select YEAR, TRIP_ID from dbo.SURVEY_trips_vw ",
                       " group by YEAR, TRIP_ID) AS tp ON fe.TRIP_ID = tp.TRIP_ID LEFT OUTER JOIN ",
                       " GFBioSQL.dbo.TRAP_SPECS AS ts ON fe.FISHING_EVENT_ID = ts.FISHING_EVENT_ID LEFT OUTER JOIN ",
                       " (select FISHING_EVENT_ID, SUM(CASE WHEN BAIT_LURE_CODE = 15 AND BAIT_METHOD_CODE = 4  ",
                       " then TRPBL_BAIT_AMOUNT ELSE NULL END) AS BAGGED_SQUID, SUM(CASE WHEN BAIT_LURE_CODE = 18 and  ", 
                       " BAIT_METHOD_CODE = 6 THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS LOOSE_HAKE,  ",
                       " SUM(CASE WHEN (BAIT_LURE_CODE <> 15 AND BAIT_METHOD_CODE <> 4) AND (BAIT_LURE_CODE <> 18 AND  ",
                       " BAIT_METHOD_CODE <> 6) THEN TRPBL_BAIT_AMOUNT ELSE NULL END) AS OTHER_BAIT ",
                       " from GFBioSQL.dbo.TRAP_BAIT_LURE ",
                       " group by FISHING_EVENT_ID) AS bait ON fe.FISHING_EVENT_ID = bait.FISHING_EVENT_ID  ",
                       " LEFT OUTER JOIN ",
                       " (select fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE,  ",
                       " SUM(GFBioSQL.dbo.CATCH.CATCH_WEIGHT) AS CATCH_WEIGHT, SUM(GFBioSQL.dbo.CATCH.CATCH_COUNT) AS CATCH_COUNT,  ",
                       " AVG(ISNULL(GFBioSQL.dbo.CATCH.CATCH_VERIFICATION_CODE, 0)) AS VERIFICATION_METHOD ",
                       " from GFBioSQL.dbo.FISHING_EVENT_CATCH AS fec INNER JOIN ",
                       " GFBioSQL.dbo.CATCH ON fec.CATCH_ID = GFBioSQL.dbo.CATCH.CATCH_ID ",
                       " where (GFBioSQL.dbo.CATCH.SPECIES_CODE = '455') ",
                       " GROUP BY fec.FISHING_EVENT_ID, GFBioSQL.dbo.CATCH.SPECIES_CODE) AS c ON fe.FISHING_EVENT_ID = c.FISHING_EVENT_ID ",
                       " GROUP BY fe.FE_MAJOR_LEVEL_ID, fe.TRIP_ID, tp.YEAR, fe.FE_SUB_LEVEL_ID, fe.FE_MINOR_LEVEL_ID",
                       " having  (tp.YEAR IN ('2020')) order by SET_ID, BECKET, TRAP",sep="")
    
   #trap.sable1   <- GetSQLData(trap.count,"Sablefish")
   #write.table(trap.sable1, file = paste(path,"appendixESetUp.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")
   trap.sable1  <-  read.csv(paste(path,'appendixESetUp.csv',sep=''), header=T)


   library(tidyverse)
   library(tidyr)
   library(scales)
   
   trap.sable <- trap.sable1[,c(-1,-2,-4)] 
   #trap.sable$SET_ID <- as.factor(trap.sable$SET_ID)
   names(trap.sable) <- c("SurveySet","Trap","Value")
   trap.sable[is.na(trap.sable)] <- 0

   #  trap.sableTest  <-  trap.sable[trap.sable$SurveySet == 40,] 
   big.value <- max(trap.sable$Value)

   w<-trap.sable %>%
     group_by(SurveySet) %>%
     do({
       p <- ggplot(., aes(x = Trap, y = Value)) + 
         geom_area( fill="#6495ED", alpha=0.4) +   #6495ED
         geom_line(size = 4, color = "blue") +      
         #geom_point(size=15, color="red") + 
         ylim(0, big.value) +
         xlim(0,25) +
         theme_void() 
         #stat_summary(fun.y = max, colour = "red", geom = "point", size = 5)
       ggsave(p, filename = paste0("fig", unique(.$SurveySet), ".png"), width = 8, height = 2)  # save time comment out
       invisible(.) 
       
     })


```

# SUMMARY OF SABLEFISH BIOLOGICAL DATA `r yr`. {#app:fifth-appendix} 
Biological data collected for sablefish by set, catch weight in kilograms and numbers of fish.  Sablefish counts by trap are represented by sparklines. Tagged fish counts by number for recovered, re-released, deceased and those released for the first time. Tagged fish fork lengths are presented by count and mean (millimeters). Specimen counts are listed by sample type; mean fork lengths are tabulated.  


```{r appendixE, echo=FALSE}

   #  Sablefish.dbo.procReport_Survey_SampleDetails pulls data 
   #  from table GFBIO_RESEARCH_SAMPLE_DETAILS, built by     
   #  procedure Sablefish.dbo.Build_BIO_Sablefish_Tables 
   # \renewcommand{\arraystretch}{1} # use above r code to stretch table

   samples           <-  paste("dbo.procReport_Survey_SampleDetails ",yr,",1,",setcnt, sep="")
   #surveyspec        <-  GetSQLData(samples,"Sablefish")
   #write.table(surveyspec, file = paste(path,'appendixE.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")  
   surveyspec        <-  read.csv(paste(path,'appendixE.csv',sep=''),header=T)
   count.row.total   <-  length(surveyspec$SET)
   count.row         <-  length(surveyspec$SET) - 1
   surveyspec$SET[count.row.total] <- "Total"
   
   surveyspec <-  surveyspec %>%
                  mutate(Sparkline = paste0("\\raisebox{.12\\height} {\\includegraphics[width=2cm]{fig",SET,".png}}") ) 
   
   colnames(surveyspec) <- c("", "kg","Count","Recover-Rerelease", "Deceased", "Released", 
                             "Count", "Mean", "Fork Length", "Sex","Maturity", "Otoliths",
                             "Weight","Count","Proportion Males", "Males", "Females", "Count by Trap")
   
   surveyspec <-  surveyspec[, c(1, 2, 3, 18, 4,5,6,7,8,9,10,11,12,13,14,15,16,17)]  #reorder table
   
   colnames(surveyspec) <- c("", "kg","Count","Count by Trap","Recover-Rerelease", "Deceased", "Released", 
                             "Count", "Mean", "Fork Length", "Sex","Maturity", "Otoliths",
                             "Weight","Count","Proportion Males", "Males", "Females" )

   kableExtra::kable(surveyspec,
                     booktabs = TRUE,     
                     longtable = T,
                     escape = F,        # lets the image show up 
                     linesep   = "",
                     align=rep('r', 18),
                     format = "latex") %>%
      
   add_header_above(c("Set"= 1,
                      "Total Catch" = 3, 
                      "Tagged Fish Counts" = 3,  
                      "Tagged Fork Lengths(mm)" = 2,
                      "Specimen Count"= 6, 
                      "Mean Fork Length(mm)" = 3), bold = TRUE) %>%
      
   kableExtra::kable_styling(font_size = 8, 
                     latex_options = "repeat_header",
                     repeat_header_text = "continued.", 
                     repeat_header_method = "replace") %>%     
   
   kableExtra::landscape()  %>%
   row_spec(0, bold = T)  %>%   
   column_spec(1,width    = "0.3cm") %>%  # set
   column_spec(2,width    = "0.6cm") %>%  # kg
   column_spec(3,width    = "0.7cm") %>%  # count
   column_spec(4,width    = "1.4cm") %>%  # sparkline      
   column_spec(5,width    = "0.9cm") %>%  # rr
   column_spec(6,width    = "1.0cm") %>%  # decease
   column_spec(7,width    = "0.9cm") %>%  # rel     
   column_spec(8,width    = "1.5cm") %>%  # count
   column_spec(9,width    = "0.9cm") %>%  # mean
   column_spec(10,width   = "0.7cm") %>%  # fl
   column_spec(11,width   = "0.6cm") %>%  # sex
   column_spec(12,width   = "0.7cm") %>%  # mat
   column_spec(13,width   = "0.7cm") %>%  # oto 
   column_spec(14,width   = "0.6cm") %>%  # wt
   column_spec(15,width   = "0.6cm") %>%  # cnt
   column_spec(16,width   = "1.1cm") %>%  # prop m
   column_spec(17,width   = "0.7cm") %>%  # male         
   column_spec(18,width   = "0.7cm") %>%  # fem
   row_spec(count.row.total, bold = T)  %>%    
   row_spec(count.row,  hline_after = T)

```
\clearpage

# SUMMARY OF BIOLOGICAL DATA FOR ROUGHEYE/BLACKSPOTTED ROCKFISH COMPLEX. {#app:sixth-appendix} 
Biological data collected for rougheye/blackspotted rockfish complex.  Each set is listed with counts of specimens sampled, calculations of mean fork lengths and number of species visually identified as either a RE = rougheye rockfish, BS = blackspotted rockfish or a hybrid.
\ \
\ \

```{r appendixF, echo=FALSE}
 
   othersamples <-  paste( "select species_name, [SET], [Len Sample Count], ",
                           "[weight_count], [Sex Sample Count], ",
                           "[Maturity Sample Count], [Otolith Sample Count], [DNA Sample Count], ",
                           "Sample_count, [Proportion Males],  ",   
                           "round([Male Mean Fork Len(mm)],0) as malelen, ",
                           "round([Female Mean Fork Len(mm)],0) as femlen,  ", 
                           "round([NoSexMeanLen(mm)],0) as nosexlen, ", 
                           "bsre.Rougheye, bsre.Blackspotted, bsre.Hybrid ",
                           "from  ",
                           "(select year, TRIP_ID, FE_MAJOR_LEVEL_ID, SPECIES_CODE, ",
                           "SUM(re) AS Rougheye, SUM(bs) AS Blackspotted, SUM(hyb) AS Hybrid ",
                           "from  (select year, TRIP_ID, FE_MAJOR_LEVEL_ID, SPECIES_CODE, ",
                           "CASE WHEN EXISTENCE_ATTRIBUTE_CODE = 16 THEN 1 ELSE 0 END AS re, ",
                           "CASE WHEN EXISTENCE_ATTRIBUTE_CODE = 17 THEN 1 ELSE 0 END AS bs, ",
                           "CASE WHEN EXISTENCE_ATTRIBUTE_CODE = 31 THEN 1 ELSE 0 END AS hyb, ",
                           "SPECIMEN_ID ",
                           "from dbo.gfbio_species_guess) AS bs ",
                           "group by year, TRIP_ID, FE_MAJOR_LEVEL_ID, SPECIES_CODE) AS bsre ", 
                           "RIGHT OUTER JOIN ",
                           "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH ON bsre.TRIP_ID = ",              
                           "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH.TRIP_ID and ",
                           "bsre.FE_MAJOR_LEVEL_ID = dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH.[SET] ",
                           "and bsre.SPECIES_CODE = ",                       
                           "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH.species ",            
                           "where (dbo.GFBIO_RESEARCH_SAMPLE_DETAILS_OTHER_FISH.Year = ",yr, 
                           ") order by species,[SET]", sep="")
   #otherspec2            <-  GetSQLData(othersamples,"Sablefish")   # read from SQL Server
   #write.table(otherspec2, file = paste(path,'appendixF.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   otherspec2              <-  read.csv(paste(path,'appendixF.csv',sep=''),header=T) # read from csv
   otherspec2$species_name <-  as.character(otherspec2$species_name)
   otherspec2$species_name <-  gsub('ROUGHEYE/BLACKSPOTTED ROCKFISH COMPLEX', 'ROUGHEYE/ BLACKSPOTTED ROCKFISH COMPLEX', otherspec2$species_name)
   addition                <-  c('Total','', sum(otherspec2$Len.Sample.Count),    sum(otherspec2$weight_count), 
                                           sum(otherspec2$Sex.Sample.Count),    sum(otherspec2$Maturity.Sample.Count),   
                                           sum(otherspec2$Otolith.Sample.Count),sum(otherspec2$DNA.Sample.Count),
                                           sum(otherspec2$Sample_count),'','','','',sum(otherspec2$'Rougheye'),sum(otherspec2$'Blackspotted'),sum(otherspec2$'Hybrid'))
   otherspec             <-  rbind(otherspec2,addition)
   row.count             <-  length(otherspec$species_name)
  
   otherspec$species_name<-  cleanf(otherspec$species_name)    # only rougheye/blackspotted sampled in 2020
   colnames(otherspec)   <-  c("Species Name", "Set", "Fork Length",
                               "Weight", "Sex","Maturity", "Otolith", 
                               "DNA", "Total Count", 
                               "Proportion Males", "Males", "Females",  
                               "No sex", "RE", "BS","Hybrid" )
   
      kableExtra::kable(otherspec,
                     booktabs = TRUE, 
                     longtable = T,
                     linesep   = "",
                     align=c('l', 'r','c','c','c','c','c','c','c','c','c','c','c','c','c','c'),
                     format = "latex") %>%
      
      add_header_above(c(" "= 2,
                      "Specimen Count"= 7, 
                      "Mean Fork Length(mm)" = 4,
                      "Sampler Visual id Count" = 3), bold=TRUE) %>%
   
      kableExtra::kable_styling(font_size = 8, 
                        latex_options = "repeat_header",
                        repeat_header_text = "continued.", 
                        repeat_header_method = "replace") %>%
      
      kableExtra::landscape()  %>% 
         
      column_spec(1,width     = "3.5cm") %>% # species
      column_spec(2,width     = "0.7cm") %>% # set
      column_spec(3,width     = "0.7cm") %>% # fl 
      column_spec(4,width     = "0.7cm") %>% # wt   
      column_spec(5,width     = "0.7cm") %>% # sex 
      column_spec(6,width     = "0.7cm") %>% # mat
      column_spec(7,width     = "0.7cm") %>% # oto
      column_spec(8,width     = "0.7cm") %>% # dna
      column_spec(9,width     = "0.7cm") %>% # cnt        
      column_spec(10,width    = "1.1cm") %>% # prop m
      column_spec(11,width    = "0.7cm") %>% # male
      column_spec(12,width    = "0.7cm") %>% # female
      column_spec(13,width    = "0.7cm") %>% #  no sex  
      column_spec(14,width    = "1.0cm") %>% # re
      column_spec(15,width    = "1.2cm") %>% # bc
      column_spec(16,width    = "0.8cm") %>% # hybrid 
      row_spec(0, bold = T) %>%
      row_spec(20,  hline_after = T) %>%
      row_spec(row.count, bold = T)

```
\clearpage

<!-- At the end of your appendices add: -->
`r if(knitr:::is_latex_output()) '% end csasdown appendix'`

<!--chapter:end:05_appendix.Rmd-->

<!-- If you want to references to appear somewhere before the end, add: -->
<!-- <div id="refs"></div> -->
<!-- where you want it to appear -->

<!-- In general, you shouldn't need to edit this file with the exception of
the following French/English translation. For a French document, set the following header to: # Références Citées  {-} -->

\clearpage

# References

<!-- The following sets the appropriate indentation for the references -->
\noindent
\vspace{-2em}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}

<!--chapter:end:06_bibliography.Rmd-->

