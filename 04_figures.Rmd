# Figures

(ref:figure1) Location of the boundaries of the five spatial areas (S~1~-S~5~) of the 2020 stratified random survey design. The three depths strata (RD~1~-RD~3~) are colour-coded and nested within each of the five spatial strata. 

```{r figure1, fig.cap='(ref:figure1)', out.width = "410px", fig.align="center", warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
      img <- paste(basepath,'figures/figure1.png',sep='') 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure2) Start locations of survey sets (red markers) conducted in `r yr` for the stratified random survey areas S~1~ through S~5~.

```{r figure2, fig.cap='(ref:figure2)', out.width = "480px", out.height = "381px", fig.align="center", warning=FALSE, echo=FALSE, message=FALSE, error=FALSE}
      img <- paste(basepath,'figures/figure2.png',sep='') 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure3)  Image of the F/V `r boat`  used for the 2020 sablefish research and assessment survey.  Photo by Cody Melnychuk. 

```{r figure3, fig.cap='(ref:figure3)', out.width = "480px", out.height = "480px",echo=FALSE, fig.align="center", warning=FALSE}
      img  <- paste(basepath,'figures/figure3.jpg',sep="") 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure4) Trap elements (A).  Trap gear elements consisting of 25 baited traps snapped to beckets along a groundline (B).

```{r figure4, fig.cap='(ref:figure4)', out.width = "380px", out.height = "626px",echo=FALSE, fig.align="center", warning=FALSE}
      img  <- paste(basepath,'figures/figure4.png',sep="") 
      knitr::include_graphics(img)
```
\clearpage

(ref:figure5) Sablefish catch per unit effort (CPUE) by depth and year for StRS sets. Dashed lines delineate depth strata (shallow(RD~1~) = 100-450m, mid(RD~2~) = 450-850m, deep(RD~3~) = 850-1400m).

```{r figure5, fig.cap='(ref:figure5)',echo=FALSE, out.width = "400px",  fig.align = "center", warning=FALSE}

    #   results='asis',echo=FALSE,include=FALSE,warning=FALSE,message = FALSE,error= FALSE
    png(paste(basepath,'figures/figure5.png',sep=''), width = 475, height = 684)  # write png to folder 

    #   query----------raw survey datafile for Landmark fisheries----------------
    landmrk <- paste("select fecCPUE.TRIP_ID, fecCPUE.VESSEL_ID, fecCPUE.SUFFIX, ",                                  
                     "fecCPUE.CAPTAIN_ID, fecCPUE.FISHING_EVENT_ID, fecCPUE.FE_MAJOR_LEVEL_ID,",
                     "fecCPUE.SET_YEAR,   fecCPUE.SET_MONTH, fecCPUE.SET_DAY, ",                               
                     "fecCPUE.SET_TIME,   fecCPUE.DURATION_MINUTES, fecCPUE.SABLE_DEPTH_GROUP, ",                     
                     "fecCPUE.SABLE_AREA_GROUP, fecCPUE.SABLE_SET_TYPE, ", 
                     "fecCPUE.GROUPING_CODE, fecCPUE.REASON_CODE, fecCPUE.FE_REASON_COMMENT, ",                    
                     "fecCPUE.GEAR_CODE,  fecCPUE.NS_AREA, ",
                     "fecCPUE.INSHORE_IND,      fecCPUE.SEAMOUNT_IND, fecCPUE.MAJOR_STAT_AREA_CODE, ",                
                     "fecCPUE.MINOR_STAT_AREA_CODE, fecCPUE.LOCALITY_CODE, ",                                   
                     "fecCPUE.FE_FISHING_Ground_COMMENT, ",
                     "fecCPUE.START_LATITUDE, fecCPUE.START_LONGITUDE, ",
                     "fecCPUE.END_LATITUDE, fecCPUE.END_LONGITUDE, ",
                     "fecCPUE.FE_BEGINNING_BOTTOM_DEPTH, fecCPUE.FE_END_BOTTOM_DEPTH, ",
                     "fecCPUE.FE_MODAL_BOTTOM_DEPTH, fecCPUE.TRAP_MODIFICATIONS_CODE, ",       
                     "fecCPUE.FE_USABILITY, fecCPUE.CPUE_SABLE_WEIGHT, ",
                     "fecCPUE.CPUE_SABLE_COUNT, fecCPUE.CPUE_TRAPS, fecCPUE.TOTAL_TRAPS, ",   
                     "ISNULL(fecCPUE.TOTAL_SABLE_COUNT, 0) AS TOTAL_SABLE_COUNT, ",
                     "ISNULL(fecCPUE.TOTAL_SABLE_WEIGHT, 0) AS TOTAL_SABLE_WEIGHT, ",
                     "fecCPUE.VERIFICATION_METHOD, fecCPUE.FE_START_LATTITUDE_DEGREE, ",
                     "fecCPUE.FE_START_LATTITUDE_MINUTE, fecCPUE.FE_START_LONGITUDE_DEGREE,",     
                     "fecCPUE.fe_start_longitude_minute, fecCPUE.FE_END_LATTITUDE_DEGREE, ", 
                     "fecCPUE.fe_end_lattitude_minute, fecCPUE.fe_end_longitude_degree,   ",
                     "fecCPUE.fe_end_longitude_minute, fecCPUE.START_FATHOMS, ",
                     "fecCPUE.END_FATHOMS, fecCPUE.MODAL_DEPTH_FM, ",
                     "fecCPUE.DepthStrataID, dbo.SurveyBlock_countWeight.nBlocks AS Nh, ",
                     "dbo.SurveyBlock_countWeight.Wh,", 
                     "ISNULL(fecCPUE.CPUE_SABLE_WEIGHT / NULLIF (fecCPUE.CPUE_TRAPS, 0), 0) AS cpue,",   
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Proportion Males], ",
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Male Mean Fork Len(mm)], ",
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Female Mean Fork Len(mm)], ",                                        
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[Tagged Mean Fork Len(mm)]  ",
                     "from (select trp.TRIP_ID, trp.VESSEL_ID, trp.SUFFIX, trp.CAPTAIN_ID, fe_1.FISHING_EVENT_ID, ",
                     "fe_1.FE_MAJOR_LEVEL_ID, YEAR(dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, ",
                     "fe_1.fe_end_retrieval_time)) AS SET_YEAR,  ",     
                     "MONTH(dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, ",
                     "fe_1.fe_end_retrieval_time)) AS SET_MONTH,  ", 
                     "DAY(dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, ",
                     "fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time)) AS SET_DAY, ",
                     "CAST(DATEPART(hh, dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, ",
                     "fe_1.fe_end_retrieval_time)) AS varchar) + ",
                     "CAST(DATEPART(mi, dbo.SableSetDate(fe_1.fe_begin_deployment_time, ",
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time)) AS varchar) AS SET_TIME, ",
                     "DATEDIFF(mi, ISNULL(fe_1.fe_end_deployment_time, fe_1.fe_begin_deployment_time), ISNULL(fe_1.fe_begin_retrieval_time, ",  
                     "fe_1.fe_end_retrieval_time)) AS DURATION_MINUTES,  ",
                     "dbo.SableDepthGroup(fe_1.GROUPING_CODE) AS SABLE_DEPTH_GROUP, ",   
                     "dbo.SableAreaGroup(fe_1.GROUPING_CODE, fe_1.REASON_CODE, fe_1.FE_FISHING_Ground_COMMENT) AS SABLE_AREA_GROUP, ",
                     "dbo.SableSetType(fe_1.REASON_CODE,fe_1.FE_REASON_COMMENT, ISNULL(GFBioSQL.dbo.Dater(fe_1.fe_begin_deployment_time, ",  
                     "fe_1.fe_end_deployment_time, fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time),  ",
                     "trp.TRIP_START_DATE)) AS SABLE_SET_TYPE, fe_1.GROUPING_CODE, fe_1.REASON_CODE, fe_1.FE_REASON_COMMENT, ",
                     "fe_1.GEAR_CODE, sloc.NS_AREA, sloc.INSHORE_IND, sloc.SEAMOUNT_IND, ",
                     "fe_1.MAJOR_STAT_AREA_CODE, fe_1.MINOR_STAT_AREA_CODE, fe_1.LOCALITY_CODE, fe_1.FE_FISHING_Ground_COMMENT, ",
                     "fe_1.FE_START_LATTITUDE_DEGREE + fe_1.FE_START_LATTITUDE_MINUTE / 60 AS START_LATITUDE, ",
                     "(fe_1.FE_START_LONGITUDE_DEGREE + fe_1.fe_start_longitude_minute / 60)  * - 1 AS START_LONGITUDE, ",
                     "fe_1.FE_END_LATTITUDE_DEGREE + fe_1.fe_end_lattitude_minute / 60 AS END_LATITUDE, ",
                     "(fe_1.fe_end_longitude_degree + fe_1.fe_end_longitude_minute / 60) * - 1 AS END_LONGITUDE, ",
                     "fe_1.FE_BEGINNING_BOTTOM_DEPTH, fe_1.FE_END_BOTTOM_DEPTH, fe_1.FE_MODAL_BOTTOM_DEPTH, ",
                     "fe_1.FE_MISC_COMMENT, fets.TRAP_MODIFICATIONS_CODE, fets.USABILITY_CODE AS FE_USABILITY, ",
                     "CAST(CASE WHEN fe_1.REASON_CODE <> 14 AND fets.USABILITY_CODE <> 13 THEN isnull(traps.CPUE_WEIGHT, ",
                     "CASE WHEN fets.USABILITY_CODE IN (1, 12) THEN CASE WHEN fec_1.catch_weight IS NULL AND ",
                     "isnull(fec_1.VERIFICATION_METHOD,0) <> 9 THEN 0 ELSE fec_1.catch_weight END ELSE NULL END)  ",
                     "else NULL end AS numeric(7,1)) ",
                     "AS CPUE_SABLE_WEIGHT, CAST(CASE WHEN fe_1.REASON_CODE <> 14 AND fets.USABILITY_CODE <> 13 THEN isnull(traps.CPUE_COUNT, ",
                     "CASE WHEN fets.USABILITY_CODE IN (1, 12) THEN CASE WHEN fec_1.catch_count IS NULL AND ",
                     "isnull(fec_1.VERIFICATION_METHOD, 0) <> 3 THEN 0 ELSE fec_1.catch_count END ELSE NULL END) ELSE NULL END ",
                     "AS smallint) AS CPUE_SABLE_COUNT, ",
                     "CAST(CASE WHEN fe_1.reason_code <> 14 AND fets.USABILITY_CODE <> 13 THEN ",
                     "isnull(CPUE_TRAPS, CASE WHEN fets.USABILITY_CODE IN (1, 12) THEN fets.TRAPS_FISHED_COUNT ELSE NULL END) ",
                     "ELSE NULL END AS smallint) AS CPUE_TRAPS, ISNULL(traps.TOTAL_TRAPS, fets.TRAPS_FISHED_COUNT) AS TOTAL_TRAPS, ",              
                     "CAST(ISNULL(traps.total_count, fec_1.CATCH_COUNT) AS smallint) as TOTAL_SABLE_COUNT, ",
                     "CAST(ISNULL(traps.total_weight, fec_1.CATCH_WEIGHT) AS numeric(7, 1)) AS TOTAL_SABLE_WEIGHT, ",
                     "fec_1.VERIFICATION_METHOD, fe_1.FE_START_LATTITUDE_DEGREE, fe_1.FE_START_LATTITUDE_MINUTE, ",
                     "fe_1.FE_START_LONGITUDE_DEGREE, fe_1.fe_start_longitude_minute, fe_1.FE_END_LATTITUDE_DEGREE, ",
                     "fe_1.fe_end_lattitude_minute, fe_1.fe_end_longitude_degree, fe_1.fe_end_longitude_minute, ",      
                     "round(PacHarvest.dbo.m2fa(fe_1.FE_BEGINNING_BOTTOM_DEPTH), 0) AS START_FATHOMS, ",
                     "round(PacHarvest.dbo.m2fa(fe_1.FE_END_BOTTOM_DEPTH), 0) AS END_FATHOMS, ",
                     "round(PacHarvest.dbo.m2fa(fe_1.FE_MODAL_BOTTOM_DEPTH), 0) AS MODAL_DEPTH_FM, ",
                     "dbo.DepthStrataID(round(fe_1.FE_MODAL_BOTTOM_DEPTH, 0), ",
                     "dbo.SableDepthGroup(fe_1.GROUPING_CODE)) AS DepthStrataID ",
                     "from GFBioSQL.dbo.TRIP AS trp INNER JOIN ",
                     "(select  TRIP_ID         ",
                     "from GFBioSQL.dbo.TRIP_ACTIVITY    ",
                     "where (ACTIVITY_CODE = 19)) AS act ON trp.TRIP_ID = act.TRIP_ID INNER JOIN  ",
                     "(select TRIP_ID,FISHING_EVENT_ID,FE_PARENT_EVENT_ID, ",
                     "FE_MAJOR_LEVEL_ID,FE_SUB_LEVEL_ID,FE_MINOR_LEVEL_ID,EMPLOYEE_ID, ",                                         
                     "fe_begin_deployment_time, fe_end_deployment_time, fe_begin_retrieval_time, fe_end_retrieval_time,  ",
                     "GROUPING_CODE, REASON_CODE, FE_REASON_COMMENT, MAJOR_STAT_AREA_CODE, ",
                     "MINOR_STAT_AREA_CODE, LOCALITY_CODE, DFO_STAT_AREA_CODE, DFO_STAT_SUBAREA_CODE, ",
                     "LOC_VRFN_METHOD_CODE, FE_FISHING_Ground_COMMENT, ",
                     "FE_START_LATTITUDE_DEGREE, FE_START_LATTITUDE_MINUTE,  ",
                     "FE_END_LATTITUDE_DEGREE,   fe_end_lattitude_minute,      ",             
                     "FE_START_LONGITUDE_DEGREE, fe_start_longitude_minute,     ",
                     "fe_end_longitude_degree, fe_end_longitude_minute, ",
                     "FE_START_LORAN_X, FE_START_LORAN_Y, FE_END_LORAN_X, FE_END_LORAN_Y, ",
                     "FE_DISTANCE_TRAVELLED, FE_DIRECTION_OF_SET, FE_PLOTTER_RECORD_INFOR, ",
                     "DEPTH_VRFN_METHOD_CODE, FE_BEGINNING_BOTTOM_DEPTH, FE_END_BOTTOM_DEPTH,  ",
                     "FE_MODAL_BOTTOM_DEPTH, FE_MIN_BOTTOM_DEPTH, FE_MAX_BOTTOM_DEPTH,  ",
                     "FE_BEGIN_TARGET_DEPTH, FE_END_TARGET_DEPTH, FE_MIN_TARGET_DEPTH, FE_MAX_TARGET_DEPTH,  ",
                     "FE_MODAL_TARGET_DEPTH, FE_BEGIN_CAPTURE_DEPTH, FE_END_CAPTURE_DEPTH,  ",
                     "FE_MIN_CAPTURE_DEPTH, FE_MAX_CAPTURE_DEPTH, FE_MODAL_CAPTURE_DEPTH,  ",
                     "FE_BEGINNING_GEAR_DEPTH, FE_END_GEAR_DEPTH, FE_MIN_GEAR_DEPTH, FE_MAX_GEAR_DEPTH, FE_MODAL_GEAR_DEPTH,  ",  
                     "FE_SURFACE_WATER_TEMPERATURE,  ",
                     "FE_SURFACE_WATER_TEMP_DEPTH, FE_SURFC_WATR_TEMP_TECH_CODE, FE_BOTTOM_WATER_TEMPERATURE,  ",
                     "FE_BOTTOM_WATER_TEMP_DEPTH, FE_BOTTM_WATR_TEMP_TECH_CODE,  ",
                     "FE_MODAL_DEPTH_TEMPERATURE, FE_GEAR_TEMP_TECH_CODE, FE_CTD_REF_NUMBER,  ",
                     "FE_WIND_DIRECTION, FE_WIND_SPEED, BEAUFORT_SCALE_CODE, FE_SWELL, TIDE_CODE,  ",
                     "FE_CLOUD_COVER, FE_LUMINESCENCE, FE_WEATHER_COMMENT, FE_SUN_SHINING_IND, GEAR_CODE,  ",   
                     "EST_CATCH_METHOD_CODE, FE_TOTAL_CATCH_WEIGHT, FE_TOTAL_CATCH_PIECES,  ",
                     "FE_CATCH_WEIGHT_PER_PIECE, FE_SOUNDER_COMMENT, FE_EK500_TAPE_NUMBER,  ",
                     "FE_MISC_COMMENT, ROW_VERSION, BLOCK_DESIGNATION, FE_BEGIN_BOTTOM_CONTACT_TIME,  ",
                     "FE_END_BOTTOM_CONTACT_TIME, BOTTOM_CONTACT_METHOD_CODE, MODIFIED_DATE, MODIFIED_BY,  ",
                     "HAUL_RECORDER, FE_CATCH_COMMENT, PARTIAL_SORT_IND,  ",
                     "FE_CATCH_VERIFICATION_COMMENT, SCALE_ID, CAPTAIN_ID ",
                     "from GFBioSQL.dbo.FISHING_EVENT ",
                     "where (FE_PARENT_EVENT_ID IS NULL)) AS fe_1 ON trp.TRIP_ID = fe_1.TRIP_ID LEFT OUTER JOIN dbo.traps AS traps ",
                     "ON fe_1.TRIP_ID = traps.TRIP_ID AND fe_1.FE_MAJOR_LEVEL_ID = traps.FE_MAJOR_LEVEL_ID LEFT OUTER JOIN ",
                     "dbo.sablefish_locality AS sloc ON fe_1.MAJOR_STAT_AREA_CODE = sloc.MAJOR_STAT_AREA_CODE  ",
                     "and fe_1.MINOR_STAT_AREA_CODE = sloc.MINOR_STAT_AREA_CODE AND  ",
                     "fe_1.LOCALITY_CODE = sloc.LOCALITY_CODE LEFT OUTER JOIN ",
                     "GFBioSQL.dbo.TRAP_SPECS AS fets ON fe_1.FISHING_EVENT_ID = fets.FISHING_EVENT_ID LEFT OUTER JOIN ",
                     "(select  fec.FISHING_EVENT_ID, CATCH_1.SPECIES_CODE, SUM(CATCH_1.CATCH_WEIGHT) AS CATCH_WEIGHT,  ",
                     "sum(CATCH_1.CATCH_COUNT) AS CATCH_COUNT, AVG(ISNULL(CATCH_1.CATCH_VERIFICATION_CODE, 0)) AS VERIFICATION_METHOD ",
                     "from GFBioSQL.dbo.FISHING_EVENT_CATCH AS fec INNER JOIN ",                                                                  
                     "GFBioSQL.dbo.CATCH AS CATCH_1 ON fec.CATCH_ID = CATCH_1.CATCH_ID ",
                     "where (CATCH_1.SPECIES_CODE = '455') ",
                     "group by fec.FISHING_EVENT_ID, CATCH_1.SPECIES_CODE) AS fec_1 ON fe_1.FISHING_EVENT_ID = fec_1.FISHING_EVENT_ID ", 
                     "where (YEAR(dbo.SableSetDate(fe_1.fe_begin_deployment_time, fe_1.fe_end_deployment_time,  ",
                     "fe_1.fe_begin_retrieval_time, fe_1.fe_end_retrieval_time)) > 2002))  AS fecCPUE LEFT OUTER JOIN ",
                     "dbo.GFBIO_RESEARCH_SAMPLE_DETAILS ON fecCPUE.FE_MAJOR_LEVEL_ID = dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.[SET] AND  ",
                     "fecCPUE.TRIP_ID = dbo.GFBIO_RESEARCH_SAMPLE_DETAILS.TRIP_ID LEFT OUTER JOIN ",
                     "dbo.SurveyBlock_countWeight ON fecCPUE.SABLE_AREA_GROUP = dbo.SurveyBlock_countWeight.areaStrName AND   ",      
                     "fecCPUE.DepthStrataID = dbo.SurveyBlock_countWeight.depthStrName", sep="")

    #raw_survey_data<- GetSQLData(landmrk,"Sablefish")
    #write.table(raw_survey_data, file = paste(path,"figure456.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
    raw_survey_data <- read.csv(paste(path,'/figure5.csv',sep=''),header=T)
    
    # load survey data 
    library(Rmisc)
    strs01            <- subset(raw_survey_data,SABLE_SET_TYPE=="StRS") 
    strs01$sable_cpue <- strs01$CPUE_SABLE_WEIGHT/strs01$CPUE_TRAPS           # changed from TOTAL_TRAPS to CPUE_TRAPS
    strs01$sable_cnts <- strs01$CPUE_SABLE_COUNT/strs01$CPUE_TRAPS 
    strs01$sable_wt   <- strs01$CPUE_SABLE_WEIGHT/strs01$CPUE_SABLE_COUNT
    strs01$strata     <- paste(strs01$SABLE_AREA_GROUP,strs01$SABLE_DEPTH_GROUP)
    strs02            <- arrange(transform(strs01,strata=factor(strata,levels=rev(unique(strs01$strata)))),strata)
    tgc01             <- summarySE(strs02, measurevar="sable_cpue", groupvars=c("SET_YEAR","strata"),na.rm = T)
    tgc.02            <- arrange(transform(tgc01,strata=factor(strata,levels = c("S5 RD3", "S5 RD2", "S5 RD1", 
                                                                                 "S4 RD3", "S4 RD2", "S4 RD1", 
                                                                                 "S3 RD3", "S3 RD2", "S3 RD1", 
                                                                                 "S2 RD3", "S2 RD2", "S2 RD1",
                                                                                 "S1 RD3", "S1 RD2", "S1 RD1" ))),strata)
  
     # drop 2003 and 2004 and set panel ordering for aesthetics
     strs.02<-arrange(transform(strs01[strs01$SET_YEAR>2004,],
                                SET_YEAR=factor(SET_YEAR,levels=c(2005,2009,2013,2017,
                                                                  2006,2010,2014,2018,
                                                                  2007,2011,2015,2019,
                                                                  2008,2012,2016,2020))),SET_YEAR)
    

    
    ggplot( strs.02,aes(x=FE_MODAL_BOTTOM_DEPTH,y=CPUE_SABLE_WEIGHT/CPUE_TRAPS))+
            geom_point(alpha = 3/5,color="steelblue")+
            facet_wrap(~SET_YEAR,ncol=4)+
            scale_x_continuous(breaks = c(100,450,850,1400),limits=c(0,1500))+ 
            geom_vline(xintercept=c(450),linetype="dashed",color="steelblue")+
            geom_vline(xintercept=c(850),linetype="dashed",color="steelblue")+
            xlab("Depth (m)")+
            ylab("CPUE (kg/trap)")+
            theme_bw()

    while (!is.null(dev.list()))  dev.off()
    img    <-  paste(basepath,'figures/figure5.png',sep="")   # retrieve png 
               knitr::include_graphics(img)
```
\clearpage

(ref:figure6) Average Sablefish catch per unit effort (CPUE; mean +/- 95% CIs) by survey strata since 2003. Panels run deep to shallow (left to right) and north to south (top to bottom).

```{r figure6, fig.cap='(ref:figure6)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

     png(paste(basepath,'figures/figure6.png',sep=''), width=500, height=641) # write png to file
     par(mfcol=c(1,1))
     tgc.02$col <- ifelse(tgc.02$SET_YEAR == 2020, "red", "steelblue")

     ggplot(tgc.02,aes(x=SET_YEAR,y=sable_cpue)) +
     geom_errorbar(aes(ymin=sable_cpue-ci, ymax=sable_cpue+ci), width=0, col=tgc.02$col) +
     geom_line(col=tgc.02$col) +
     geom_point(col=tgc.02$col) +
     facet_wrap(~strata,nrow=5)+
     xlab("Year")+
     ylab("Mean CPUE (kg/trap)")+
           #theme_bw()
     theme(     panel.background =  element_rect(fill = "white",
                                    colour = "grey50",
                                    size = 0.5, linetype = "solid"),
                panel.grid.major =  element_line(size = 0.5, linetype = 'solid',
                                    colour = "grey90"), 
                panel.grid.minor =  element_line(size = 0.25, linetype = 'solid',
                                    colour = "grey90"),
                strip.background =  element_rect(fill = "grey80", colour = "grey30"), 
                plot.margin=unit(c(0.2,0.2,0.2,1),"cm")) 
     
  
     while (!is.null(dev.list()))  dev.off()
     img <-   paste(basepath,'figures/figure6.png',sep='')   # -- retrieve png 
              knitr::include_graphics(img)
```

\clearpage
(ref:figure7) Average number of sablefish per trap (mean +/- 95% CIs) by StRS survey strata over time. Panels run shallow to deep (left to right) and south to north (top to bottom).

```{r figure7, fig.cap='(ref:figure7)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

    png(paste(basepath,'figures/figure7.png', sep=''), width=500, height=641) # write png to file
    par(mfcol=c(1,1))
    
    
    strs                   <- subset(raw_survey_data,SABLE_SET_TYPE=="StRS") 
    strs$sable_cpue        <- strs$CPUE_SABLE_WEIGHT/strs$CPUE_TRAPS 
    strs$sable_cnt         <- (strs$CPUE_SABLE_COUNT/strs$CPUE_TRAPS)
    strs$sable_wg          <- (strs$CPUE_SABLE_WEIGHT/strs$CPUE_SABLE_COUNT) 
    strs$sable_avwt_trap   <- (strs$sable_cpue/strs$sable_cnt)
    strs$strata            <-  paste(strs$SABLE_AREA_GROUP,strs$SABLE_DEPTH_GROUP)
 
    strs2 <- arrange(transform(strs,strata=factor(strata,levels=rev(unique(strs$strata)))),strata)
    
    tgc   <- summarySE(strs2, measurevar=("sable_cpue"),         groupvars=c("SET_YEAR","strata"),na.rm = T)
    tgcwg <- summarySE(strs2, measurevar=("sable_wg"),           groupvars=c("SET_YEAR","strata"),na.rm = T)
    tgcnt <- summarySE(strs2, measurevar=("sable_cnt"),          groupvars=c("SET_YEAR","strata"),na.rm = T)

    tgc   <- arrange(transform(tgc,
                     strata=factor(strata,
                                   levels=c("S5 RD3", "S5 RD2", "S5 RD1", 
                                            "S4 RD3", "S4 RD2", "S4 RD1", 
                                            "S3 RD3", "S3 RD2", "S3 RD1", 
                                            "S2 RD3", "S2 RD2", "S2 RD1",
                                            "S1 RD3", "S1 RD2", "S1 RD1"))),strata)
    
    tgcwg<-arrange(transform(tgcwg,
                             strata=factor(strata,
                                           levels=c("S5 RD3", "S5 RD2", "S5 RD1", 
                                                    "S4 RD3", "S4 RD2", "S4 RD1", 
                                                    "S3 RD3", "S3 RD2", "S3 RD1", 
                                                    "S2 RD3", "S2 RD2", "S2 RD1",
                                                    "S1 RD3", "S1 RD2", "S1 RD1"))),strata)
    
    tgcnt<-arrange(transform(tgcnt,
                             strata=factor(strata,
                                           levels=c("S5 RD3", "S5 RD2", "S5 RD1", 
                                                    "S4 RD3", "S4 RD2", "S4 RD1", 
                                                    "S3 RD3", "S3 RD2", "S3 RD1", 
                                                    "S2 RD3", "S2 RD2", "S2 RD1",
                                                    "S1 RD3", "S1 RD2", "S1 RD1"))),strata)

    tgcnt$col <- ifelse(tgcnt$SET_YEAR == 2020, "red", "steelblue")
    ggplot(tgcnt,aes(x=SET_YEAR,y=sable_cnt))+
           geom_errorbar(aes(ymin=sable_cnt-ci, ymax=sable_cnt+ci), width=0, col=tgcnt$col) +
           geom_line(col=tgcnt$col ) +
           geom_point(col=tgcnt$col ) +
           facet_wrap(~rev(strata),nrow=5,labeller = )+
           coord_cartesian(ylim=c(0,60))+ 
           xlab("Year")+
           ylab("Mean CPUE (#fish/trap)")+
        
     theme(panel.background = element_rect(fill = "white",
                              colour = "grey50",
                              size = 0.5, linetype = "solid"),
           panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                              colour = "grey90"), 
           panel.grid.minor = element_line(size = 0.25, linetype = 'solid',
                              colour = "grey90"),
           strip.background = element_rect(fill = "grey80", colour = "grey30"), 
           plot.margin=unit(c(0.2,0.2,0.2,1),"cm")) 
    
    while (!is.null(dev.list()))  dev.off()
    img <- paste(basepath,'figures/figure7.png',sep='')   # -- retrieve png 
           knitr::include_graphics(img)
    
```
\clearpage
(ref:figure8) Average weight of sablefish (mean +/- 95% CIs) by survey strata over time. Panels run shallow to deep (left to right) and south to north (top to bottom).

```{r figure8, fig.cap='(ref:figure8)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

    png(paste(basepath,'figures/figure8.png',sep=''),width=500, height=641) # write png to file
    par(mfcol=c(1,1))
    tgcwg$col <- ifelse(tgcwg$SET_YEAR == 2020, "red", "steelblue")    
    

    ggplot(tgcwg,aes(x= SET_YEAR,y=sable_wg))+
    geom_errorbar(aes(ymin=sable_wg-ci, ymax=sable_wg+ci), width=0, col= tgcwg$col) +
    geom_line(col= tgcwg$col) +
    geom_point(col= tgcwg$col) +
    facet_wrap(~strata,nrow=5)+
    coord_cartesian(ylim=c(1,6)) + 
    xlab("Year")+
    ylab("Sablefish weight (kg)") +
      #theme_bw()
     theme(     panel.background = element_rect(fill = "white",
                                colour = "grey50",
                                size = 0.5, linetype = "solid"),
                panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "grey90"), 
                panel.grid.minor = element_line(size = 0.25, linetype = 'solid',
                                colour = "grey90"),
                strip.background =  element_rect(fill = "grey80", colour = "grey30"), 
                plot.margin=unit(c(0.2,0.2,0.2,1),"cm")) 
    
    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure8.png',sep='')   # -- retrieve png 
              knitr::include_graphics(img)
```   
\clearpage

(ref:figure9) Annual mean weight of sablefish per trap (kg/trap) (A);  annual mean number of sablefish per trap (#fish/trap) (B); annual mean weight of sablefish (kg) (C) by StRS survey strata over time. Horizontal line is median and blue dots are arithmetic mean.

```{r figure9, fig.cap='(ref:figure9)', out.width = "450px", out.height = "576px",echo=FALSE, fig.align="center", warning=FALSE}

  png(paste(basepath,'figures/figure9.png', sep=''), width=600, height=800) # write png to file
  library(cowplot)
 
       p <- ggplot(tgc,aes(x=as.factor(SET_YEAR),y=sable_cpue)) + 
          geom_boxplot(fill="grey90", width=0.5) +
          stat_summary(fun.y=mean, geom="point", shape=16, size=2,col="steelblue")+
          xlab("Year")+
          ylab("StRS CPUE (kg/trap)")+
          #scale_y_continuous(limits=c(0,175))+
          theme(axis.text = element_text(size = 6)) + 
          theme_bw()
  
       p1 <- ggplot(tgcnt, aes(x=as.factor(SET_YEAR), y=sable_cnt)) + 
          geom_boxplot(fill="grey90", width=0.5) +
          stat_summary(fun.y=mean, geom="point", shape=16, size=2,col="steelblue")+
          xlab("Year") +
          ylab("CPUE (#fish/trap)") +
          #scale_y_continuous(limits=c(0,75))+
          theme(axis.text = element_text(size = 6)) + 
          theme_bw()
     
     p2 <- ggplot(tgcwg, aes(x=as.factor(SET_YEAR), y=sable_wg )) + 
          geom_boxplot(fill="grey90", width=0.5) +
          stat_summary(fun.y=mean, geom="point", shape=16, size=2,col="steelblue")+
          xlab("Year") +
          ylab("Mean weight (kg)") +
          theme(axis.text = element_text(size = 6)) + 
          theme_bw()

    plot_grid(p, p1, p2, labels = "AUTO", nrow = 3)    
  
    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure9.png',sep="")   # -- retrieve png 
              knitr::include_graphics(img)

```
\clearpage

```{r figure setup, include=FALSE}
        LWSMO <- "SELECT * FROM GFBIO_SABLEBIO_VW where YEAR > 2002"
        #LWSMOdat<- GetSQLData(LWSMO,"Sablefish")
        #write.table(LWSMOdat, file = paste(path,"figure10.csv",sep=''),row.names=FALSE, na="",col.names=TRUE, sep=",")

        LWSMOdat <- read.csv(paste(path,'figure10.csv',sep=''), header=T)
        lws <- subset(LWSMOdat,SABLE_SET_TYPE=="StRS" & YEAR > 2002)
        lws$strata <- paste(lws$SABLE_AREA_GROUP,lws$SABLE_DEPTH_GROUP)
        lws<-arrange(transform(lws,YEAR=factor(YEAR,levels=c(2003,2009,2015,
                                                             2004,2010,2016,
                                                             2005,2011,2017,
                                                             2006,2012,2018,
                                                             2007,2013,2019,
                                                             2008,2014,2020 ))),YEAR) 
        lws.rd1 <- subset(lws,SABLE_DEPTH_GROUP == "RD1")
        lws.rd2 <- subset(lws,SABLE_DEPTH_GROUP == "RD2")
        lws.rd3 <- subset(lws,SABLE_DEPTH_GROUP == "RD3")
```
(ref:figure10) Length frequency distributions across all depth strata (100-750 fathoms) for male (blue) and female (gray) sablefish over time. The red dashed line indicates the 55 cm size limit.

```{r figure10, fig.cap='(ref:figure10)', out.width = "450px",out.height = "500px",echo=FALSE, fig.align = "center",warning=FALSE, message=FALSE}
     knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")
     png(paste(basepath,'figures/figure10.png',sep=""), width = 500, height = 550) # starts writing a png to figure folder

        ggplot(lws,aes(x=Fork_Length))+
          geom_density(data=subset(lws,SPECIMEN_SEX_CODE == 2),
                       color="gray50",fill = "gray", alpha = 0.7) +
          geom_density(data=subset(lws,SPECIMEN_SEX_CODE == 1),
                       color="steelblue",fill = "steelblue", alpha = 0.4) +
          facet_wrap(~YEAR,nrow=6,scales="free_y")+
          scale_x_continuous(limits=c(400,900))+ 
          geom_vline(xintercept=c(550),linetype="dashed",color="red")+
          xlab("Fork length (mm)")+
          ylab("Number of sablefish")+
          theme_bw()+
          theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
                plot.title = element_text(hjust = 0.5))
          #ggtitle("All depth strata")

    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure10.png',sep='')   # retrieve png 
              knitr::include_graphics(img)
              
```

(ref:figure11) Length frequency distributions in shallow depth strata (100-250 fathoms) for male (blue) and female (gray) sablefish over time. The red dashed line indicates the 55 cm size limit.

```{r figure11, fig.cap='(ref:figure11)', out.width = "450px",out.height = "500px", echo=FALSE, fig.align = "center",warning=FALSE, message=FALSE}
     knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")
     png(paste(basepath,'figures/figure11.png',sep=""), width = 500, height = 550) # -- starts writing a png to figure folder
     
        ggplot(lws.rd1,aes(x=Fork_Length))+
          geom_density(data=subset(lws.rd1,SPECIMEN_SEX_CODE == 2),color="gray50",fill = "gray", alpha = 0.7) +
          geom_density(data=subset(lws.rd1,SPECIMEN_SEX_CODE == 1),color="steelblue",fill = "steelblue", alpha = 0.4) +
          facet_wrap(~YEAR,nrow=6,scales="free")+
          scale_x_continuous(limits=c(400,900))+ 
          geom_vline(xintercept=c(550),linetype="dashed",color="red")+
          xlab("Fork length (mm)")+
          ylab("Number of sablefish")+
          theme_bw()+
          theme(axis.text.y = element_blank(),axis.ticks.y = element_blank(),plot.title = element_text(hjust = 0.5))
          #ggtitle("Shallow depth strata")
        
    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure11.png',sep='')   # retrieve png 
              knitr::include_graphics(img)
```

(ref:figure12)  Length frequency distributions across middle depth strata (250-450 fathoms) for male (blue) and female (gray) sablefish over time. The red dashed line indicates the 55 cm size limit.

```{r figure12, fig.cap='(ref:figure12)', out.width = "450px",out.height = "500px", echo=FALSE, fig.align = "center",warning=FALSE, message=FALSE}
     knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")
     png(paste(basepath,'figures/figure12.png',sep=""), width = 500, height = 550) # starts writing a png to folder
     
        ggplot(lws.rd2,aes(x=Fork_Length))+
          geom_density(data=subset(lws.rd2,SPECIMEN_SEX_CODE == 2),
                       color="gray50", fill = "gray", alpha = 0.7) +
          geom_density(data=subset(lws.rd2,SPECIMEN_SEX_CODE == 1),
                       color="steelblue", fill = "steelblue", alpha = 0.4) +
          facet_wrap(~YEAR,nrow=6,scales="free")+
          scale_x_continuous(limits=c(400,900))+ 
          geom_vline(xintercept=c(550),linetype="dashed",color="red")+
          xlab("Fork length (mm)")+
          ylab("Number of sablefish")+
          theme_bw()+
          theme(axis.text.y = element_blank(),axis.ticks.y = element_blank(),plot.title = element_text(hjust = 0.5))
          #ggtitle("Middle depth strata")

    while (!is.null(dev.list()))  dev.off()
    img <-    paste(basepath,'figures/figure12.png',sep='')   # retrieve png 
              knitr::include_graphics(img)
```
(ref:figure13) Length frequency distributions across deep depth strata (450-750 fathoms) for male (blue) and female (gray) sablefish over time. The red dashed line indicates the 55 cm size limit.


```{r figure13, fig.cap='(ref:figure13)', out.width = "450px",out.height = "500px", echo=FALSE, fig.align = "center", warning=FALSE, message=FALSE}
     knitr::opts_chunk$set(out.height = "\\textheight",  out.width = "\\textwidth")
     png(paste(basepath,'figures/figure13.png',sep=""), width = 500, height = 550) # starts writing a png to figure folder
     
        ggplot(lws.rd3,aes(x=Fork_Length)) +
          geom_density(data=subset(lws.rd3,SPECIMEN_SEX_CODE == 2),
                       color="gray50",fill = "gray", alpha = 0.7) +
          geom_density(data=subset(lws.rd3,SPECIMEN_SEX_CODE == 1),
                       color="steelblue",fill = "steelblue", alpha = 0.4) +
          facet_wrap(~YEAR,nrow=6,scales="free") +
          scale_x_continuous(limits=c(400,900)) + 
          geom_vline(xintercept=c(550),linetype="dashed",color="red") +
          xlab("Fork length (mm)") +
          ylab("Number of sablefish") +
          theme_bw()+
          theme(axis.text.y = element_blank(),axis.ticks.y = element_blank(),
                plot.title = element_text(hjust = 0.5))
          # ggtitle("Deep depth strata")

    while (!is.null(dev.list()))  dev.off()
    img <- paste(basepath,'figures/figure13.png',sep='')   # retrieve png 
           knitr::include_graphics(img)
```
(ref:figure14) Average length and ratios of male and female sablefish by year. Counts by sex are labelled on top of the plotted lines.

```{r figure14, fig.cap='(ref:figure14)',results='asis', out.width = "450px",out.height = "276px", fig.align="center"}

     png(paste(basepath,'figures/figure14.png',sep=''), width = 1200, height = 630) # -- starts writing a png to figure folder

     #  Sablefish.dbo.rocRReport_Survey_LenAvg pulls length data from table GFBIO_SABLEBIO_VW from 
     #  procedure:  Build_BIO_Sablefish_Tables
     lenstats  <- "exec procRReport_Survey_LenAvg"
     #dat       <- GetSQLData(lenstats,"Sablefish")                                                  # read from SQL Server
     #write.table(dat, file = paste(path,"figure14.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
     dat       <- read.csv(paste(path,'figure14.csv',sep=''),header=T) # read from csv
     
     fdat      <- dat[dat$sex==2,]    
     mdat      <- dat[dat$sex==1,]   
     MxSeam    <- max(dat$AvL)
    
     plot(fdat$YEAR, fdat$AvL,pch=2, ylim=c(50,MxSeam+5),xlim=c(2003,yr+1), cex=1.3, 
          ylab="Average length (cm)", xlab="Year", cex.lab=1.3, cex.axis = 1.3,
          col="gray30",xaxt="n")
     axis(1, seq(2003,2020,1), cex.axis=1.3)
     lines(fdat$YEAR,fdat$AvL,lwd=1, lty=2, col="gray30") # plot points and lines
     
     points(mdat$YEAR,mdat$AvL,pch=16,col="steelblue") 
     lines(mdat$YEAR, mdat$AvL,lwd=1,lty=1,col="steelblue")

     text(fdat$YEAR, fdat$AvL+1.5, fdat$count,cex=1.3)
     text(mdat$YEAR, mdat$AvL+1.5, mdat$count,cex=1.3)
     text(fdat$YEAR,53,format(mdat$count/fdat$count,digits=1),cex=1.3)
     text(2003.4,51,"M:F ratio",cex=1.3)
     par(usr=c(0,1,0,1))  # set up the plot margins
        
     legend(0.035,1, c("  Sablefish females","  Sablefish males"), 
            lty=c(2,1), lwd=1, bty="n", col=c("gray50","steelblue"), cex=1.3)
     legend(0.025,1, c("",""), pch=c(2,16), bty="n", col=c("gray50","steelblue"))
     panLab(0.79,0.95,paste("StRS 2003-", yr, sep=""), cex=1.3)

     while (!is.null(dev.list()))  dev.off()  
     img <- paste(basepath,'figures/figure14.png',sep='')
            knitr::include_graphics(img)
``` 

(ref:figure15) Sablefish fork length (L in cm) vs weight (W in kg) for females (A) and males (B) for the `r yr` survey.

```{r figure15, fig.cap='(ref:figure15)',results='asis', out.width = "480px", out.height = "282px", fig.align="center"}

    # Sablefish.dbo.procR_Survey_Sablefish_LenWt_shiny queries table GFBIO_SABLEBIO_VW for survey length data	
    png(paste(basepath,'figures/figure15.png',sep=''), width = 700, height = 412) # -- starts writing a png to figure folder
    par(mfcol=c(1,2), mar=c(4,4,1,1), oma=c(2,2,3,1), cex=1.0)  # -- mar(bottom, left, top, and right)
    par(xpd=NA)  # for placement of A,B,C,D

    lenWT     <- "exec procR_Survey_Sablefish_LenWt_shiny"
    #lenWTdat1 <-  GetSQLData(lenWT,"Sablefish")                                                       # read from SQL Server
    #write.table(lenWTdat1, file = paste(path,"figure15.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")    
    lenWTdat1 <- read.csv(paste(path,'figure15.csv',sep=''),header=T) # read from csv
    lenWTdat  <- lenWTdat1[lenWTdat1$YEAR==yr,]

    for (i in c(2,1)) {
         ylim <- c(min(lenWTdat$weight),max(lenWTdat$weight))
         xlim <- c(min(lenWTdat$length),max(lenWTdat$length))    
         lbls <- c(paste(yr,":  Males","",sep=""),paste(yr,":  Females","",sep=""))
   
         t    <- length(lenWTdat$length[lenWTdat$sex==i])                    
         fit1 <- lm(log(weight)~log(length), data=lenWTdat[lenWTdat$sex==i ,])
         a    <- round(exp(fit1$coef[1]),7)
         b    <- round(fit1$coef[2],3)
         Wt   <- (a * (0:xlim[2])^b)  

      plot(jitter(lenWTdat$length[lenWTdat$sex==i],2), 
           jitter(lenWTdat$weight[lenWTdat$sex==i],2), 
           pch=16, col="black", cex=0.5,
           xlab="     Fork length (cm)", ylab="   round weight (kg)", 
           main=paste(lbls[i]), xlim=c(20,100), ylim=c(0,12))      
           lines(0:xlim[2], Wt, col="steelblue", lwd=2) 
           
      mw     <- format(round(mean(lenWTdat$weight[lenWTdat$sex==i],na.rm=T),1),nsmall=1)
      par(usr=c(0,1,0,1))
      text(0.3,0.9, bquote(bold(n)==.(t)))   # -- number
      text(0.3,0.8, bquote(bolditalic(bar(W))==.(mw))) # -- mean weight
      text(0.33,0.7,bquote(bold(a)==.(a)))  # -- a
      text(0.32,0.6,bquote(bold(b)==.(b)))  # -- b
      
      letter <- c("B","A")
      di <- dev.size("in")
      x  <- grconvertX(c(0, di[1]), from="in", to="user")
      y  <- grconvertY(c(0, di[2]), from="in", to="user")
      fig <- par("fig")
      x <- x[1] + (x[2] - x[1]) * fig[1:2]
      y <- y[1] + (y[2] - y[1]) * fig[3:4]
      txt <- letter[i]
      x <- x[1] + strwidth(txt, cex=3) / 2
      y <- y[2] - strheight(txt, cex=3) *2
      text(x, y, txt, cex=1.5)
    }
    

   while (!is.null(dev.list()))  dev.off() 
   
   img <- paste(basepath,'figures/figure15.png',sep='')
          knitr::include_graphics(img)
          
```
(ref:figure16) The percentage of sub-legal sablefish (<55 cm fork length) sampled by area (S~1~-S~5~) and depth strata (S=shallow, RD~1~, M=mid, RD~2~, D=deep, RD~3~) over time. Sub-legal specimen count above 50% sampled shown in blue.

```{r figure16, fig.cap='(ref:figure16)',results='asis', out.width = "450px",out.height = "500px", fig.align="center"}

  png(paste(basepath,'figures/figure16.png',sep=''), width = 500, height = 550) 
  sqlpolar  <-  paste( " select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, ",
                       " round(countSub / total * 100, 1) as subL, ",
                       " round(countLeg / total * 100, 1) AS Leg, combo, ",
                       " combo + cast(YEAR as varchar) as combo2, ",
                       " (cast(right(sable_area_group,1) as int) + ", 
                       " cast(right(sable_area_group,1) as int) + cast(right(sable_depth_group,1) as int) + ", 
                       " cast(right(sable_area_group,1)  as int)-4 )  as polarorder ",
                       " from   ", 
                       " (select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, ",
                       " sum(NULLIF (subl, 0.0)) as countSub, ",
                       " sum(NULLIF (leg, 0.0)) AS countLeg, sum(subl) + sum(leg) as total, ",
                       " SABLE_AREA_GROUP + SABLE_DEPTH_GROUP as combo ",
                       " from (select YEAR, SABLEFISH_SURVEY_IND, SABLE_AREA_GROUP, ",
                       " SABLE_DEPTH_GROUP, SPECIMEN_ID, SPECIMEN_SEX_CODE,  ",  
                       " case when Fork_Length <= 550 then 1.0 ELSE 0.0 END as subl, ",
                       " CASE when Fork_Length > 550 THEN 1.0 ELSE 0.0 END as leg  ",
                       " from dbo.GFBIO_SABLEBIO_VW where (SABLEFISH_SURVEY_IND = 1) and  ",
                       " (SABLE_AREA_GROUP IN (N's1', N's2', N's3', N's4', N's5')) ) as LS ",
                       " group by SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, YEAR ) as LS1 ",
                       " order by YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP")

  polarsumm <-   paste( " select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP from ",
                        " (select YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP,  ",
                        " sum(NULLIF (subl, 0.0)) as countSub, sum(NULLIF (leg, 0.0)) as countLeg, ",
                        " sum(subl) + sum(leg) as total,  ",
                        " SABLE_AREA_GROUP + SABLE_DEPTH_GROUP as combo ",
                        " from (select YEAR, SABLEFISH_SURVEY_IND, SABLE_AREA_GROUP, ",
                        " SABLE_DEPTH_GROUP, SPECIMEN_ID, SPECIMEN_SEX_CODE, ",
                        " case WHEN Fork_Length <= 550 THEN 1.0 ELSE 0.0 END as subl, ",
                        " case WHEN Fork_Length > 550 THEN 1.0 ELSE 0.0 END as leg ",
                        " from dbo.GFBIO_SABLEBIO_VW ",
                        " where (SABLEFISH_SURVEY_IND = 1) AND ",
                        " (SABLE_AREA_GROUP IN (N's1', N's2', N's3', N's4', N's5'))) as LS ",
                        " group by SABLE_AREA_GROUP, SABLE_DEPTH_GROUP, YEAR) as LS1 ",
                        " where (round(countSub / total * 100, 1) > 50)  ",
                        " group by YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP ",
                        " order by YEAR, SABLE_AREA_GROUP, SABLE_DEPTH_GROUP")

   #polar        <- GetSQLData(sqlpolar ,"Sablefish")     # read from SQL Server
   #polarsummary <- GetSQLData(polarsumm ,"Sablefish")   # view the results to be able to type into the summary
   #write.table(polar,        file = paste(path,"figure16a.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   #write.table(polarsummary, file = paste(path,"figure16b.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")
   
   polar        <-  read.csv(paste(path,'figure16a.csv', sep=''),header=T)        # read from csv
   polarsummary <-  read.csv(paste(path,'figure16b.csv', sep=''),header=T)
   polar$cat    <-  ifelse(polar$subL>=50,">50%","<50%")  # identify sublegal counts below and above 50 %
   
   linea<-25.0
   lineb<-50.0
   linec<-75.0
  
   sublabel    <- (c("S1S","S1M","S1D",
                     "S2S","S2M","S3D",
                     "S3S","S3M","S3D",
                     "S4S","S4M","S4D",
                     "S5S","S5M","S5D"))
 
    polar.dat  <-  polar[polar$YEAR>=2014,]
    ggplot(polar.dat, aes(polarorder, subL, fill = cat)) + 
           geom_bar(stat = "identity") + 
           theme_minimal() +
           scale_fill_manual(values=c("gray50","steelblue")) +  
           xlab('') +
           ylab('') + 
           theme(axis.text.y=element_blank()) +
           theme(legend.title = element_blank())        + 
           theme(axis.text.x = element_text(size = 7))  +
           coord_polar(start=-48/360) +   # where to start the polar bars
           scale_x_continuous(limits=c(-0.5,14.5), breaks=0:14,  labels= sublabel) +
           geom_hline(aes(yintercept=linea), colour="red", linetype="dashed",size = 0.5) +  
           geom_hline(aes(yintercept=lineb), colour="red", linetype="dashed",size = 0.5) +
           geom_hline(aes(yintercept=linec), colour="red", linetype="dashed",size = 0.5) +
           geom_text(data=polar.dat, aes( x=0, y=25, label='25'), color="black",   size=4  ) +
           geom_text(data=polar.dat, aes( x=0, y=50, label='50'), color="black",   size=4  ) +
           geom_text(data=polar.dat, aes( x=0, y=75, label='75'), color="black",   size=4  ) +
           facet_wrap(~YEAR, nrow=3, ncol=3) +
                      theme(strip.text.x = element_text(size=12))

  while (!is.null(dev.list()))  dev.off()  
    img <-   paste(basepath,'figures/figure16.png',sep='')   # retrieve png from figures folder
             knitr::include_graphics(img)
```
\clearpage


(ref:figure17) Bubble plot for female (A) and male (B) sablefish ages by survey year from StRS sets that have been aged.  The sizes of the circles are proportional to the number of fish with given ages. Fish age 35 and older are included in one bubble. The total number(n) of fish aged are listed across the top of each panel. The ages with the highest ratios are posted to the right of each bubble.

```{r figure17, fig.cap='(ref:figure17)',results='asis', out.width = "500px",out.height = "577px", fig.align="center"}

   # dt  <-  ("exec procRReport_Survey_proportions_at_age")  run this procedure to create table first.
   # sql server procedure:  procRReport_Survey_proportions_at_age which pulls age data from 
   # GFBIOSQL.dbo.b21_samples and b22_specimens

   png(paste(basepath,'figures/figure17.png',sep=''), width = 800, height = 924)  # -- starts writing a png to figure folder

   dt   <-  paste("select * from Report_Survey_GFBIO_Age_MF_Prop where SetType='StRS' and Year<=", yr, sep="")
   #dat  <-  GetSQLData(dt,"Sablefish")                                                            # read from SQL Server
   #write.table(dat, file = paste(path,'figure17.csv',sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")   
   dat  <-  read.csv(paste(path,'figure17.csv',sep=''),header=T) # read from csv

   par(mfrow=c(2,1),cex=1.1)     # -- two vertical plots
   par(xpd=NA)
   
   involve  <-  c()
   involve  <-  unique(dat$Year)
   maxyr    <-  max(involve)
   minyr    <-  min(involve)

   #  plot bubbles for female ages
   plot(dat$Year, dat$Age, type="n",
        xlab=" Year", ylab="", main="Females", 
        ylim=c(0,42), xlim=c(minyr,maxyr),xaxt="n")
        axis(1, seq(2003,2018,1))            
        symbols(dat$Year, dat$Age, 
                circles=pi*(dat$Female_Proportion),
                inches=0.3, add=T,col="light grey")

   for (femaleyr in involve)  # display totals across top
    {
    h <- unique(dat$Female_Yr_Total[dat$Year==femaleyr])
    text(femaleyr + 0.15, 40, bquote(.(h)))   
    text(femaleyr + 0.15, dat$Age[dat$f==1 & dat$Year==femaleyr],
         dat$Age[dat$f==1 & dat$Year==femaleyr],
         col="red",cex=1.1, font=2)
    }

    mtext(paste("Age","",sep=""), SOUTH<-2,  
          line=-1, adj=0.5, cex=1.2,  outer=TRUE)  # outside label
    
    di <- dev.size("in")
    x  <- grconvertX(c(0, di[1]), from="in", to="user")
    y  <- grconvertY(c(0, di[2]), from="in", to="user")
    fig <- par("fig")
    x <- x[1] + (x[2] - x[1]) * fig[1:2]
    y <- y[1] + (y[2] - y[1]) * fig[3:4]
    txt <- "A"   # label A
    x <- x[1] + strwidth(txt, cex=3) / 2
    y <- y[2] - strheight(txt, cex=3) / 2
    text(x, y, txt, cex=1.5)
    
       # plot bubbles for male ages
   plot(dat$Year, dat$Age, type="n", 
        xlab=" Year", ylab="", main="Males", 
        ylim=c(0,42), xlim=c(minyr,maxyr),
        xaxt="n")
        axis(1, seq(2003,2018,1))      
        symbols(dat$Year, dat$Age, 
                circles=pi*(dat$Male_Proportion),
                inches=0.3, add=T, col="light grey")

   for (maleyr in involve){
        h  <-  unique(dat$Male_Yr_Total[dat$Year==maleyr])
        text(maleyr + 0.15, 40, bquote(.(h)))    
        text(maleyr + 0.35, dat$Age[dat$m==1 & dat$Year==maleyr],
             dat$Age[dat$m==1 & dat$Year==maleyr],
             col="red",cex=1.1, font=2)}
   
        di <- dev.size("in")
        x  <- grconvertX(c(0, di[1]), from="in", to="user")
        y  <- grconvertY(c(0, di[2]), from="in", to="user")
        fig <- par("fig")
        x <- x[1] + (x[2] - x[1]) * fig[1:2]
        y <- y[1] + (y[2] - y[1]) * fig[3:4]
        txt <- "B"  # label B
        x <- x[1] + strwidth(txt, cex=3) / 2
        y <- y[2] - strheight(txt, cex=3) * 2
        text(x, y, txt, cex=1.5)
   
    while (!is.null(dev.list()))  dev.off()  
    img <-   paste(basepath,'figures/figure17.png',sep='')   # retrieve png 
             knitr::include_graphics(img)
```
\clearpage
(ref:figure18) Coplot of average depth (m) vs average temperature ($^\circ$C) for a given 1-degree latitude range (blue bands) for `r yr`.  The number of fishing sets deployed with a SBE 39 recorder are represented by n.

```{r figure18, fig.cap='(ref:figure18)',results='asis', out.width = "500px",out.height = "335px", fig.align="center"}

      png(paste(basepath,'figures/figure18.png',sep=''), width=920, height=424) # write png to file
      # table SEABIRD_ReportCoplot created in the Sablefish.dbo.Build_Seabird_tables procedure
      sbecp     <- paste("select * from SEABIRD_ReportCoplot where Year in(",yr,")",sep="")
      #ctddat    <- GetSQLData(sbecp,"Sablefish")   # read from SQL Server
      #write.table(ctddat, file = paste(path,"figure18.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",")      
      ctddat    <- read.csv(paste(path,'figure18.csv',sep=''),header=T)  # read from csv

      par(mar=c(1,1,1,1.4),cex=1.5,cex.lab=1.5, cex.axis=1.5, cex.main=1.5, cex.sub=1.5)   # par(mar=c(bottom,left,top,right) 
      yrdat     <-  ctddat[ctddat$Year==yr,]
      given.lat <-  matrix(c(48,48,49,49,50,50,51,51,52,52,53,53,54,54), 
                           nrow = 7, ncol=2, byrow=TRUE)
      
      coplot(temperature  ~ depth| lat, data = yrdat, 
             pch = 21, bg = "lightblue", col = "#0073C2FF",
             xlim=c(200,1400), 
             ylim=c(2,10),
             given.v = given.lat,
             show.given=FALSE, rows=1, cex=3.0, 
             xlab=c("Average Depth (m)",""),  
             ylab= expression(Average~Temperature~degree~C))

             n48 <- length(unique(yrdat$Sets[yrdat$lat == 48]))  # count number of sets in lat band
             n49 <- length(unique(yrdat$Sets[yrdat$lat == 49]))
             n50 <- length(unique(yrdat$Sets[yrdat$lat == 50]))
             n51 <- length(unique(yrdat$Sets[yrdat$lat == 51]))
             n52 <- length(unique(yrdat$Sets[yrdat$lat == 52]))
             n53 <- length(unique(yrdat$Sets[yrdat$lat == 53]))
             n54 <- length(unique(yrdat$Sets[yrdat$lat == 54]))

      labels   <-   c(n48,n49,n50,n51,n52,n53,n54)
      for(j in 1:7) 
         { text((280*j)-(100*(j-1)),8,paste("n=",labels[j],sep=""))  } 
      
      text(1350, 9, yr, font=2)  # make year bold = 2
      while (!is.null(dev.list()))  dev.off()

      require('magick')   # in order to stack images
      uno <- image_read(paste(basepath,'figures/CoPlotTopMain.png', sep='')) # Read external images
      one <- image_read(paste(basepath,'figures/figure18.png', sep=''))
      imgs = c(uno, one)
     
      # concatenate pngs left-to-right (use 'stack=T' to do it top-to-bottom)
      side_by_side = image_append(imgs, stack=T)
      image_write(side_by_side, path = paste(basepath,'figures/figure18.png',sep=''), format = "png")  # save png

      img <-   paste(basepath,'figures/figure18.png',sep='')   # retrieve png 
               knitr::include_graphics(img)

```
\clearpage

(ref:figure19) Vertical density ridgeplots of mean temperatures per year as reported by set from the Sea-bird SBE 39 loggers on traps at three depth intervals, RD~1~ = shallow (100-450 m), RD~2~ = mid (450-850 m), RD~3~ = deep (850-1400 m). Lines indicate the 2.5% and 97.5% tails.

```{r figure19, fig.cap='(ref:figure19)', results='asis', out.width = "480px",out.height = "616px", fig.align = "center"}

      # table SEABIRD_ReportLinePlot created  by Sablefish.dbo.Build_Seabird_tables procedure
    
      png(paste(basepath,'figures/figure19.png',sep=''), width=600, height=770) # write png to file
      sea.bird     <-  "select * from SEABIRD_AverageTempPerSet where depth_stratum in('RD1','RD2','RD3')"
      #sea.bird.ridge    <-  GetSQLData(sea.bird,"Sablefish")   # read from SQL Server
      #write.table(sea.bird.ridge, file = paste(path,"figure19.csv",sep=''),row.names=FALSE, na="",col.names=TRUE,  sep=",") 
      sea.bird.ridge    <-  read.csv(paste(path,'figure19.csv',sep=''),header=T)  # read from csv
      weather.raw2 <-    sea.bird.ridge[order(- sea.bird.ridge$Year,  sea.bird.ridge$Sets),]
      weather.raw2$years<-factor(weather.raw2$Year,levels=rev(unique(weather.raw2$Year)))
      names(weather.raw2) <- c("Year", "trip", "Sets", "Avgtemp", "Mintemp","Maxtemp", "Depth Stratum",  "lat", "years") 
      
      library(ggridges)
      
      #Median temperatures by year
      ggplot(weather.raw2, aes(x = Avgtemp, y = years, fill=`Depth Stratum`, alpha = 0.4)) +
             scale_x_continuous(limits = c(1.5,8.5)) +
             #facet_wrap(~depth_stratum) +
             #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.9) +
           geom_density_ridges(
                aes(point_shape = `Depth Stratum`, alpha = .7), 
                alpha = .9, point_alpha = .3, jittered_points = TRUE
                ) +

            xlab("Mean Temperature C") +
             ylab("Year") +
             theme_bw()
       
       while (!is.null(dev.list()))  dev.off()
       img <-   paste(basepath,'figures/figure19.png',sep='')   # retrieve png 
                knitr::include_graphics(img)

```
\clearpage


